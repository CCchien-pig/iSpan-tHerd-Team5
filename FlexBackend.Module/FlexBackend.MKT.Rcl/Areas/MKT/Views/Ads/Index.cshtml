@{
    ViewData["Title"] = "廣告管理";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

<div class="container my-4">
    <h2>@ViewData["Title"]</h2>
    <button id="btnAddAd" class="btn btn-success mb-3">新增廣告</button>
    <div id="calendar"></div>
</div>

<!-- Modal 容器 -->
<div id="adModalContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
    $(document).ready(function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/MKT/Ads/GetAdsEvents',
            eventClick: function (info) {
                var id = info.event.id;
                $.get('/MKT/Ads/Edit/' + id, function (html) {
                    $('#adModalContainer').html(html);
                    $('#adModal').modal('show');

                    bindAdFormSubmit(calendar); // 綁定表單提交事件
                });
            }
        });

        calendar.render();

        // 新增按鈕
        $('#btnAddAd').click(function () {
            $.get('/MKT/Ads/Create', function (html) {
                $('#adModalContainer').html(html);
                $('#adModal').modal('show');

                bindAdFormSubmit(calendar); // 綁定表單提交事件
            });
        });

        // 表單提交處理函式
        function bindAdFormSubmit(calendar) {
            $('#adForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                var form = $(this);
                var actionUrl = form.find('input[name="AdId"]').val() ? '/MKT/Ads/Edit' : '/MKT/Ads/Create';

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            $('#adModal').modal('hide');
                            calendar.refetchEvents(); // 重新抓事件更新 FullCalendar
                        } else {
                            alert('操作失敗');
                        }
                    },
                    error: function () {
                        alert('系統錯誤');
                    }
                });
            });
        }
    });
</script>
