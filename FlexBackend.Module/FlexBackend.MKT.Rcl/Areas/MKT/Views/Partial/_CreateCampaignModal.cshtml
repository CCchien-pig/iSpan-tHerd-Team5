@* 新增活動 Modal *@
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="createCampaignForm" method="post" action="/MKT/Campaigns/CreateCampaign">
                <div class="modal-header">
                    <h5 class="modal-title">新增活動</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>標題</label>
                        <input type="text" name="CampaignName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label>活動類型</label>
                        <select id="createType" name="CampaignType" class="form-select">
                            <option value="cad" selected>全館折扣</option>
                        </select>
                    </div>




                    <div class="mb-3">
                        <label>活動描述</label>
                        <input type="text" name="CampaignDescription" class="form-control" />
                    </div>

                    <div class="mb-3" style="display:none;">
                        <label>適用商品類型</label><br />
                        <input type="checkbox" name="ProductType" value="eyes" />眼睛保健
                        <input type="checkbox" name="ProductType" value="skin" />皮膚護理
                        <input type="checkbox" name="ProductType" value="hair" />頭髮護理
                        <input type="checkbox" name="ProductType" value="face" />臉部護理
                    </div>
                    <!-- 隱藏欄位傳空值 -->
                    <input type="hidden" name="ProductType" value="" />


                    <div class="mb-3">
                        <label>活動開始日期</label>
                        <input type="date" name="StartDate" class="form-control" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="mb-3">
                        <label>活動結束日期</label>
                        <input type="date" name="EndDate" class="form-control" min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="createIsActive" name="IsActive" checked />
                            <label class="form-check-label" for="createIsActive">啟用</label>
                        </div>
                    </div>


                    @* <div class="mb-3">
                        <label>活動狀態</label>
                        <select id="createStatus" name="Status" class="form-select">
                            <option value="cInactive">下架</option>
                            <option value="cActive">上架</option>
                        </select>
                    </div> *@
                    <!-- 隱藏狀態欄位，固定回傳 cActive -->
                    <input type="hidden" id="createStatus" name="Status" value="cActive" />


                    <div class="mb-3">
                        <label>建檔人員</label>
                        <input type="text" name="Creator" class="form-control" required />
                    </div>

                    <div class="mb-3" style="display:none">
                        <label>活動圖片Id</label>
                        <input type="text" name="ImgId" class="form-control" />
                    </div>
                    <input type="hidden" name="ImgId" class="form-control" value="null" />

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" id="createSubmitBtn" class="btn btn-primary">確認新增</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    const statusSelect = document.querySelector("#createCampaignForm select[name='Status']");
    const isActiveCheckbox = document.getElementById('createIsActive');

    // 初始檢查
    checkStatus();

    // 當狀態改變時
    statusSelect.addEventListener('change', checkStatus);

    function checkStatus() {
        if (statusSelect.value === 'cInactive') {
            isActiveCheckbox.checked = false;       // 取消勾選
            isActiveCheckbox.disabled = true;       // 禁用勾選
        } else {
            isActiveCheckbox.disabled = false;      // 可勾選
        }
    }

    // 新增活動 AJAX
    $("#createSubmitBtn").on("click", function(e) {
        e.preventDefault();

        var startDate = $("#createCampaignForm input[name='StartDate']").val();
        var endDate = $("#createCampaignForm input[name='EndDate']").val() || null;

        if (!startDate) {
            Swal.fire("錯誤", "請輸入開始日期", "error");
            return;
        }

        if (endDate && new Date(endDate) < new Date(startDate)) {
            Swal.fire("錯誤", "結束日期必須在開始日期之後", "error");
            return;
        }

        var data = {
            CampaignName: $("#createCampaignForm input[name='CampaignName']").val(),
            CampaignType: $("#createType").val(), // 固定 cmd
            CampaignDescription: $("#createCampaignForm input[name='CampaignDescription']").val(),
            ProductType: $("#createCampaignForm input[name='ProductType']:checked").map(function(){ return this.value; }).get().join(","),
            StartDate: startDate,
            EndDate: endDate,
            // 若下架，強制 IsActive = false
            IsActive: statusSelect.value === 'cInactive' ? false : $("#createIsActive").prop("checked"),
            Status: statusSelect.value,
            Creator: parseInt($("#createCampaignForm input[name='Creator']").val()) || null,
            ImgId: parseInt($("#createCampaignForm input[name='ImgId']").val()) || null
        };

        $.ajax({
            url: '/MKT/Campaigns/CreateCampaign',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(res) {
                if (res.success) {
                    Swal.fire("成功","活動已新增！","success").then(() => {
                        $("#createCampaignModal").modal("hide");
                        location.reload(); // 或重新抓 events
                    });
                } else {
                    Swal.fire("錯誤","操作失敗：" + res.message,"error");
                }
            },
            error: function(xhr) {
                Swal.fire("錯誤","操作失敗：" + xhr.responseText,"error");
            }
        });
    });
</script>