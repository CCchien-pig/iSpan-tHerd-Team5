<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editForm" method="post" action="/MKT/Campaigns/EditCampaign">
                <div class="modal-header text-center">
                    <h5 class="modal-title">編輯活動</h5>
                </div>
                <div class="modal-body">
                    
                        <label class="form-label">活動Id</label>
                        <input type="text" id="editId" class="form-control" disabled />
                    

                    <div class="mb-3">
                        <label>標題</label>
                        <input type="text" id="editTitle" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label>活動類型</label>
                        <select id="editType" name="CampaignType" class="form-select">
                            <option value="cmd" selected>滿額折扣</option>
                        </select>
                    </div>




                    <div class="mb-3">
                        <label>活動描述</label>
                        <input type="text" id="editDescription" class="form-control" />
                    </div>

                    <div class="mb-3" style="display:none;">
                        <label>適用商品類型</label><br />
                        <input type="checkbox" class="editProductType" value="eyes" />眼睛保健
                        <input type="checkbox" class="editProductType" value="skin" />皮膚護理
                        <input type="checkbox" class="editProductType" value="hair" />頭髮護理
                        <input type="checkbox" class="editProductType" value="face" />臉部護理
                    </div>
                    <input type="hidden" class="editProductType" value="" />


                    <div class="mb-3">
                        <label>活動開始日期</label>
                        <input type="date" id="editStart" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label>活動結束日期</label>
                        <input type="date" id="editEnd" class="form-control"  />
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="editIsActive"
                                   @(Model?.IsActive == true ? "checked" : "") />
                            <label class="form-check-label" for="editIsActive">啟用</label>
                        </div>
                    </div>


                    @* <div class="mb-3">
                        <label>活動狀態</label>
                        <select id="editStatus" class="form-select">
                            <option value="cActive">上架</option>
                            <option value="cInactive">下架</option>
                        </select>
                    </div> *@
                    <input type="hidden" id="editStatus" name="Status" value="cActive" />


                    <div class="mb-3">
                        <label>建檔人員</label>
                        <input type="text" id="editCreator" class="form-control" />
                    </div>

                    <div class="mb-3" style="display:none;">
                        <input type="text" id="editImgIdVisible" class="form-control" />
                    </div>
                    <input type="hidden" id="editImgId" name="ImgId" value="" />




                </div>
                <div class="modal-footer">
                    <button type="button" id="saveBtn" class="btn btn-primary">儲存</button>
                    <button type="button" id="deleteBtn" class="btn btn-danger">刪除</button>
                    <button type="button" id="backBtn" class="btn btn-secondary">返回</button>
                </div>

            </form>
        </div>
    </div>
</div>
<script>
    const editStatusSelect = document.getElementById('editStatus');
    const editIsActiveCheckbox = document.getElementById('editIsActive');

    // 初始檢查
    checkEditStatus();

    // 當狀態改變時
    editStatusSelect.addEventListener('change', checkEditStatus);

    function checkEditStatus() {
        if (editStatusSelect.value === 'cInactive') {
            editIsActiveCheckbox.checked = false;       // 取消勾選
            editIsActiveCheckbox.disabled = true;       // 禁用勾選
        } else {
            editIsActiveCheckbox.disabled = false;      // 可勾選
        }
    }

    // 提交編輯活動
    $("#saveBtn").on("click", function(e) {
        e.preventDefault();

        var data = {
            CampaignId: parseInt($("#editId").val()),
            CampaignName: $("#editTitle").val(),
            CampaignType: $("#editType").val(), // 固定 cmd
            CampaignDescription: $("#editDescription").val(),
            ProductType: $(".editProductType:checked").map(function(){ return this.value; }).get().join(","),
            StartDate: $("#editStart").val() || null,
            EndDate: $("#editEnd").val() || null,
            // 若下架，強制 IsActive = false
            IsActive: editStatusSelect.value === 'cInactive' ? false : $("#editIsActive").prop("checked"),
            Status: editStatusSelect.value,
            Creator: parseInt($("#editCreator").val()) || null,
            ImgId: parseInt($("#editImgId").val()) || null
        };

        $.ajax({
            url: '/MKT/Campaigns/UpdateCampaign',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(res){
                if(res.success){
                    Swal.fire("成功","活動已更新！","success").then(() => {
                        $("#editModal").modal("hide");
                        location.reload(); // 或 calendar.refetchEvents()
                    });
                } else {
                    Swal.fire("錯誤","操作失敗：" + res.message,"error");
                }
            },
            error: function(xhr){
                Swal.fire("錯誤","操作失敗：" + xhr.responseText,"error");
            }
        });
    });
</script>