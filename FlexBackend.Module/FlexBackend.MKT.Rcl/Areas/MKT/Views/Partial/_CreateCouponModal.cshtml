@model FlexBackend.Infra.Models.MktCoupon
<div class="modal fade" id="createCouponModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="createCouponForm">
                <div class="modal-header">
                    <h5 class="modal-title">新增優惠券</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 活動ID 下拉選單 -->
                    <div class="mb-3">
                        <label class="form-label">活動</label>
                        <select name="CampaignId" id="createCampaignId" class="form-select" required>
                            <option value="">請選擇活動</option>
                            @foreach (var c in ViewBag.Campaigns)
                            {
                                var start = c.StartDate.ToString("MM/dd");
                                var end = c.EndDate?.ToString("MM/dd") ?? "";
                                <option value="@c.CampaignId"
                                        data-start="@c.StartDate.ToString("yyyy-MM-ddTHH:mm")"
                                        data-end="@(c.EndDate?.ToString("yyyy-MM-ddTHH:mm") ?? "")">
                                    @c.CampaignName (@start ~ @end)
                                </option>
                            }
                        </select>
                    </div>

                    <!-- 規則下拉選單 -->
                    <div class="mb-3">
                        <label for="createRuleId" class="form-label">規則條件</label>
                        <select id="createRuleId" name="RuleId" class="form-select" required>
                            <option value="">請選擇規則</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">優惠券名稱</label>
                        <input type="text" id="createCouponName" name="CouponName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">優惠碼</label>
                        <input type="text" id="createCouponCode" name="CouponCode" class="form-control" required />
                    </div>

                    <!-- 隱藏優惠券狀態欄位，固定回傳 pActive -->
                    <div class="mb-3" style="display:none;">
                        <label class="form-label">優惠券狀態</label>
                        <input type="hidden" id="createStatus" name="Status" value="pActive" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">開始時間</label>
                        <input type="datetime-local" id="createStartDate" name="StartDate" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">結束時間</label>
                        <input type="datetime-local" id="createEndDate" name="EndDate" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">折扣金額</label>
                        <input type="number" id="createDiscountAmount" name="DiscountAmount" class="form-control" step="0.01" />
                    </div>

                    <div class="mb-3 d-none">
                        <label class="form-label">折扣百分比</label>
                        <input type="number" id="createDiscountPercent" name="DiscountPercent" class="form-control" step="0.01" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">總數量</label>
                        <input type="number" id="createTotQty" name="TotQty" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">每人限領</label>
                        <input type="number" id="createUserLimit" name="UserLimit" class="form-control" required />
                    </div>

                    <!-- 隱藏輸入欄位，固定回傳24 -->
                    <div class="mb-3" style="display:none;">
                        <label class="form-label">有效時數</label>
                        <input type="hidden" id="createValidHours" name="ValidHours" value="24" />
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input type="checkbox" id="createIsActive" name="IsActive" class="form-check-input" checked />
                        <label class="form-check-label" for="createIsActive">啟用</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">建立者</label>
                        <input type="number" id="createCreator" name="Creator" class="form-control" required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" id="createCouponSubmitBtn" class="btn btn-primary">新增</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 打開 modal 時載入規則
    function loadActiveRules() {
        $.get('/MKT/Coupons/GetActiveRules', function (rules) {
            var $ruleSelect = $("#createRuleId");
            $ruleSelect.empty().append('<option value="">請選擇規則</option>');
            rules.forEach(function (r) {
                $ruleSelect.append('<option value="' + r.RuleId + '">' + r.DefaultCondition + '</option>');
            });
        }).fail(function (err) {
            console.error("載入規則失敗", err);
        });
    }

    $("#CreateCoupon").off("click").on("click", function () {
        loadActiveRules();
        $("#createCouponModal").modal("show");
    });

    // 新增優惠券
    $("#createCouponSubmitBtn").off('click').on('click', function (e) {
        e.preventDefault();
        var form = $("#createCouponForm");
        var data = {
            CampaignId: parseInt(form.find("#createCampaignId").val()),
            RuleId: parseInt(form.find("#createRuleId").val()),
            CouponName: form.find("#createCouponName").val().trim(),
            CouponCode: form.find("#createCouponCode").val().trim(),  // ✅ PascalCase
            Status: form.find("#createStatus").val(),
            StartDate: form.find("#createStartDate").val(),
            EndDate: form.find("#createEndDate").val() || null,
            DiscountAmount: parseFloat(form.find("#createDiscountAmount").val()) || null,
            DiscountPercent: parseFloat(form.find("#createDiscountPercent").val()) || null,
            TotQty: parseInt(form.find("#createTotQty").val()),
            LeftQty: parseInt(form.find("#createTotQty").val()),
            UserLimit: parseInt(form.find("#createUserLimit").val()),
            ValidHours: parseInt(form.find("#createValidHours").val()),
            IsActive: form.find("#createIsActive").is(":checked"),
            Creator: parseInt(form.find("#createCreator").val())
        };

        // 前端檢查
        if (!data.CampaignId) return Swal.fire("錯誤", "請選擇活動", "error");
        if (!data.RuleId) return Swal.fire("錯誤", "請選擇優惠規則", "error");
        if (!data.CouponName || !data.CouponCode) return Swal.fire("錯誤", "優惠券名稱與代碼必填", "error");

        $.ajax({
            url: '@Url.Action("CreateCoupon", "Coupons", new { area = "MKT" })',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                if (res.success) {
                    Swal.fire("成功", "優惠券已新增！", "success").then(() => {
                        $("#createCouponModal").modal("hide");
                        form[0].reset();
                        if (window.calendar) window.calendar.refetchEvents();
                    });
                } else {
                    Swal.fire("錯誤", "新增失敗：" + res.message, "error");
                }
            },
            error: function (err) {
                console.error(err);
                Swal.fire("錯誤", "新增失敗", "error");
            }
        });
    });
</script>
