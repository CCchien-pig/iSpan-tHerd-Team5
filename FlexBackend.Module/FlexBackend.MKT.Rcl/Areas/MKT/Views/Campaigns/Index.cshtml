<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* 日曆外框 */
    #calendar {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 15px;
        margin-top: 15px;
    }

    /* 標題 */
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4a148c;
    }

    /* 統一紫色按鈕 */
    .btn, .fc-button {
        background-color: #6a1b9a !important;
        border: none !important;
        color: #fff !important;
        border-radius: 8px !important;
        transition: all 0.2s ease-in-out;
    }

        .btn:hover, .fc-button:hover {
            background-color: #8e24aa !important;
        }

    /* 左右箭頭圓形化 */
    .fc-prev-button, .fc-next-button {
        border-radius: 50% !important;
        width: 36px !important;
        height: 36px !important;
        padding: 0 !important;
    }

    /* 今日日期高亮 */
    .fc-day-today {
        background-color: rgba(156, 39, 176, 0.15) !important;
        border: 2px solid #8e24aa !important;
    }

    /* 事件卡片（顏色由後端 color 屬性決定） */
    .fc-event {
        border-radius: 8px;
        padding: 2px 6px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: transform 0.15s ease-in-out;
    }

        .fc-event:hover {
            transform: scale(1.05);
        }

    /* 活動總數 */
    #campaignCount {
        font-size: 1.2rem;
        font-weight: bold;
        color: #6a1b9a;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(106,27,154,0.1);
    }

    /* 日期選擇器 */
    #jumpToDate {
        border-radius: 8px;
        border: 1px solid #6a1b9a;
        padding: 4px 8px;
    }

        #jumpToDate:focus {
            outline: none;
            border-color: #8e24aa;
            box-shadow: 0 0 4px rgba(142,36,170,0.6);
        }

    /* 浮動按鈕樣式 */
    #goTodayBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #6a1b9a;
        border: none;
        border-radius: 50%;
        color: #fff;
        z-index: 9999;
        transition: all 0.2s ease-in-out;
    }

        #goTodayBtn:hover {
            background-color: #8e24aa;
            transform: scale(1.1);
        }

    /* 週六 (六) */
    .fc-day-sat {
        background-color: rgba(106, 27, 154, 0.05); /* 淡紫色 */
    }

    /* 週日 (日) */
    .fc-day-sun {
        background-color: rgba(106, 27, 154, 0.1); /* 深一點紫色 */
    }
</style>

<div class="container my-4">
    <h2>@ViewData["Title"]</h2>
    <button id="openCreateCampaign" class="btn mb-3">
        新增活動
    </button>
    <input type="date" id="jumpToDate" class="form-control d-inline-block w-auto ms-2 mb-3" />
    <span class="ms-2">活動總數 :</span>
    <span id="campaignCount" class="text-dark">0</span>
    <div id="calendar"></div>
</div>

<!-- 浮動回到今天按鈕 -->
<button id="goTodayBtn" class="btn shadow">
    <i class="bi bi-calendar-event"></i>
</button>

<!-- Modals -->
@Html.Partial("~/Areas/MKT/Views/Partial/_EditModal.cshtml")
@Html.Partial("~/Areas/MKT/Views/Partial/_CreateCampaignModal.cshtml")

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-tw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            themeSystem: 'bootstrap5',
            events: '/MKT/Campaigns/GetEvents', // 後端回傳需包含 color 屬性
            displayEventTime: false,
            height: 700,
            locale: 'zh-tw',
            aspectRatio: 1.5,
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                month: '月',
                week: '週',
                day: '日'
            },
            eventDisplay: 'block',
            eventMouseEnter: function (info) {
                $(info.el).tooltip({
                    title: info.event.title,
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                }).tooltip('show');
            },
            eventMouseLeave: function (info) {
                $(info.el).tooltip('dispose');
            },
            eventClick: function (info) {
                var eventId = info.event.id;
                fetch(`/MKT/Campaigns/GetEventById/${eventId}`)
                    .then(response => response.json())
                    .then(data => {
                        $("#editId").val(data.id);
                        $("#editTitle").val(data.title);
                        $("#editTypeDisplay").val(data.type === "cmd" ? "滿額折扣" : "全館折扣");
                        $("#editType").val(data.type);
                        $("#editDescription").val(data.description);
                        $("#editStart").val(data.startDate?.split('T')[0] || '');
                        $("#editEnd").val(data.endDate?.split('T')[0] || '');
                        $("#editStatus").val(data.status);
                        $("#editCreator").val(data.creator);
                        $("#editImgId").val(data.imgId || '');
                        $(".editProductType").prop("checked", false);
                        if (data.productType) {
                            data.productType.split(',').forEach(pt => {
                                $(".editProductType[value='" + pt + "']").prop("checked", true);
                            });
                        }
                        $("#editIsActive").prop("checked", data.isActive);
                        $("#editModal").modal("show");
                    })
                    .catch(err => console.error(err));
            }
        });

        calendar.render();

        // 更新活動總數
        function updateCampaignCount() {
            $.get('/MKT/Campaigns/GetTotalCount', function (res) {
                $("#campaignCount").fadeOut(150, function () {
                    $(this).text(res.count || 0).fadeIn(150);
                });
            }).fail(function () { $("#campaignCount").text(0); });
        }
        updateCampaignCount();

        // 開啟新增 Modal
        $("#openCreateCampaign").on("click", function () {
            $("#createCampaignModal").modal("show");
        });

        // 🔹 日期選擇器跳轉
        $("#jumpToDate").on("change", function () {
            var selectedDate = this.value;
            if (selectedDate) {
                calendar.gotoDate(selectedDate);
            }
        });

        // 🔹 浮動按鈕：回到今天
        $("#goTodayBtn").on("click", function () {
            calendar.today();
        });

        // 🔹 CRUD (保持原邏輯不變)
        $("#createSubmitBtn").on("click", function (e) {
            e.preventDefault();
            var startDate = $("input[name='StartDate']").val();
            var creator = parseInt($("input[name='Creator']").val());
            var imgId = $("input[name='ImgId']").val();
            imgId = imgId ? parseInt(imgId) : null;

            if (!startDate || !creator) {
                Swal.fire("錯誤", "必填欄位未填寫", "error");
                return;
            }

            var status = $("select[name='Status']").val();
            var isActive = status === 'cInactive' ? false : $("#createIsActive").prop("checked");

            var data = {
                CampaignName: $("input[name='CampaignName']").val(),
                CampaignType: $("input[name='CampaignType']").val(),
                CampaignDescription: $("input[name='CampaignDescription']").val(),
                ProductType: $("input[name='ProductType']:checked").map(function () { return this.value; }).get().join(","),
                StartDate: startDate,
                EndDate: $("input[name='EndDate']").val() || null,
                IsActive: isActive,
                Status: status,
                Creator: creator,
                ImgId: imgId
            };

            $.ajax({
                url: '/MKT/Campaigns/CreateCampaign',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.success) {
                        Swal.fire("成功", "活動已新增！", "success").then(() => {
                            $("#createCampaignModal").modal("hide");
                            location.reload();
                        });
                    } else {
                        Swal.fire("錯誤", "操作失敗：" + res.message, "error");
                    }
                },
                error: function (xhr) {
                    Swal.fire("錯誤", "操作失敗：" + xhr.responseText, "error");
                }
            });
        });

        $("#saveBtn").on("click", function (e) {
            e.preventDefault();
            var data = {
                CampaignId: parseInt($("#editId").val()),
                CampaignName: $("#editTitle").val(),
                CampaignType: $("#editType").val(),
                CampaignDescription: $("#editDescription").val(),
                ProductType: $(".editProductType:checked").length > 0
                    ? $(".editProductType:checked").map(function () { return this.value; }).get().join(",")
                    : null,
                StartDate: $("#editStart").val() || null,
                EndDate: $("#editEnd").val() || null,
                IsActive: $("#editIsActive").is(":checked"),
                Status: $("#editStatus").val(),
                Creator: parseInt($("#editCreator").val()) || null,
                ImgId: parseInt($("#editImgId").val()) || null
            };

            $.ajax({
                url: '/MKT/Campaigns/UpdateCampaign',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.success) {
                        Swal.fire("成功", "活動已更新！", "success").then(() => {
                            calendar.refetchEvents();
                            $("#editModal").modal("hide");
                        });
                    } else {
                        Swal.fire("錯誤", "操作失敗：" + res.message, "error");
                    }
                },
                error: function (xhr) {
                    Swal.fire("錯誤", "操作失敗：" + xhr.responseText, "error");
                }
            });
        });

        $("#deleteBtn").on("click", function () {
            var campaignId = $("#editId").val();
            if (!campaignId) return;

            Swal.fire({
                title: '確定刪除活動？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '刪除',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/MKT/Campaigns/DeleteCampaign/' + campaignId,
                        type: 'POST',
                        success: function (res) {
                            if (res.success) {
                                Swal.fire('已刪除', '活動已刪除', 'success').then(() => {
                                    $("#editModal").modal("hide");
                                    calendar.refetchEvents();
                                    updateCampaignCount();
                                });
                            } else {
                                Swal.fire('錯誤', '刪除失敗：' + res.message, 'error');
                            }
                        },
                        error: function (xhr) { Swal.fire('錯誤', '刪除失敗：' + xhr.responseText, 'error'); }
                    });
                }
            });
        });

        $("#backBtn").on("click", function () {
            $("#editModal").modal("hide");
        });
    });
</script>
