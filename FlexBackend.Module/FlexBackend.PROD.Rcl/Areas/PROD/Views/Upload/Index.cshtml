@{
    ViewData["Title"] = "上傳圖片測試";
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Index" asp-controller="Upload" method="post" enctype="multipart/form-data">
    <!-- 拖拉區塊 -->
    <div id="dropArea" class="border border-2 border-primary rounded p-5 text-center mb-3 bg-light">
        <p class="mb-2">拖拉圖片到這裡，或點擊下方選擇檔案</p>
        <input type="file" id="fileInput" name="files" class="form-control d-none" multiple />
        <button type="button" id="selectBtn" class="btn btn-outline-primary">選擇圖片</button>
    </div>

    <!-- 預覽區 -->
    <div id="preview" class="row g-3 mb-3"></div>

    <button type="submit" class="btn btn-primary">上傳</button>
</form>

@if (ViewBag.Message != null)
{
    <div class="alert alert-info mt-3">@ViewBag.Message</div>
}

@if (ViewBag.ImageUrls != null)
{
    <div class="mt-3">
        @foreach (var url in (List<string>)ViewBag.ImageUrls)
        {
            <img src="@url" class="img-thumbnail me-2 mb-2" style="max-width:150px;" />
        }
    </div>
}

@section Scripts {
    <script>
        const dropArea = document.getElementById("dropArea");
        const fileInput = document.getElementById("fileInput");
        const selectBtn = document.getElementById("selectBtn");
        const preview = document.getElementById("preview");

        // 點擊按鈕開啟檔案選取
        selectBtn.addEventListener("click", () => fileInput.click());

        // 預覽圖片
        function showPreview(files) {
            preview.innerHTML = "";
            [...files].forEach(file => {
                if (!file.type.startsWith("image/")) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const col = document.createElement("div");
                    col.className = "col-3";
                    col.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" />`;
                    preview.appendChild(col);
                };
                reader.readAsDataURL(file);
            });
        }

        fileInput.addEventListener("change", () => showPreview(fileInput.files));

        // 拖拉事件處理
        ["dragenter", "dragover"].forEach(evt => {
            dropArea.addEventListener(evt, e => {
                e.preventDefault();
                dropArea.classList.add("bg-white");
            });
        });
        ["dragleave", "drop"].forEach(evt => {
            dropArea.addEventListener(evt, e => {
                e.preventDefault();
                dropArea.classList.remove("bg-white");
            });
        });
        dropArea.addEventListener("drop", e => {
            fileInput.files = e.dataTransfer.files;
            showPreview(fileInput.files);
        });
    </script>
}