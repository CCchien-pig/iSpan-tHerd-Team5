@* StockBatches Index *@
@{
    ViewData["Title"] = "庫存管理";
}

@section Styles {
    <link rel="stylesheet" href="~/_content/FlexBackend.SUP.Rcl/css/supstylesheet.css" />
}

<div class="d-flex justify-content-between mb-2">
    <h4>庫存管理</h4>
    <button id="createStockBatchBtn" class="btn btn-outline-success">新增庫存</button>
</div>

<div class="stockbatch-card">
    <table id="stockBatchTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th>品牌</th>
                <th>商品</th>
                <th>SKU</th>
                <th>庫存量</th>
                <th>異動類型</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal -->
<div id="stockBatchModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white container">
            <div class="modal-header">
                <h5 id="stockBatchModalTitle" class="modal-title">庫存</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div id="stockBatchModalContent" class="modal-body p-4">
                <!-- AJAX 載入 _StockBatchFormPartial -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // ===== URL =====
            var indexJsonUrl = '@Url.Action("IndexJson", "StockBatches", new { area = "SUP" })';
            var createUrl = '@Url.Action("Create", "StockBatches", new { area = "SUP" })';
            var editUrl = '@Url.Action("Edit", "StockBatches", new { area = "SUP" })';

            // ===== DataTable =====
            var table = $('#stockBatchTable').DataTable({
                serverSide: true,
                processing: true,
                ajax: { url: indexJsonUrl, type: 'POST', dataSrc: 'data' },
                columns: [
                    { data: 'brandName', title: '品牌' },
                    { data: 'productName', title: '商品' },
                    { data: 'skuCode', title: 'SKU' },
                    { data: 'stockQty', title: '庫存量', className: 'text-center' },
                    { data: 'movementType', title: '異動類型', className: 'text-center' },
                    { data: 'stockBatchId', title: '操作', orderable: false,
                        render: function(data){
                            return `<button class="btn btn-sm edit-btn" data-id="${data}"><i class="fa-regular fa-pen-to-square"></i> 編輯</button>`;
                        }
                    }
                ],
                language: { url: '//cdn.datatables.net/plug-ins/2.3.3/i18n/zh-HANT.json' },
                scrollY: "500px",
                scrollCollapse: true
            });

            // ===== initStockBatchForm 全域函數 =====
            window.initStockBatchForm = function(selectedBrandId=null, selectedProductId=null, selectedSkuId=null){
                var $brandSelect = $('#BrandSelect');
                var $productSelect = $('#ProductSelect');
                var $skuSelect = $('#SkuSelect');
                var $movementTypeSelect = $('#MovementTypeSelect');

                // 載入品牌
                $brandSelect.html('<option value="">請選品牌</option>');
                $.get('/SUP/StockBatches/GetBrands', function(brands){
                    brands.forEach(b => $brandSelect.append(`<option value="${b.BrandId}">${b.BrandName}</option>`));
                    if(selectedBrandId) $brandSelect.val(selectedBrandId).trigger('change');
                });

                // 載入異動類型
                $movementTypeSelect.html('<option value="">請選異動類型</option>');
                $.get('/SUP/StockBatches/GetMovementTypes', function(types){
                    types.forEach(m => $movementTypeSelect.append(`<option value="${m.value}">${m.text}</option>`));
                });

                // 品牌選商品
                $brandSelect.off('change').on('change', function(){
                    var brandId = $(this).val();
                    $productSelect.html('<option value="">請選商品</option>').prop('disabled', !brandId);
                    $skuSelect.html('<option value="">請選 SKU</option>').prop('disabled', true);

                    if(brandId){
                        $.get('/SUP/StockBatches/GetProductsByBrand',{brandId}, function(products){
                            products.forEach(p => $productSelect.append(`<option value="${p.productId}">${p.productName}</option>`));
                            if(selectedProductId) $productSelect.val(selectedProductId).trigger('change');
                        });
                    }
                });

                // 商品選 SKU
                $productSelect.off('change').on('change', function(){
                    var productId = $(this).val();
                    $skuSelect.html('<option value="">請選 SKU</option>').prop('disabled', !productId);

                    if(productId){
                        $.get('/SUP/StockBatches/GetSkusByProduct',{productId}, function(skus){
                            skus.forEach(sku => $skuSelect.append(`
                                <option value="${sku.skuId}"
                                    data-qty="${sku.stockQty}"
                                    data-reorder="${sku.reorderPoint}"
                                    data-safety="${sku.safetyStockQty}"
                                    data-max="${sku.maxStockQty}"
                                    data-issellable="${sku.isSellable}">
                                    ${sku.skuCode}
                                </option>
                            `));
                            if(selectedSkuId) $skuSelect.val(selectedSkuId).trigger('change');
                        });
                    }
                });

                // 選 SKU 更新庫存資訊
                $skuSelect.off('change').on('change', function(){
                    var selected = $(this).find(':selected');
                    $('#CurrentQty').text(selected.data('qty') || 0);
                    $('#ReorderPoint').text(selected.data('reorder') || 0);
                    $('#SafetyStockQty').text(selected.data('safety') || 0);
                    $('#MaxStockQty').text(selected.data('max') || 0);
                    $('#IsSellableText').text(selected.data('issellable') ? '可銷售' : '不可銷售');
                });

                // 異動類型切換手動加減
                $movementTypeSelect.off('change').on('change', function(){
                    $('#AdjustTypeDiv').toggle($(this).val()==='Adjust');
                });
            };

            // ===== 新增庫存 =====
            $('#createStockBatchBtn').on('click', function(){
                $.get(createUrl, function(html){
                    $('#stockBatchModalContent').html(html);
                    $('#stockBatchModalTitle').text("新增庫存");
                    $('#stockBatchModal').modal('show');

                    window.initStockBatchForm();
                });
            });

            // ===== 編輯庫存 =====
            $('#stockBatchTable').on('click', '.edit-btn', function(){
                var id = $(this).data('id');
                $.get(`${editUrl}/${id}`, function(html){
                    $('#stockBatchModalContent').html(html);
                    $('#stockBatchModalTitle').text("庫存量異動");
                    $('#stockBatchModal').modal('show');

                    window.initStockBatchForm();
                });
            });

            // ===== 表單提交 =====
            $('#stockBatchModalContent').on('submit','#stockBatchForm', function(e){
                e.preventDefault();
                var form = $(this);
                var dto = {
                    StockBatchId: $('#StockBatchId').val(),
                    SkuId: $('#SkuSelect').val(),
                    MovementType: $('#MovementTypeSelect').val(),
                    ChangeQty: parseInt($('#ChangeQtyInput').val())||0,
                    IsAdd: $('#AdjustTypeSelect').val()==='true',
                    IsSellable: $('#SkuSelect').find(':selected').data('issellable'),
                    Remark: $('textarea[name="Remark"]').val(),
                    UserId: 111111
                };

                $.ajax({
                    url: form.attr('action'),
                    type:'POST',
                    contentType:'application/json',
                    data: JSON.stringify(dto),
                    success: function(res){
                        if(res.success){
                            $('#stockBatchModal').modal('hide');
                            Swal.fire({position:'center',icon:'success',title:'操作成功',showConfirmButton:false,timer:1500});
                            table.ajax.reload(null,false);
                        } else {
                            Swal.fire('操作失敗', res.message || '', 'error');
                        }
                    },
                    error:function(){ Swal.fire('操作失敗','','error'); }
                });
            });

        });
    </script>
}