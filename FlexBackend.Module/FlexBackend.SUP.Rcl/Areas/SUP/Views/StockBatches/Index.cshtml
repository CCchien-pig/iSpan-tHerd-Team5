@* StockBatches Index *@
@{
    ViewData["Title"] = "庫存管理";
}

@section Styles {
    <link rel="stylesheet" href="~/_content/FlexBackend.SUP.Rcl/css/supstylesheet.css" />
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 id="tableTitle" class="mb-0">庫存紀錄</h5>
    <button id="btnToggleStock" class="btn btn-outline-primary">
        <span class="arrow"><i class="fa-solid fa-arrow-right"></i></span> 全站異動紀錄
    </button>
</div>

<!-- 初始化批號 -->
@* <button id="btnInitBatches" class="btn btn-primary">初始化批號</button>
<span id="initResult" style="margin-left:10px;"></span> *@

<!-- 主庫存表格*2區塊 (.stockbatch-card) -->
<div class="stockbatch-card">    
    <!-- 庫存紀錄 -->
    <div id="stockTableWrapper">
        <button id="createStockBatchBtn" class="btn btn-outline-success">庫存操作</button>
        <div class="legend">
            <span><span class="dot danger"></span> 危險（低於安全庫存）</span>
            <span><span class="dot low"></span> 須補貨（低於再訂購點）</span>
            <span><span class="dot normal"></span> 正常</span>
        </div>    
        <select id="stockExpireFilter" class="form-select form-select-sm mb-2">
            <option value="">全部</option>
            <option value="valid">未過期</option>
            <option value="expired">已過期</option>
        </select>
        <table id="stockBatchTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>批號</th>
                    <th>品牌</th>
                    <th>商品</th>
                    <th>到期日</th>
                    <th>批次庫存量</th>
                    <th>再訂購點</th>
                    <th>安全庫存</th>
                    <th>規格</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- 異動紀錄 -->   
    <div id="historyTableWrapper" style="display:none;">
        <select id="historyExpireFilter" class="form-select form-select-sm mb-2">
            <option value="">全部</option>
            <option value="valid">未過期</option>
            <option value="expired">已過期</option>
        </select>
        <table id="historyTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>批號</th>
                    <th>到期日</th>
                    <th>異動類型</th>
                    <th>異動前數量</th>
                    <th>異動數量</th>
                    <th>異動後數量</th>
                    <th>異動時間</th>
                    <th>異動人員</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- 庫存操作 Modal (#stockBatchModal)（模態視窗） -->
<div id="stockBatchModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white container">
            <!-- Header -->
            <div class="modal-header">
                <h5 id="stockBatchModalTitle" class="modal-title">庫存</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div id="stockBatchModalContent" class="modal-body p-4">
                <!-- AJAX 載入 _StockBatchFormPartial -->
            </div>
        </div>
    </div>
</div>

<!-- 批次異動明細 Modal (#batchMovementModal) -->
<div id="batchMovementModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white container p-3" style="background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px #40558c;">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="batchMovementTable" border="1" class="table table-bordered text-center" style="width:100%; margin: 0 auto; border-collapse: separate; border-spacing: 0 4px;table-layout:auto;">
                        <thead>
                            <tr>
                                <th>SKUCode</th>
                                <th>批號</th>
                                <th>變動類型</th>
                                <th>批次原庫存</th>
                                <th>異動數量</th>
                                <th>批次現庫存</th>
                                @* <th>預計庫存</th> *@
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // 初始化庫存操作表單事件
        function initStockBatchForm(selectedBrandId = null, selectedProductId = null, selectedSkuId = null, options = {}) {
            options = options || {};
            var isEdit = options.isEdit || false;

            var brandSelect = $('#BrandSelect');
            var productSelect = $('#ProductSelect');
            var skuSelect = $('#SkuSelect');
            var movementTypeSelect = $('#MovementTypeSelect');

            // 清空下拉
            brandSelect.empty().append('<option value="">請選品牌</option>');
            productSelect.empty().append('<option value="">請選商品</option>').prop('disabled', true);
            skuSelect.empty().append('<option value="">請選 SKU</option>').prop('disabled', true);
            movementTypeSelect.empty().append('<option value="">請選異動類型</option>');

            // 取得品牌列表
            $.get('/SUP/StockBatches/GetBrands', function(brands) {
                brands.forEach(b => {
                    brandSelect.append(`<option value="${b.brandId}" ${b.brandId == selectedBrandId ? 'selected' : ''}>${b.brandName}</option>`);
                });

                // 若是編輯模式，有指定品牌，直接觸發 change 事件載入商品
                if(selectedBrandId) {
                    brandSelect.trigger('change');
                }
            });

            // 品牌 change → 載入商品
            brandSelect.off('change').on('change', function() {
                resetStockInfo();
                var brandId = $(this).val();
                if(!brandId) {
                    productSelect.empty().append('<option value="">請選商品</option>').prop('disabled', true);
                    skuSelect.empty().append('<option value="">請選 SKU</option>').prop('disabled', true);
                    return;
                }

                $.get('/SUP/StockBatches/GetProductsByBrand', { brandId: brandId }, function(products) {
                    productSelect.empty().append('<option value="">請選商品</option>');
                    products.forEach(p => {
                        productSelect.append(`<option value="${p.productId}" ${p.productId == selectedProductId ? 'selected' : ''}>${p.productName}</option>`);
                    });
                    productSelect.prop('disabled', false);

                    // 若是編輯模式，有指定商品，直接觸發 change 事件載入 SKU
                    if(selectedProductId) productSelect.trigger('change');
                });
            });

            // 商品 change → 載入 SKU，並清空下階
            productSelect.off('change').on('change', function() {
                resetStockInfo();
                var productId = $(this).val();

                // 清空下階層
                skuSelect.empty().append('<option value="">請選 SKU</option>').prop('disabled', true);
                resetStockInfo();

                if (!productId) return;

                $.get('/SUP/StockBatches/GetSkusByProduct', { productId: productId }, function(skus) {
                    skuSelect.empty().append('<option value="">請選 SKU</option>');
                    skus.forEach(sku => {
                        skuSelect.append(`<option value="${sku.skuId}" ${sku.skuId == selectedSkuId ? 'selected' : ''}>${sku.skuCode}</option>`);
                    });
                    skuSelect.prop('disabled', false);

                    // 若是編輯模式，有指定 SKU，延遲觸發 change
                    if(selectedSkuId) {
                        setTimeout(() => skuSelect.trigger('change'), 50);
                    }
                });
            });

            // SKU change → 載入 SKU 資訊
            skuSelect.off('change').on('change', function() {
                var skuId = $(this).val();
                console.log('[SKU Change] Selected SKU ID:', skuId);

                if(!skuId) {
                    $('#CurrentQty, #PredictedQty, #MaxStockQty, #ReorderPoint, #SafetyStockQty, #IsAllowBackorderText').text('0');
                    $('#ChangeQtyInput').val(0).prop('max', 0);
                    return;
                }

                $.get('/SUP/StockBatches/GetSkuInfo', { skuId: skuId }, function(info) {
                    console.log('SKU Info:', info); // 確認回傳資料
                    var currentStock = info.currentStock || 0;
                    var maxStock = info.maxStockQty || 0;

                    $('#CurrentQty').text(currentStock);
                    $('#PredictedQty').text(info.expectedStock);
                    $('#MaxStockQty').text(maxStock);
                    $('#ReorderPoint').text(info.reorderPoint);
                    $('#SafetyStockQty').text(info.safetyStockQty);
                    $('#IsAllowBackorderText').text(info.isAllowBackorder ? '允許預購' : '不允許預購');

                    // 根據異動類型計算可輸入上限
                    var movementType = $('#MovementTypeSelect').val();
                    // var isAdd = $('input[name="IsAdd"]:checked').val() === 'true';
                    var isAllowBackorder = info.isAllowBackorder;

                    var isAdd;
                    if(movementType === 'Purchase') {
                        isAdd = true; // 採購入庫一定是增加
                    } else if(movementType === 'Adjust') {
                        isAdd = $('input[name="IsAdd"]:checked').val() === 'true';
                    } else {
                        isAdd = true; // 其他類型預設增加
                    }
                    console.log('[SKU Info] Is Add:', isAdd);

                    var maxChange = 0;
                    if (movementType === 'Adjust') {
                        // 調整型 → 不限制，交給使用者
                        maxChange = Number.MAX_SAFE_INTEGER;
                    } else {
                        if (isAdd) {
                            // 入庫：不能超過最大庫存
                            maxChange = maxStock - currentStock;
                            if (maxChange < 0) maxChange = 0;
                        } else {                            
                            // maxChange = isAllowBackorder ? Number.MAX_SAFE_INTEGER : currentStock;
                            // 出庫：不能超過現有庫存（所有出庫都不允許預購）
                            maxChange = currentStock;
                        }
                    }

                    $('#ChangeQtyInput').prop('max', maxChange);
                    if(parseInt($('#ChangeQtyInput').val()) > maxChange){
                        $('#ChangeQtyInput').val(maxChange);
                    }

                    // 預計庫存
                    updatePredictedStock();

                    // 預計庫存初始值
                    var predictedStock = currentStock + (parseInt($('#ChangeQtyInput').val()) || 0);
                    
                    if (!isAllowBackorder && !isAdd && predictedStock < 0) predictedStock = 0;

                    $('#PredictedQty').text(predictedStock);

                    updateChangeQtyLimitAndPredicted();
                });
            });

            // 異動類型切換+/-
            $(document).ready(function(){
                // 取得異動類型
                $.get('/SUP/StockBatches/GetMovementTypes', function(types) {
                    console.log('MovementTypes:', types);
                    movementTypeSelect.empty().append('<option value="">請選異動類型</option>');
                    types.forEach(t => {
                        var selected = (t.value === (isEdit ? 'Adjust' : '')) ? 'selected' : '';
                        movementTypeSelect.append(`<option value="${t.value}" ${selected}>${t.text}</option>`);
                    });

                    // 編輯模式固定為 Adjust
                    if(isEdit) {
                        movementTypeSelect.val('Adjust').prop('disabled', true);
                        $('#AdjustOptions').show();
                    } else {
                        movementTypeSelect.prop('disabled', false);
                        $('#AdjustOptions').hide();
                    }

                    // 異動庫存量欄位永遠顯示
                    $('#ChangeQtyInput').closest('.form-floating').show();

                    // 每次切換都重新計算上限與預計庫存
                    updateChangeQtyLimitAndPredicted();
                });

                // 異動類型選擇事件
                movementTypeSelect.on('change', function(){
                    var newType = $(this).val();
                    console.log('[Movement Type Change] New Type:', newType);
                    if ($(this).val() === 'Adjust') {
                        $('#AdjustOptions').show();
                    } else {
                        $('#AdjustOptions').hide();
                    }

                    // 異動類型切換時，立即刷新數量上限與預計庫存
                    updatePredictedStock();
                });

            });

            // 綁定異動數量輸入檢查（即時修正輸入）
            $('#ChangeQtyInput').on('input', function () {
                let val = parseInt($(this).val()) || 0;

                // 取得當前上下限
                var currentStock = parseInt($('#CurrentQty').text()) || 0;
                var maxStock = parseInt($('#MaxStockQty').text()) || 0;
                var isAdd = $('input[name="IsAdd"]:checked').val() === 'true';
                var movementType = $('#MovementTypeSelect').val();
                var maxChange = 0;
                const min = 1; // 異動數量最小為 1

                // 計算上限
                if (movementType === 'Adjust') {
                    maxChange = isAdd ? maxStock - currentStock : currentStock;
                } else {
                    // 採購入庫或其他異動類型 → 上限 = 最大庫存 - 當前庫存
                    maxChange = maxStock - currentStock;
                }
                if (maxChange < 0) maxChange = 0;

                // 修正輸入值
                if (val < min) val = min;
                if (val > maxChange) val = maxChange;

                $(this).val(val);

                // 同步更新預計庫存
                updatePredictedStock();
            });

            // 即時更新「預計庫存」欄位
            function updatePredictedStock() {
                var changeQty = parseInt($('#ChangeQtyInput').val()) || 0;
                var currentStock = parseInt($('#CurrentQty').text()) || 0;
                var maxStock = parseInt($('#MaxStockQty').text()) || 0;
                var isAdd = $('input[name="IsAdd"]:checked').val() === 'true';
                var movementType = $('#MovementTypeSelect').val();
                var maxChange = 0;

                // 計算異動上限
                if (movementType === 'Adjust') {
                    if (isAdd) {
                        // 手動增加 → 上限 = 最大庫存 - 當前庫存
                        maxChange = maxStock - currentStock;
                    } else {
                        // 手動減少 → 上限 = 當前庫存，不允許超賣
                        maxChange = currentStock;
                    }
                } else {
                    // 採購入庫或其他異動類型 → 上限 = 最大庫存 - 當前庫存
                    maxChange = maxStock - currentStock;
                }

                if (maxChange < 0) maxChange = 0;

                // 修正輸入值，不超過上限
                if (changeQty > maxChange) {
                    changeQty = maxChange;
                    $('#ChangeQtyInput').val(changeQty);
                }

                // 計算預計庫存
                var predictedStock;
                if (movementType === 'Adjust') {
                    predictedStock = isAdd ? currentStock + changeQty : currentStock - changeQty;
                } else {
                    // 其他異動類型一律加
                    predictedStock = currentStock + changeQty;
                }

                // 出庫不允許超賣，預計庫存不得為負
                if (!isAdd && predictedStock < 0) {
                    predictedStock = 0;
                }

                $('#PredictedQty').text(predictedStock);
            }

            // 當變動數量輸入時即時更新
            $('#ChangeQtyInput').off('input').on('input', function () {
                let changeQty = parseInt($(this).val()) || 0;

                // 取得當前異動類型
                var movementType = $('#MovementTypeSelect').val();

                if (movementType !== 'Adjust') {
                    // 非Adjust，一律強制為正數
                    if (changeQty < 0) {
                        changeQty = Math.abs(changeQty);
                        $(this).val(changeQty);
                    }
                }

                // 預計庫存
                updatePredictedStock();
            });

            // 清空庫存顯示並清空異動輸入數量
            function resetStockInfo() {
                $('#CurrentQty, #PredictedQty, #MaxStockQty, #ReorderPoint, #SafetyStockQty, #IsAllowBackorderText')
                    .text('0');
                $('#ChangeQtyInput').val('').prop('max', 0);
            }

            // 當加/減 radio 改變時，即時更新預計庫存
            $('input[name="IsAdd"]').off('change').on('change', function() {
                var isAdd = $(this).val() === 'true';
                console.log('[IsAdd Change] Selected:', isAdd);

                var currentStock = parseInt($('#CurrentQty').text()) || 0;
                var maxStock = parseInt($('#MaxStockQty').text()) || 0;
                var isAllowBackorder = $('#IsAllowBackorderText').text() === '允許預購';

                var changeQtyInput = $('#ChangeQtyInput');
                var changeQty = parseInt(changeQtyInput.val()) || 0;

                if (isAdd) {
                    // 增加時上限 = 最大庫存 - 當前庫存
                    var maxChange = maxStock - currentStock;
                    if (maxChange < 0) maxChange = 0;
                    changeQtyInput.prop('max', maxChange);

                    // 超過上限自動切換到上限
                    if (changeQty > maxChange) changeQtyInput.val(maxChange);
                } else {
                    // 減少時上限 = 當前庫存（不可超賣）
                    var maxChange = isAllowBackorder ? Number.MAX_SAFE_INTEGER : currentStock;
                    changeQtyInput.prop('max', maxChange);

                    // 超過上限自動切換到上限
                    if (changeQty > maxChange) changeQtyInput.val(maxChange);
                }

                // 更新預計庫存
                updatePredictedStock();

                updateChangeQtyLimitAndPredicted();
            });

            // 異動數量直接輸入時自動修正
            $('#ChangeQtyInput').on('input', function() {
                let val = parseInt($(this).val());

                // 如果輸入不是數字或小於 1，修正為最小值 1
                if (isNaN(val) || val < 1) {
                    val = 1;
                    $(this).val(val);
                }

                // 取得上限
                const max = parseInt($(this).attr('max')) || Number.MAX_SAFE_INTEGER;
                if (val > max) {
                    val = max;
                    $(this).val(val);
                }

                // 更新預計庫存
                updateChangeQtyLimitAndPredicted();
            });

            // 異動數量提示
            $(document).ready(function() {
                const changeQtyHelp = $('#ChangeQtyHelp'); // 異動數量提示元素
                const movementTypeSelect = $('#MovementTypeSelect'); // 異動類型下拉選單

                // 初始隱藏
                changeQtyHelp.hide();

                movementTypeSelect.on('change', function() {
                    const selectedType = $(this).val();

                    if (selectedType) {
                        // 有選擇類型才顯示提示
                        changeQtyHelp.show();

                        // 可根據選擇類型動態改提示文字
                        if (selectedType === 'Purchase') {
                            changeQtyHelp.text('採購入庫，異動數量上限 = 最大庫存 - 目前庫存');
                        } else if (selectedType === 'Adjust') {
                            changeQtyHelp.text('手動調整，可選增加或減少');
                        } else {
                            changeQtyHelp.text('異動數量提示');
                        }
                    } else {
                        changeQtyHelp.hide();
                    }
                });
            });


            // 異動日期預設今天
            $(document).ready(function() {
                var today = new Date().toISOString().split('T')[0]; // yyyy-MM-dd
                $('#ManufactureDate').val(today);
            });
        }

        // 初始化庫存 DataTable 與按鈕事件
        $(document).ready(function () {

            // ======= 初始化所有 SKU 批號 =======
            $('#btnInitBatches').click(function() {
                if(!confirm('確定要初始化所有 SKU 批號嗎？')) return;

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("InitializeBatches", "StockBatches")',
                    headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                    success: function(res) {
                        if(res.success){
                            $('#initResult').text(res.message).css('color','green');
                        } else {
                            $('#initResult').text(res.message).css('color','red');
                        }
                    },
                    error: function(err) {
                        $('#initResult').text('伺服器錯誤').css('color','red');
                    }
                });
            });

            // ======= 從 sessionStorage 拿到初始品牌名稱 =======
            var initialBrandName = sessionStorage.getItem('selectedBrandName') || '';
            
            // 初始化完就清掉，避免刷新又填入
            sessionStorage.removeItem('selectedBrandName');

            // ======= 定義 selectedSupplierId =======
            var selectedSupplierId = '';

            // ======= 初始化 1. 庫存紀錄 DataTable =======
            var stockBatchTable = $('#stockBatchTable').DataTable({
                serverSide: true,   // 用後端搜排分業
                processing: true,   // 顯示「正在處理中」的訊息（loading）
                ajax: {
                    url: '/SUP/StockBatches/IndexJson',
                    type: 'POST',
                    data: function(d) {
                        d.supplierId = selectedSupplierId; // 傳給 IndexJson
                        d.expireFilter = $('#stockExpireFilter').val(); // 傳到期日篩選值
                    },
                    dataSrc: function(json) {
                        console.log(json);      // 印出整個 JSON
                        //console.log(json.data); // 印出每筆 row
                       return json.data;
                    }
                },
                columns: [
                    { data: 'skuCode', title: 'SKU', className: 'text-center'},
                    { data: 'batchNumber', title: '批號', className: 'text-center'},
                    { data: 'brandName', title: '品牌', className: 'text-center'},
                    { data: 'productName', title: '商品名稱', className: 'text-center'},
                    {
                        data: 'expireDate',
                        title: '到期日',
                        className: 'text-center',
                        render: function(data) {
                            if (!data) return '無';
                            let date = new Date(data);
                            let today = new Date();
                            let formatted = date.toLocaleDateString('zh-TW');

                            if (date < today.setHours(0,0,0,0)) {
                                return `<span class="text-danger">${formatted} (已過期)</span>`;
                            }
                            return formatted;
                        }
                    },
                    {
                        data: 'qty',
                        title: '批次庫存量',
                        className: 'text-center',
                        render: function (data, type, row) {
                            let stock = parseInt(data);
                            let reorder = parseInt(row.reorderPoint);
                            let safety = parseInt(row.safetyStockQty);

                            if (stock <= safety) {
                                return `<span class="stock-danger" data-bs-toggle="tooltip" title="低於安全庫存"><i class="fa-solid fa-triangle-exclamation" style="color: #e66774;"></i>${stock}</span>`;
                            } else if (stock <= reorder) {
                                return `<span class="stock-low" data-bs-toggle="tooltip" title="庫存低於再訂購點"><i class="fa-solid fa-circle-exclamation" style="color: #f9d66f;"></i>${stock}</span>`;
                            }
                            return `<span class="stock-normal" data-bs-toggle="tooltip" title="庫存正常">${stock}</span>`;
                        }
                    },
                    { data: 'reorderPoint', title: '再訂購點' , className: 'text-center'},
                    { data: 'safetyStockQty', title: '安全庫存' , className: 'text-center'},
                    {
                        data: 'specifications',
                        className: 'text-center',
                        title: '規格',
                        render: function(data) {
                            // console.log(data);  // 印出確認
                            if(!data) return '';
                            return data.map(s => s.groupName + ':' + s.optionName).join(' / ');
                        }
                    },
                    {
                        data: 'stockBatchId',
                        title: '操作',
                        className: 'text-center',
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <button class="btn btn-sm edit-stock-btn" data-id="${data}" data-bs-toggle="tooltip" title="庫存異動">
                                    <i class="fa-solid fa-right-from-bracket" style="color: #977ee2;"></i>
                                </button>
                                <button class="btn btn-sm stock-history-btn" data-brandid="${row.BrandCode}" data-bs-toggle="tooltip" title="異動紀錄">
                                    <i class="fa-solid fa-clock-rotate-left" style="color: #1c7ed6;"></i>
                                </button>
                            `;
                        }
                    }
                ],
                scrollY: "500px",
                scrollCollapse: true,
                colReorder: true,
                //order: [[1, 'asc']], // 第一欄是控制欄，不排序
                columnDefs: [
                    { targets: '_all', type: 'string' }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.3.3/i18n/zh-HANT.json',
                    processing: '<i class="fa-solid fa-dog fa-bounce fa-3x"></i>'
                },
                initComplete: function(settings, json) {
                    // ===== 自動填入搜尋品牌名稱 =====
                    if (initialBrandName) {
                        var searchInput = $('#dt-search-0');
                        searchInput.val(initialBrandName).trigger('input');
                        stockBatchTable.search(initialBrandName).draw();

                        Swal.fire({
                            icon: 'info',
                            title: '已篩選',
                            text: `目前顯示供應商 "${initialBrandName}" 的品牌庫存`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                    // 初始化 tooltip
                    $('[data-bs-toggle="tooltip"]').each(function() {
                        new bootstrap.Tooltip(this);
                    });
                }
            });

            // ======= 初始化 2. 全站異動紀錄 DataTable =======
            var historyTable = $('#historyTable').DataTable({
                serverSide: true,   // 用後端搜排分業
                processing: true,   // 顯示「正在處理中」的訊息（loading）
                ajax: {
                    url:'/SUP/StockBatches/GetAllStockHistory',
                    type: 'POST',
                    data: function(d) {
                        d.supplierId = selectedSupplierId; // 傳給 IndexJson
                        d.expireFilter = $('#historyExpireFilter').val(); // 傳到期日篩選值
                    },
                    dataSrc: function(json) {
                        console.log(json);      // 印出整個 JSON
                        //console.log(json.data); // 印出每筆 row
                       return json.data;
                    }
                },
                columns: [
                    { data: 'skuCode', title: 'SKU', className: 'text-center'},
                    { data: 'batchNumber', title: '批號', className: 'text-center'},
                    {
                        data: 'expireDate',
                        title: '到期日',
                        className: 'text-center',
                        render: function(d) {
                            if (!d) return '無';
                            let date = new Date(d);
                            let today = new Date();
                            let formatted = date.toLocaleDateString('zh-TW');

                            if (date < new Date(today.setHours(0,0,0,0))) {
                                return `<span class="text-danger">${formatted} (已過期)</span>`;
                            }
                            return formatted;
                        }
                    },
                    { data: 'changeType', title: '異動類型' , className: 'text-center'},
                    { data: 'beforeQty', title: '異動前數量', className: 'text-center'},
                    { data: 'changeQty', title: '異動數量' , className: 'text-center'},
                    { data: 'afterQty', title: '異動後數量', className: 'text-center'},
                    {
                        data: 'revisedDate',
                        title: '異動時間',
                        className: 'text-center',
                        render: d => d ? new Date(d).toLocaleString() : ''
                    },
                    { data: 'reviser', title: '異動人員' , className: 'text-center'},
                    {
                        data: 'stockBatchId',
                        title: '操作',
                        className: 'text-center',
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <button class="btn btn-sm stock-history-btn" data-brandid="${row.BrandCode}" data-bs-toggle="tooltip" title="更改備註">
                                    <i class="fa-solid fa-pen-to-square" style="color: #9073e8;"></i>
                                </button>
                            `;
                        }
                    }
                ],
                scrollY: "500px",
                scrollCollapse: true,
                colReorder: true,
                columnDefs: [
                    { targets: '_all', type: 'string' }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.3.3/i18n/zh-HANT.json',
                    processing: '<i class="fa-solid fa-dog fa-bounce fa-3x"></i>'
                },
                order: [[7, 'desc']] // 預設依時間新到舊
            });


            // 下拉選單事件
            $('#stockExpireFilter').on('change', () => stockBatchTable.ajax.reload());
            $('#historyExpireFilter').on('change', () => historyTable.ajax.reload());


            // 點擊按鈕切換 datatable
            $('#btnToggleStock').on('click', function () {
                var btn = $(this);
                var arrow = btn.find('.arrow i'); // 取到 <i class="...">

                if ($('#stockTableWrapper').is(':visible')) {
                    // 切換到異動紀錄
                    // $('#stockTableWrapper, #tableTitle').fadeOut(200, function () {
                    //     $('#tableTitle').text('全站異動紀錄').fadeIn(200);
                    //     $('#historyTableWrapper').fadeIn(200);
                    // });
                    $('#stockTableWrapper').hide();
                    $('#historyTableWrapper').show();
                    $('#tableTitle').text('全站異動紀錄');

                    btn.html('<span class="arrow"><i class="fa-solid fa-arrow-left"></i></span> 顯示庫存紀錄');
                    historyTable.ajax.reload();
                } else {
                    // 切換回庫存紀錄
                    // $('#historyTableWrapper, #tableTitle').fadeOut(200, function () {
                    //     $('#tableTitle').text('庫存紀錄').fadeIn(200);
                    //     $('#stockTableWrapper').fadeIn(200);
                    // });

                    $('#historyTableWrapper').hide();
                    $('#stockTableWrapper').show();
                    $('#tableTitle').text('庫存紀錄');

                    btn.html('<span class="arrow"><i class="fa-solid fa-arrow-right"></i></span> 顯示異動紀錄');
                    stockBatchTable.ajax.reload();
                }
            });



            // 每次 redraw 都重新初始化 tooltip
            stockBatchTable.on('draw', function() {
                $('[data-bs-toggle="tooltip"]').each(function() {
                    new bootstrap.Tooltip(this);
                });
            });

            // ===== 搜尋欄清空時重置 =====
            $('#dt-search-0').on('input', function() {
                if ($(this).val() === '') {
                    stockBatchTable.search('').draw();
                }
            });

            // ===== 新增庫存按鈕 =====
            $('#createStockBatchBtn').on('click', function () {
                $.get('/SUP/StockBatches/Create', function(html){
                    $('#stockBatchModalContent').html(html);
                    $('#stockBatchModalTitle').text("新增庫存");
                    $('#stockBatchModal').modal('show');

                    // 初始化表單：允許選擇 SKU、手動調整 (+/-) 及數量、備註
                    if(window.initStockBatchForm) window.initStockBatchForm();
                });
            });

            // ===== 編輯庫存異動 =====
            $('#stockBatchTable').on('click', '.edit-stock-btn', function() {
                var id = $(this).data('id');

                // 取得該筆異動資料
                $.get(`/SUP/StockBatches/Edit/${id}`, function(html){
                    // 將表單內容放入 modal
                    $('#stockBatchModalContent').html(html);
                    $('#stockBatchModalTitle').text("庫存異動");
                    $('#stockBatchModal').modal('show');

                // 固定異動類型 Adjust
                $('#MovementTypeSelect').val('Adjust').prop('disabled', true);
                $('#AdjustOptions').show(); // 顯示 + / -

                // 顯示批次現有庫存
                updateChangeQtyLimitAndPredicted();

                // radio 選擇事件
                $('input[name="IsAdd"]').off('change').on('change', function() {
                    updateChangeQtyLimitAndPredicted();
                });

                // input 變動事件
                $('#ChangeQtyInput').off('input').on('input', function() {
                    updateChangeQtyLimitAndPredicted();
                });

                // 儲存按鈕事件
                $('#saveStockChangeBtn').off('click').on('click', function() {
                    var formData = $('#stockBatchEditForm').serialize();
                    $.post(`/SUP/StockBatches/Update/${id}`, formData, function(res){
                        if(res.success){
                            $('#stockBatchModal').modal('hide');
                            // 可刷新表格或提示
                        } else {
                            alert(res.message);
                        }
                    });
                    // 預計庫存 & 異動數量上限
                    updateChangeQtyLimitAndPredicted();
                });

            });
        });


            // ===== 異動紀錄按鈕 =====
            $('#stockBatchTable').on('click', '.stock-history-btn', function() {
                var brandCode = $(this).data('brandid');
                window.location.href = `/SUP/StockBatches/History?brandCode=${brandCode}`;
            });

            // ===== submit =====
            $('#stockBatchModalContent')
            .off('submit', '#stockBatchForm')
            .on('submit', '#stockBatchForm', function (e) {
                e.preventDefault();
                var form = $(this);
                var formData = new FormData(form[0]);

                // 無論異動類型，都送 MovementType
                var movementType = $('#MovementTypeSelect').val();
                if (movementType) {
                    formData.set('MovementType', movementType);
                    console.log("異動類型:", movementType);
                }

                // 無論異動類型，都送 IsAdd（增加/減少選擇）
                var isAdd = $('input[name="IsAdd"]:checked').val() === 'true';
                formData.set('IsAdd', isAdd);
                console.log("加減選擇:", isAdd ? "增加" : "減少");

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]', form).val()
                    },
                    success: function (res) {
                        console.log("後端回傳完整資料:", res);

                        // 避免 batchMovements 為 undefined
                        var batchMovements = res.batchMovements || [];
                        console.log("batchMovements:", batchMovements);

                        if (res.success) {
                            $('#stockBatchModal').modal('hide');

                            Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: res.message || '操作成功',
                                showConfirmButton: false,
                                timer: 1200
                            });

                            // 更新 DataTable（保持當前頁）
                            stockBatchTable.ajax.reload(null, false);

                            if (batchMovements.length > 0) {
                                showbatchMovements(batchMovements);
                                console.log("有異動紀錄:", batchMovements);
                            }

                        } else {
                            Swal.fire('操作失敗', res.message || '資料格式錯誤', 'error');
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('操作失敗', '伺服器發生錯誤', 'error');
                        console.error("AJAX 發生錯誤:", status, error);
                    }
                });
            });

        });

        // 異動後浮現批次明細表格
        function showbatchMovements(batchMovements) {
            const tbody = $('#batchMovementTable tbody');
            tbody.empty();

            batchMovements.forEach(m => {
                // 正確計算增減符號
                let changeDisplay = m.isAdd ? `+${m.changeQty}` : `-${m.changeQty}`;

                // 異動後庫存
                const afterQtyDisplay = m.isAdd ? m.currentQty + m.changeQty : m.currentQty - m.changeQty;

                const row = `<tr>
                    <td>${m.skuCode}</td>
                    <td>${m.batchNumber || '-'}</td>
                    <td>${getMovementTypeText(m.movementType)}</td>
                    <td>${m.currentQty}</td>
                    <td>${changeDisplay}</td>
                    <td>${afterQtyDisplay}</td>
                </tr>`;
                tbody.append(row);
            });

            $('#batchMovementModal').modal('show');
        }

        function getMovementTypeText(type) {
            switch(type) {
                case 'Adjust': return '手動調整';
                case 'Purchase': return '採購入庫';
                case 'Sale': return '出貨';
                case 'Return': return '退貨';
                default: return type;
            }
        }


        // 計算上限
        function calcMaxAllowed(movementType, isAdd, currentStock, maxStock) {
            // 非 Adjust 當作增加
            // if (movementType !== 'Adjust') {
            //     isAdd = true;
            // }

            if (isAdd) {
                var allowed = (maxStock - currentStock);
                if (allowed < 0) allowed = 0;
                return allowed;
            } else {
                var allowed = currentStock;
                if (allowed < 0) allowed = 0;
                return allowed;
            }
        }

        // 更新 input 的 max 與 helper，並自動修正輸入值
        function updateChangeQtyLimitAndPredicted() {
            var currentStock = parseInt($('#CurrentQty').text()) || 0;
            var maxStock = parseInt($('#MaxStockQty').text()) || 0;
            var movementType = $('#MovementTypeSelect').val() || '';
            // 當不是 Adjust 時，視為增加
            var isAdd = $('input[name="IsAdd"]:checked').val() === 'true';
            // if (movementType !== 'Adjust') isAdd = true;

            var maxAllowed = calcMaxAllowed(movementType, isAdd, currentStock, maxStock);

            var $input = $('#ChangeQtyInput');
            var curVal = parseInt($input.val()) || 0;

            // 設定 html max 屬性（讓內建箭頭有上下限制）
            $input.attr('max', maxAllowed);

            // helper 顯示
            $('#ChangeQtyHelp').text('上限: ' + maxAllowed + (isAdd ? '（可增加）' : '（可減少）'));

            // 若輸入超過上限，直接改為上限
            if (curVal > maxAllowed) {
                $input.val(maxAllowed);
                curVal = maxAllowed;
            }

            // 若輸入小於 1，強制為 1（因為前端要求正整數）
            if (curVal < 1) {
                $input.val(1);
                curVal = 1;
            }

            // 更新預計庫存顯示
            var predicted;
            if (movementType === 'Adjust') {
                predicted = isAdd ? currentStock + curVal : currentStock - curVal;
            } else {
                // 其他類型視為增加（例如 Purchase）
                predicted = currentStock + curVal;
            }
            // 非允許預購暫不實作 -> 如低於0則顯示 0
            if (predicted < 0) predicted = 0;
            $('#PredictedQty').text(predicted);
        }

    </script>
}

