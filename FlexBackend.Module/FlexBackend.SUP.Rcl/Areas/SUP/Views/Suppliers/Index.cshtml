@* Suppliers Index *@
@* 可搜 供應商名/聯絡人名/電話/Email *@

@section Styles {  
    <!-- Area 專用 CSS -->
    <link rel="stylesheet" href="~/_content/FlexBackend.SUP.Rcl/css/supstylesheet.css" />
    <style>
    </style>
}

<button id="create" class="btn btn-outline-success mb-2">新增供應商</button>

@* 渲染 DataTable *@
<div class="supplier-card">
    <h5>供應商資料</h5>
    <table id="supplierTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 新增/修改供應商 Modal -->
<div id="supplierModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white container">
            <!-- Header -->
            <div class="modal-header">
                <h5 id="supplierModalTitle" class="modal-title">供應商</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="d-flex ">
                <button type="button" id="fillNameContact" class="btn d-flex mt-3 me-2" style="background-color:#35afe6;color:#fff;">自動填入名稱與聯絡人</button>
                <button type="button" id="fillEmail" class="btn d-flex mt-3" style="background-color:#35afe6;color:#fff;">自動填入電子信箱</button>
            </div>
            <!-- Body -->
            <div id="supplierModalContent" class="modal-body p-4">
                <!-- 透過 AJAX 載入 _SupplierFormPartial.cshtml -->
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script>
        $(document).ready(function() {
            
            // ======= URL 變數 ======= // 生成正確的 URL（Razor 會替換成 /SUP/Suppliers/...）
            var indexJsonUrl = '@Url.Action("IndexJson", "Suppliers", new { area = "SUP" })';
            var createUrl = '@Url.Action("Create", "Suppliers", new { area = "SUP" })';
            var editUrl = '@Url.Action("Edit", "Suppliers", new { area = "SUP" })';
            var detailsUrl = '@Url.Action("Details", "Suppliers", new { area = "SUP" })';
            var deleteUrl = '@Url.Action("DeleteAjax", "Suppliers", new { area = "SUP" })';
            var toggleActiveUrl = '@Url.Action("ToggleActive", "Suppliers", new { area = "SUP" })';
            var stockBatchUrl = '@Url.Action("Index", "StockBatches", new { area = "SUP" })';


            // 初始化 DataTable
            var table = $('#supplierTable').DataTable({
                serverSide: true,
                processing: true,
                ajax: {
                    url: indexJsonUrl,
                    type: 'POST',
                    dataSrc: 'data'
                },
                columns: [
                    {
                        data: 'sortDate',          // 後端給每筆資料一個排序用時間
                        title: '#',
                        className: 'text-center',
                        orderable: true,
                        render: function(data, type, row, meta) {
                            return meta.row + 1 + meta.settings._iDisplayStart; // 顯示序號
                        }
                    },
                    {
                        data: 'supplierName',
                        title: '供應商名稱',
                        render: function(data, type, row) {
                            return `${data} <button class="btn btn-link btn-sm details-btn" data-id="${row.supplierId}" title="詳細資料" data-bs-toggle="tooltip"><i class="fa-solid fa-circle-info" style="color: #73e0eb;"></i></button>`;
                        }
                    },
                    { data: 'contactName', title: '聯絡人' },
                    { data: 'phone', title: '聯絡電話', className: 'text-center'},
                    { data: 'email', title: 'Email'},
                    {
                        data: 'isActive',
                        title: '啟用狀態',
                        className: 'text-center',
                        render: function(data, type, row) {
                            var checked = data ? 'checked' : '';
                            return `
                                <div class="form-check form-switch">
                                    <input class="form-check-input toggle-active" type="checkbox" data-id="${row.supplierId}" ${checked}>
                                </div>
                            `;
                        },
                    },
                    {
                        data: 'supplierId',
                        title: '操作',
                        className: 'text-center',
                        orderable: false,   // 禁止排序
                        render: function(data) {
                            return `
                                <button class="btn btn-sm inventory-btn" data-id="${data}" title="前往名下品牌庫存" data-bs-toggle="tooltip">
                                    <i class="fa-regular fa-truck" style="color: #dca91e;"></i> 庫存
                                </button>
                                <button class="btn btn-sm edit-btn" data-id="${data}" title="編輯" data-bs-toggle="tooltip">
                                    <i class="fa-regular fa-pen-to-square" style="color: #9073e8;"></i>
                                </button>
                                <button class="btn btn-sm delete-btn" data-id="${data}" title="刪除" data-bs-toggle="tooltip">
                                    <i class="fa-solid fa-trash" style="color: #6688b7;"></i>
                                </button>
                            `;
                        }
                    }
                ],
                // fixedHeader: true,
                scrollY: "500px",     // 表格顯示區域的高度
                scrollCollapse: true, // 垂直滾動條，當資料少於高度時收合
                colReorder: true,
                columnDefs: [
                    { targets: '_all', type: 'string' } // 所有欄位都設成文字
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.3.3/i18n/zh-HANT.json',   // i18n
                    processing: '<i class="fa-solid fa-dog fa-bounce fa-3x"></i>'   // 自訂載入圖示，大小fa-3x
                }
            });

            // 初始化 tooltip
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (el) {
                return new bootstrap.Tooltip(el);
            });

            // 每次 redraw 都要再初始化 tooltip
            table.on('draw', function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (el) {
                    return new bootstrap.Tooltip(el);
                });
            });

            // ======= 新增供應商 =======
            // 發送 GET 請求到 /Suppliers/Create
            $("#create").click(function() {
                $.get( createUrl,  function(html) {
                    // 動態設定 Modal 標題
                    $("#supplierModalTitle").text("新增供應商");
                    // 將 Partial 載入 Modal
                    $('#supplierModalContent').html(html);
                    // 重新解析 jQuery Unobtrusive Validation
                    $.validator.unobtrusive.parse('#supplierModalContent');
                    $('#supplierModal').modal('show');
                });
            });

            // ======= 編輯供應商 =======
            $('#supplierTable').on('click', '.edit-btn', function () {
                var id = $(this).data('id');

                // 用 AJAX 把 Partial View 載入到 Modal 裡
                $.get(`${editUrl}/${id}`, function (html) {
                    $("#supplierModalTitle").text("修改供應商"); // 動態設定 Modal 標題
                    $('#supplierModalContent').html(html);  // 把表單塞進去
                    $.validator.unobtrusive.parse('#supplierModalContent');
                    $('#supplierModal').modal('show'); // 顯示 Modal
                });
            });

            // 編輯 Modal 內 checkbox
            $('#supplierModalContent').on('change', 'input[name="IsActive"]', function() {
                var checkbox = $(this);
                var supplierName = $('#SupplierName').val();
                var newStatus = checkbox.prop('checked');

                Swal.fire({
                    title: newStatus ?
                        `確定要啟用供應商：<br>"${supplierName}" 嗎？` :
                        `確定要停用供應商：<br>"${supplierName}" 嗎？`,
                    icon: newStatus ? 'question' : 'warning',
                    showCancelButton: true,
                    confirmButtonText: newStatus ? '啟用' : '停用',
                    cancelButtonText: '取消',
                    confirmButtonColor: newStatus ? '#3085d6' : '#d33'
                }).then((result) => {
                    if (!result.isConfirmed) {
                        // 使用者取消 → 回復舊值
                        checkbox.prop('checked', !newStatus);
                    } else {
                        // 使用者確認 → 更新提示 p
                        $('#statusMsg').text(`已切換至${newStatus ? '"啟用"' : '"停用"'}狀態`);
                    }
                });
            });

            // ======= 提交表單 (新增/修改) =======
            $('#supplierModalContent').on('submit', '#supplierForm', function(e) {
                e.preventDefault();
                var form = $(this);

                // 手動把 checkbox 值更新到 hidden input
                var isActive = $('#IsActive').prop('checked');
                $('input[name="IsActive"][type="hidden"]', form).val(isActive);

                $.post(form.attr('action'), form.serialize())
                .done(function(res) {
                    // 判斷回傳結果是否為 JSON
                    var isJson = res && (typeof res === "object" || res[0] === '{' || res[0] === '[');
                    var data = isJson ? (typeof res === "string" ? JSON.parse(res) : res) : null;

                    if (data) {
                        if (data.success) {
                            $('#supplierModal').modal('hide');

                            Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: data.isCreate ? '新增成功' : '修改成功',
                                showConfirmButton: false,
                                timer: 1200
                            });

                            // 如果後端回傳 supplier，直接新增一列到 table
                            if (data.supplier) {
                                if (data.isCreate) {
                                    // 新增列
                                    table.row.add({
                                        supplierId: data.supplier.SupplierId,
                                        supplierName: data.supplier.SupplierName,
                                        contactName: data.supplier.ContactName,
                                        phone: data.supplier.Phone,
                                        email: data.supplier.Email,
                                        isActive: data.supplier.IsActive
                                    }).draw(false);
                                } else {
                                    // 編輯 → 更新對應 row
                                    var row = table.row(function(idx, d, node) {
                                        return d.supplierId === data.supplier.SupplierId;
                                    });
                                    if (row.any()) {
                                        row.data({
                                            supplierId: data.supplier.SupplierId,
                                            supplierName: data.supplier.SupplierName,
                                            contactName: data.supplier.ContactName,
                                            phone: data.supplier.Phone,
                                            email: data.supplier.Email,
                                            isActive: data.supplier.IsActive
                                        }).draw(false);
                                    } else {
                                        // fallback 重新載入 table
                                        table.ajax.reload(null, false);
                                    }
                                }
                            }


                        } else if (data.message === "未變更") {
                            Swal.fire('未變更', '', 'info');
                        } else {
                            $('#supplierModalContent').html(res);
                            $.validator.unobtrusive.parse('#supplierModalContent');
                        }
                    }
                })
                .fail(function() {
                    Swal.fire('操作失敗', '', 'error');
                });
            });


            // ======= 啟用/停用供應商 =======
            $('#supplierTable').on('change', '.toggle-active', function() {
                var checkbox = $(this);
                var id = checkbox.data('id');
                var rowData = table.row(checkbox.closest('tr')).data();
                var supplierName = rowData.supplierName;
                var newStatus = checkbox.prop('checked'); // true = 啟用

                // 回復原本狀態，等待確認
                checkbox.prop('checked', !newStatus);

                Swal.fire({
                    title: newStatus ?
                        `確定要啟用供應商：<br>"${supplierName}" 嗎？` :
                        `確定要停用供應商：<br>"${supplierName}" 嗎？`,
                    icon: newStatus ? 'question' : 'warning',
                    showCancelButton: true,
                    confirmButtonText: newStatus ? '啟用' : '停用',
                    cancelButtonText: '取消',
                    confirmButtonColor: newStatus ? '#3085d6' : '#d33'
                }).then((result) => {
                    if(result.isConfirmed){
                        $.post(`${toggleActiveUrl}/${id}`, { isActive: newStatus })
                        .done(function(res){
                            if(res.success){
                                checkbox.prop('checked', newStatus);
                                Swal.fire({
                                    position: 'center',
                                    icon: 'success',
                                    title: `供應商已${newStatus ? '啟用' : '停用'}`,
                                    showConfirmButton: false,
                                    timer: 1200
                                });
                                table.ajax.reload(null, false);
                            } else {
                                Swal.fire('操作失敗', res.message || '', 'error');
                            }
                        })
                        .fail(function(){ Swal.fire('操作失敗', '', 'error'); });
                    }
                });
            });


            // ======= 查看詳情i =======
            $('#supplierTable').on('click', '.details-btn', function() {
                var id = $(this).data('id');

                // GET 詳細資料 Partial View
                    $.get(`${detailsUrl}/${id}`, function(html) {
                    $('#supplierModalTitle').text("供應商詳細資料");
                    $('#supplierModalContent').html(html);  // 塞進 Modal
                    $('#supplierModal').modal('show');      // 顯示 Modal
                });
            });

            // ======= 刪除供應商 =======
            $('#supplierTable').on('click', '.delete-btn', function() {
                var id = $(this).data('id');
                var rowData = table.row($(this).closest('tr')).data();
                var supplierName = rowData.supplierName;

                Swal.fire({
                    title: `確定要刪除供應商："${supplierName}" 嗎？`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',   // 確認 → 紅色
                    cancelButtonColor: '#3085d6', // 取消 → 藍色
                    confirmButtonText: '刪除',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${deleteUrl}/${id}`,
                            type: 'POST',
                            success: function(res) {
                                if (res.success) {
                                    Swal.fire('刪除成功', '', 'success');
                                    table.ajax.reload(null, false);
                                } else {
                                    Swal.fire('刪除失敗', res.message || '', 'error');
                                }
                            },
                            error: function(xhr) {
                                var msg = xhr.responseJSON?.message || '刪除失敗';
                                Swal.fire('刪除失敗', msg, 'error');
                            }
                        });
                    }
                });
            });

            // ======= 點[庫存]跳轉 =======
            $('#supplierTable').on('click', '.inventory-btn', function () {
                var supplierId = $(this).data('id');
                console.log('點擊[庫存]，取得 supplierId:', supplierId);

                if (!supplierId) {
                    console.error('❌ supplierId 為空，無法繼續跳轉');
                    return;
                }

                // 傳進 URL 版
                // var url = '/SUP/StockBatches/Index?supplierId=' + supplierId;
                // window.location.href = url;

                // 用 TempData 傳版
                $.ajax({
                    url: '/SUP/StockBatches/GetBrandNameBySupplier',
                    type: 'GET',
                    data: { supplierId: supplierId },
                    success: function (brands) {
                        console.log('AJAX 成功，取得 brands:', brands);

                        if (!brands || brands.length === 0) {
                            console.warn('⚠️ 沒有品牌資料，存空字串');
                            sessionStorage.setItem('selectedBrandName', '');
                        } else {
                            // 注意這裡大小寫要對
                            var brandName = brands[0].brandName;
                            console.log('📌 取出的 brandName:', brandName);

                            sessionStorage.setItem('selectedBrandName', brandName);
                            console.log('✅ 存入 sessionStorage: selectedBrandName =', sessionStorage.getItem('selectedBrandName'));
                        }

                        console.log('⏳ 10 秒後跳轉到 /SUP/StockBatches/Index ...');
                        setTimeout(function () {
                            window.location.href = '/SUP/StockBatches/Index';
                        });
                        //, 10000); //等十秒看主控台訊息
                    },
                    error: function (xhr, status, error) {
                        console.error('❌ AJAX 失敗:', status, error);
                    }
                });
            });

            $(function () {
                // 重新解析 jQuery Validation
                $.validator.unobtrusive.parse('#supplierForm');

                // 按鈕1：自動填入名稱與聯絡人
                $('#fillNameContact').click(function () {
                    const now = new Date();
                    const hour = now.getHours();   // 小時
                    const minute = now.getMinutes(); // 分鐘

                    $('#SupplierName').val(`供應商${hour}點`);
                    $('#ContactName').val(`聯絡人${minute}分`);
                });

                // 按鈕2：自動填入電子信箱
                $('#fillEmail').click(function () {
                    const now = new Date();
                    const hh = String(now.getHours()).padStart(2, '0');
                    const mm = String(now.getMinutes()).padStart(2, '0');
                    const account = `${hh}${mm}`; // 例如 0935

                    // 隨機選一個 domain
                    const domains = ['@@ispan.com', '@@fuen43.com', '@@gggmail.com', '@@yyymail.com'];
                    const domain = domains[Math.floor(Math.random() * domains.length)];

                    $('#Email').val(`${account}${domain}`);
                });

            });
        });
    </script>
}