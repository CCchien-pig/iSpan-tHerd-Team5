@model FlexBackend.CNT.Rcl.Areas.CNT.ViewModels.PageEditVM

@{
    ViewData["Title"] = "編輯文章";
}

@section Styles {
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/_content/FlexBackend.CNT.Rcl/css/backtotop.css" asp-append-version="true" />@* 回頂部樣式 *@          
    <link rel="stylesheet" href="~/_content/FlexBackend.CNT.Rcl/css/fab.css" asp-append-version="true" />@* 右下角樣式 *@          
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">@* Bootstrap Icons 的引入檔*@

}

<div class="card shadow-sm border-0">
    <div class="card-header bg-warning-subtle text-dark fw-bold">
        ✏️ 編輯文章
    </div>
    <div class="card-body">
        <form asp-area="CNT" asp-controller="Pages" asp-action="Edit" method="post">
            @Html.AntiForgeryToken()

            <!-- 顯示整體錯誤訊息 -->
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <input type="hidden" asp-for="PageId" />

            <div class="mb-3">
                <label asp-for="Title" class="form-label">標題</label>
                <input asp-for="Title"
                       class="form-control"
                       placeholder="請輸入文章標題" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <!-- 分類 -->
            <div class="mb-3">
                <label asp-for="PageTypeId" class="form-label">文章分類</label>

                @if (Model.IsHomePage)
                {
                    <!-- 首頁：顯示文字 + 隱藏欄位 -->
                    <div class="form-control-plaintext">
                        <span class="badge bg-primary">首頁</span>
                    </div>
                    @Html.HiddenFor(m => m.PageTypeId)  <!-- 保持首頁值 -->
                    <!-- 首頁不需要驗證訊息 -->
                }
                else
                {
                    @Html.DropDownListFor(
                        m => m.PageTypeId,
                        (SelectList)ViewBag.PageTypeList,
                        "請選擇類別",
                        new { @class = "form-select" }
                    )
                    <span asp-validation-for="PageTypeId" class="text-danger"></span>
                }
            </div>
                <!-- 狀態 -->
                <div class="mb-3">
                    <label asp-for="Status" class="form-label">文章狀態</label>
                    <select asp-for="Status"
                            asp-items="Model.StatusList"
                            class="form-select"></select>
                    <span asp-validation-for="Status" class="text-danger"></span>
                </div>

            <!-- 標籤 -->
                <div class="mb-3">
                    <label class="form-label">標籤</label>
                   @if (Model.IsHomePage)
                    {
                        <select asp-for="SelectedTagIds"
                                asp-items="Model.TagOptions"
                                multiple="multiple"
                                class="tag-selector w-100"
                                data-val="false">
                        </select>
                        <small class="form-text text-muted">提示：首頁可以不填標籤，但仍可選擇</small>
                    }
                    else
                    {
                        <select asp-for="SelectedTagIds"
                                asp-items="Model.TagOptions"
                                multiple="multiple"
                                class="tag-selector w-100"
                                required>
                        </select>
                        <span asp-validation-for="SelectedTagIds" class="text-danger"></span>
                    }
                </div>

                <!-- 是否設定排程 -->
                <div class="form-check mb-2">
                    <input asp-for="HasSchedule" class="form-check-input" type="checkbox" />
                    <label asp-for="HasSchedule" class="form-check-label">是否設定排程</label>
                </div>

                <!-- 排程區塊：由 VM 的 HasSchedule 控制初始狀態 -->
                <div id="schedule-fields" style="@(Model.HasSchedule ? "" : "display:none;")">
                    <!-- 排程時間 -->
                    <div class="mb-3">
                        <label asp-for="ScheduledDate" class="form-label"></label>
                        <input asp-for="ScheduledDate" class="form-control datepicker" type="text" />
                        <span asp-validation-for="ScheduledDate" class="text-danger"></span>
                    </div>

                    <!-- 排程動作 -->
                    <div class="mb-3">
                        <label asp-for="ActionType" class="form-label"></label>
                        <select asp-for="ActionType" asp-items="ViewBag.ActionTypeList" class="form-select"></select>
                        <span asp-validation-for="ActionType" class="text-danger"></span>
                    </div>
                </div>

                <!-- 最後修改時間 -->
                <div class="mb-3">
                    <label asp-for="RevisedDate" class="form-label">最後修改時間</label>
                    <input asp-for="RevisedDate"
                           class="form-control"
                           readonly />
                </div>

            <!-- 🔑 保留查詢狀態 -->
            <input type="hidden" asp-for="Page" />
            <input type="hidden" asp-for="PageSize" />
            <input type="hidden" asp-for="Keyword" />
            <input type="hidden" asp-for="StatusFilter" />
            <hr />
           <!-- 返回 / 儲存（避免 card-footer 灰底） -->
            <div class="d-flex gap-3 mt-4 mb-4">
                <a asp-action="Index" class="btn btn-outline-secondary btn-lg">🔙 返回列表</a>
                <button type="submit" class="btn btn-outline-warning text-dark btn-lg">💾 儲存修改</button>
            </div>
            <hr />
        </form>
        <!-- ⬆️ 回頂部 -->
        <button onclick="scrollToTop()" id="btnTop"
                class="btn rounded-circle shadow-lg"
                data-bs-toggle="tooltip" data-bs-placement="left" title="回到頂部">
            <i class="bi bi-arrow-up-short fs-2"></i>
        </button>

    </div>
   <!-- 區塊清單 -->
    <h3 class="px-3">內容區塊</h3>
    <div class="px-3 pb-4">
        @await Component.InvokeAsync("PageBlockList", new { pageId = Model.PageId })
    </div>
    <!-- 浮動新增按鈕 -->
    <a asp-area="CNT" asp-controller="PageBlocks" asp-action="Add" asp-route-pageId="@Model.PageId"
       class="btn btn-success rounded-circle shadow-lg fab-btn"
       data-bs-toggle="tooltip" data-bs-placement="left" title="新增內容區塊">
        <i class="bi bi-file-earmark-plus fab-icon"></i>
    </a>
</div>
<!-- ✅ 排序更新 Toast -->
<!-- ✅ 成功提示 -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="successToast"
         class="toast align-items-center text-bg-success border-0"
         role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="2000">
        <div class="d-flex">
            <div class="toast-body">✅ 排序已更新</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    <!-- ❌ 失敗提示 -->
    <div id="errorToast"
         class="toast align-items-center text-bg-danger border-0"
         role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="3000">
        <div class="d-flex">
            <div class="toast-body">❌ 排序更新失敗，請重試</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />   @* 必須先載入 jQuery Validate *@
    <partial name="_Select2ValidationPartial" model="Model.IsHomePage" />  @* 再載入 Select2 驗證邏輯 *@
    <partial name="_BlockListScripts" />
    @await Html.PartialAsync("_FlatpickrScriptsPartial")
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

        <script>
            $(document).ready(function () {
                $('.tag-selector').select2({
                    placeholder: "請選擇標籤",
                    allowClear: true,
                    width: '100%'
                });
            });
        </script>
    <script>
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.addEventListener("scroll", function () {
            let btn = document.getElementById("btnTop");
            if (document.documentElement.scrollTop > 200) {
                btn.classList.add("show");
            } else {
                btn.classList.remove("show");
            }
        });
    </script>  
}

