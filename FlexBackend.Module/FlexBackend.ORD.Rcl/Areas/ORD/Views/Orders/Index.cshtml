@model FlexBackend.ORD.Rcl.Areas.ORD.ViewModels.OrderListVM

@section Styles {
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
    <style>
        td.details-control {
            background: url('https://www.datatables.net/examples/resources/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.shown td.details-control {
            background: url('https://www.datatables.net/examples/resources/details_close.png') no-repeat center center;
        }

        .pagination {
            justify-content: center;
        }

        .order-detail-card {
            background: #f9f9f9;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #ddd;
        }

        .order-summary {
            text-align: right;
            margin-top: 1rem;
        }
    </style>
}

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 text-purple2">訂單清單查詢</h6>
    </div>
    <div class="card-body">
        <!-- 篩選表單 -->
        <form asp-action="Index" method="get" class="row g-2 mb-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">關鍵字</label>
                <input type="text" class="form-control" name="Keyword"
                       placeholder="輸入訂單編號/收件人/電話"
                       value="@Model.SearchParams.Keyword" />
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">訂單狀態</label>
                <select class="form-select" name="OrderStatusId">
                    <option value="">全部</option>
                    @foreach (var option in Model.OrderStatusOptions)
                    {
                        <option value="@option.Value" selected="@(option.Value == Model.SearchParams.OrderStatusId)">
                            @option.Text
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">付款狀態</label>
                <select class="form-select" name="PaymentStatus">
                    <option value="">全部</option>
                    @foreach (var option in Model.PaymentStatusOptions)
                    {
                        <option value="@option.Value" selected="@(option.Value == Model.SearchParams.PaymentStatus)">
                            @option.Text
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">配送狀態</label>
                <select class="form-select" name="ShippingStatusId">
                    <option value="">全部</option>
                    @foreach (var option in Model.ShippingStatusOptions)
                    {
                        <option value="@option.Value" selected="@(option.Value == Model.SearchParams.ShippingStatusId)">
                            @option.Text
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">每頁筆數</label>
                <select class="form-select" name="PageSize">
                    @foreach (var size in Model.Pagination.PageSizeOptions)
                    {
                        <option value="@size" selected="@(size == Model.SearchParams.PageSize)">
                            @size
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-1 d-grid">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary">套用</button>
            </div>
        </form>

        <!-- 分頁資訊 -->
        <div class="mb-3">
            <span>
                第 <strong>@Model.Pagination.CurrentPage</strong> 頁 /
                共 <strong>@Model.Pagination.TotalPages</strong> 頁，
                總筆數 <strong>@Model.Pagination.TotalCount</strong>
            </span>
        </div>

        <!-- 主表格 -->
        <div class="table-responsive">
            <table id="ordersTable" class="table table-bordered table-striped" width="100%">
                <thead>
                    <tr>
                        <th></th>
                        <th>訂單編號</th>
                        <th>會員姓名</th>
                        <th>付款狀態</th>
                        <th>配送狀態</th>
                        <th>訂單狀態</th>
                        <th>總金額</th>
                        <th>建立時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model.Orders)
                    {
                        <tr data-id="@order.OrderId">
                            <td class="details-control"></td>
                            <td>@order.OrderNo</td>
                            <td>@order.UserName</td>
                            <td class="payment-status">@order.PaymentStatusName</td>
                            <td class="shipping-status">@order.ShippingStatusName</td>
                            <td class="order-status">@order.OrderStatusName</td>
                            <td>@order.TotalAmount.ToString("C0")</td>
                            <td>@order.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-edit" data-id="@order.OrderId">編輯</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- 分頁控制 -->
        <nav class="mt-4">
            <ul class="pagination">
                @if (Model.Pagination.HasPreviousPage)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="Index"
                           asp-route-Keyword="@Model.SearchParams.Keyword"
                           asp-route-OrderStatusId="@Model.SearchParams.OrderStatusId"
                           asp-route-PaymentStatus="@Model.SearchParams.PaymentStatus"
                           asp-route-ShippingStatusId="@Model.SearchParams.ShippingStatusId"
                           asp-route-PageNumber="@(Model.Pagination.CurrentPage - 1)"
                           asp-route-PageSize="@Model.SearchParams.PageSize">上一頁</a>
                    </li>
                }
                @foreach (var p in Model.Pagination.PageNumbers)
                {
                    <li class="page-item @(p == Model.Pagination.CurrentPage ? "active" : "")">
                        <a class="page-link" asp-action="Index"
                           asp-route-Keyword="@Model.SearchParams.Keyword"
                           asp-route-OrderStatusId="@Model.SearchParams.OrderStatusId"
                           asp-route-PaymentStatus="@Model.SearchParams.PaymentStatus"
                           asp-route-ShippingStatusId="@Model.SearchParams.ShippingStatusId"
                           asp-route-PageNumber="@p"
                           asp-route-PageSize="@Model.SearchParams.PageSize">@p</a>
                    </li>
                }
                @if (Model.Pagination.HasNextPage)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="Index"
                           asp-route-Keyword="@Model.SearchParams.Keyword"
                           asp-route-OrderStatusId="@Model.SearchParams.OrderStatusId"
                           asp-route-PaymentStatus="@Model.SearchParams.PaymentStatus"
                           asp-route-ShippingStatusId="@Model.SearchParams.ShippingStatusId"
                           asp-route-PageNumber="@(Model.Pagination.CurrentPage + 1)"
                           asp-route-PageSize="@Model.SearchParams.PageSize">下一頁</a>
                    </li>
                }
            </ul>
        </nav>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        // 即點即查訂單詳情
        function format(orderId, callback) {
            $.getJSON('@Url.Action("GetOrderDetails", "Orders")', { orderId: orderId })
                .done(function (data) {
                    if (!data || data.error) {
                        callback('<div class="text-danger">查無訂單資料</div>');
                        return;
                    }

                    let o = data.order;
                    let items = data.items || [];

                    let html = `
                        <div class="order-detail-card">
                            <h6>收件資訊</h6>
                                <p><strong>收件人：</strong>${o.receiverName}</p>
                                <p><strong>電話：</strong>${o.receiverPhone}</p>
                                <p><strong>地址：</strong>${o.receiverAddress}</p>
                                <p><strong>配送方式：</strong>${o.shippingMethod ?? '-'}</p>
                        </div>

                        <h6>商品明細</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>商品</th>
                                    <th>規格</th>
                                    <th>單價</th>
                                    <th>數量</th>
                                    <th>小計</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    items.forEach(function (item) {
                        html += `
                            <tr>
                                <td>${item.productName}</td>
                                <td>${item.skuSpec}</td>
                                <td>${item.unitPrice.toLocaleString()}</td>
                                <td>${item.qty}</td>
                                <td>${item.subtotal.toLocaleString()}</td>
                            </tr>`;
                    });

                    html += `
                            </tbody>
                        </table>

                        <div class="order-summary">
                            <p><strong>優惠券：</strong>${o.couponCode ?? '-'}</p>
                            <p><strong>優惠折扣：</strong>${o.discountTotal?.toLocaleString() ?? 0}</p>
                            <p><strong>運費：</strong>${o.shippingFee.toLocaleString()}</p>
                            <p><strong>總金額：</strong>${o.totalAmount.toLocaleString()}</p>
                        </div>
                    `;

                    callback(html);
                })
                .fail(function () {
                    callback('<div class="text-danger">載入明細失敗</div>');
                });
        }

        $(document).ready(function () {
            var table = $('#ordersTable').DataTable({
                paging: false,
                searching: false,
                ordering: true,
                info: false,
                columnDefs: [{ orderable: false, targets: 0 }]
            });

            $('#ordersTable tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    var orderId = tr.data('id');
                    row.child('<div class="text-muted">載入中...</div>').show();
                    tr.addClass('shown');

                    format(orderId, function (html) {
                        row.child(html).show();
                    });
                }
            });
        });
    </script>
}
