@using FlexBackend.ORD.Rcl.Areas.ORD.ViewModels
@model ReturnListPageVM
@{
    ViewData["Title"] = "售後申請審核";
}

<link rel="stylesheet" href="~/_content/FlexBackend.ORD.Rcl/css/rma.css" asp-append-version="true" />

@section Styles {
    <link rel="stylesheet" href="~/_content/FlexBackend.ORD.Rcl/css/rma.css" asp-append-version="true" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        /* 狀態按鈕樣式 */
        .status-btn {
            border-radius: 20px;
            font-weight: 500;
            padding: 8px 16px;
            margin: 2px;
            border: none;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

            .status-btn.active {
                color: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }

            .status-btn:not(.active) {
                background-color: #f8f9fa;
                color: #6c757d;
                border: 1px solid #dee2e6;
            }

                .status-btn:not(.active):hover {
                    background-color: #e9ecef;
                    color: #495057;
                    text-decoration: none;
                }

        /* 各狀態顏色 */
        .status-all.active {
            background-color: #6c757d;
        }

        .status-pending.active {
            background-color: #ffc107;
            color: #212529 !important;
        }

        .status-review.active {
            background-color: #17a2b8;
        }

        .status-refunding.active {
            background-color: #007bff;
        }

        .status-reshipping.active {
            background-color: #6f42c1;
        }

        .status-done.active {
            background-color: #28a745;
        }

        .status-rejected.active {
            background-color: #dc3545;
        }

        /* 狀態徽章樣式 */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-review {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-refunding {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-reshipping {
            background-color: #e7e3ff;
            color: #4c1d95;
        }

        .status-done {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* DataTable 自定義樣式 */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            display: none;
        }
    </style>
}

@functions {
    // 狀態中文對應
    string GetStatusText(string? status) => (status ?? "").ToLowerInvariant() switch
    {
        "pending" => "待審核",
        "review" => "審核中",
        "refunding" => "退款中",
        "reshipping" => "補寄中",
        "done" => "處理完成",
        "rejected" => "駁回",
        _ => status ?? ""
    };

    // 類型中文對應
    string GetTypeText(string? type) => (type ?? "").ToLowerInvariant() switch
    {
        "refund" => "退款",
        "reship" => "補寄",
        _ => type ?? ""
    };

    // 範圍中文對應
    string GetScopeText(string? scope) => (scope ?? "").ToLowerInvariant() switch
    {
        "order" => "整筆",
        "items" => "品項",
        _ => scope ?? ""
    };

    // 狀態按鈕樣式
    string GetStatusButtonClass(string? status, string currentGroup) =>
        currentGroup == status ? $"status-btn active status-{status}" : $"status-btn status-{status}";

    // 狀態徽章樣式
    string GetStatusBadgeClass(string? status) => $"status-badge status-{(status ?? "").ToLowerInvariant()}";
}

<div class="card my-3">
    <div class="card-header">售後申請審核</div>
    <div class="card-body">

        <!-- 搜尋 / 每頁 -->
        <form method="get" class="row g-2 mb-3">
            <input type="hidden" name="group" value="@Model.Group" />
            <input type="hidden" name="page" value="1" />

            <div class="col-auto">
                <input type="text" name="keyword" value="@Model.Keyword" class="form-control" placeholder="輸入 RMA / 訂單號">
            </div>

            <div class="col-auto">
                <select name="pageSize" class="form-select" onchange="this.form.submit()">
                    @if (Model.PageSize == 10)
                    {
                        <option value="10" selected>10/頁</option>
                    }
                    else
                    {
                        <option value="10">10/頁</option>
                    }
                    @if (Model.PageSize == 25)
                    {
                        <option value="25" selected>25/頁</option>
                    }
                    else
                    {
                        <option value="25">25/頁</option>
                    }
                    @if (Model.PageSize == 50)
                    {
                        <option value="50" selected>50/頁</option>
                    }
                    else
                    {
                        <option value="50">50/頁</option>
                    }
                    @if (Model.PageSize == 100)
                    {
                        <option value="100" selected>100/頁</option>
                    }
                    else
                    {
                        <option value="100">100/頁</option>
                    }
                </select>
            </div>

            <div class="col-auto">
                <button type="submit" class="btn btn-primary">搜尋</button>
            </div>
        </form>

        <!-- 狀態群組 Tabs -->
        <div class="mb-3">
            @{
                var statusMapping = new Dictionary<string, string>
                        {
                        { "all", "全部" },
                        { "pending", "待審核" },
                        { "review", "審核中" },
                        { "refunding", "退款中" },
                        { "reshipping", "補寄中" },
                        { "done", "處理完成" },
                        { "rejected", "駁回" }
                        };
            }

            @foreach (var tab in Model.Tabs)
            {
                var statusText = statusMapping.ContainsKey(tab.Key) ? statusMapping[tab.Key] : tab.Key;
                <a class="@GetStatusButtonClass(tab.Key, Model.Group)"
                   href="@Url.Action("Index", new { group = tab.Key, page = 1, pageSize = Model.PageSize, keyword = Model.Keyword })">
                    @statusText (@tab.Value)
                </a>
            }
        </div>

        <!-- 列表 -->
        <table id="rmaTable" class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:80px">#</th>
                    <th>RMA</th>
                    <th>訂單號</th>
                    <th>類型</th>
                    <th>範圍</th>
                    <th>狀態</th>
                    <th>建立時間</th>
                    <th style="width:260px">操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.RmaList)
                {
                    <tr>
                        <td><a href="javascript:void(0)" onclick="openRmaDetail(@r.ReturnRequestId)">#@r.ReturnRequestId</a></td>
                        <td>@r.RmaNo</td>
                        <td>@r.OrderNo</td>
                        <td>@GetTypeText(r.TypeName)</td>
                        <td>@GetScopeText(r.ScopeName)</td>
                        <td><span class="@GetStatusBadgeClass(r.StatusName)">@GetStatusText(r.StatusName)</span></td>
                        <td>@r.CreatedDate.ToString("yyyy/MM/dd HH:mm")</td>
                        <td>
                            @if ((r.StatusName ?? "").ToLower() is "pending" or "review")
                            {
                                <button class="btn-rma btn-rma-blue   me-1" onclick="approveRefund(@r.ReturnRequestId)">批准退款</button>
                                <button class="btn-rma btn-rma-yellow me-1" onclick="approveReship(@r.ReturnRequestId)">批准補寄</button>
                                <button class="btn-rma btn-rma-red" onclick="rejectRma(@r.ReturnRequestId)">駁回</button>
                            }
                            else if ((r.StatusName ?? "").ToLower() is "refunding" or "reshipping")
                            {
                                <button class="btn-rma btn-rma-gray" onclick="completeRma(@r.ReturnRequestId)">結單</button>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- 分頁 -->
        <nav>
            <ul class="pagination">
                @for (int i = 1; i <= Model.Pages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { group = Model.Group, page = i, pageSize = Model.PageSize, keyword = Model.Keyword })">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>

        <div>總筆數 @Model.Total</div>
    </div>
</div>

<!-- 明細 Modal -->
<partial name="_RmaDetails" />

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="~/_content/FlexBackend.ORD.Rcl/js/rma.js" asp-append-version="true"></script>

    <script>
        // DataTable 初始化
        $(document).ready(function() {
            $('#rmaTable').DataTable({
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.11.5/i18n/zh-HANT.json"
                },
                "order": [[ 6, "desc" ]], // 依建立時間降序排列
                "pageLength": @Model.PageSize,
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "searching": false, // 關閉 DataTable 內建搜尋，使用上方的搜尋框
                "paging": false, // 關閉 DataTable 分頁，使用自定義分頁
                "info": false, // 關閉資訊顯示
                "columnDefs": [
                    { "orderable": false, "targets": [0, 7] }, // #欄位和操作欄位不可排序
                    { "type": "date", "targets": 6 } // 建立時間欄位設定為日期類型
                ]
            });
        });

        // RMA Modal 相關變數
        let currentRmaId = 0;

        // 開啟 RMA 明細 Modal
        function openRmaDetail(id) {
            currentRmaId = id;

            $.ajax({
                url: '/ORD/Rma/GetReturnDetail',
                type: 'GET',
                data: { id: id },
                success: function(response) {
                    if (response.ok) {
                        const rma = response.rma;

                        // 填入基本資訊
                        $('#statusName').text(rma.statusName).attr('class', 'badge bg-info');
                        $('#createdDate').text(rma.createdDate);
                        $('#reasonText').text(rma.reasonText);

                        console.log('RMA 資料:', rma); // 除錯用
                        console.log('狀態名稱:', rma.statusName); // 除錯用
                        console.log('原始狀態:', rma.originalStatus); // 除錯用

                        // 填入訂單摘要
                        $('#coupon').text(rma.orderSummary.coupon);
                        $('#discount').text('$' + rma.orderSummary.discount);
                        $('#shippingFee').text('$' + rma.orderSummary.shippingFee);
                        $('#orderTotal').text('$' + rma.orderSummary.total);

                        // 填入訂單品項
                        let orderItemsHtml = '';
                        rma.orderItems.forEach(function(item) {
                            orderItemsHtml += `
                                <tr>
                                    <td>${item.productName}</td>
                                    <td>${item.skuSpec}</td>
                                    <td>$${item.unitPrice}</td>
                                    <td>${item.qty}</td>
                                    <td>$${item.subTotal}</td>
                                </tr>
                            `;
                        });
                        $('#orderItemsBody').html(orderItemsHtml);

                        // 填入 RMA 品項
                        let rmaItemsHtml = '';
                        rma.rmaItems.forEach(function(item) {
                            rmaItemsHtml += `
                                <tr>
                                    <td>${item.productName}</td>
                                    <td>${item.skuSpec}</td>
                                    <td>${item.originalQty}</td>
                                    <td>${item.qty}</td>
                                    <td>${item.approvedQty}</td>
                                    <td>${item.refundQty}</td>
                                    <td>${item.reshipQty}</td>
                                    <td>$${item.refundUnitAmount}</td>
                                </tr>
                            `;
                        });
                        $('#rmaItemsBody').html(rmaItemsHtml);

                        // 根據狀態顯示對應按鈕
                        updateModalButtons(rma.statusName);

                        // 測試按鈕是否存在
                        console.log('按鈕檢查:');
                        console.log('批准退款按鈕:', $('#btnApproveRefund').length);
                        console.log('批准補寄按鈕:', $('#btnApproveReship').length);
                        console.log('駁回按鈕:', $('#btnReject').length);
                        console.log('結單按鈕:', $('#btnComplete').length);

                        // 顯示 Modal
                        $('#rmaDetailModal').modal('show');
                    } else {
                        Swal.fire('錯誤', response.message, 'error');
                    }
                },
                error: function() {
                    Swal.fire('錯誤', '載入明細失敗', 'error');
                }
            });
        }

        // 更新 Modal 按鈕顯示
        function updateModalButtons(statusName) {
            console.log('Modal 狀態:', statusName); // 除錯用

            // 先隱藏所有按鈕
            $('#btnApproveRefund').hide();
            $('#btnApproveReship').hide();
            $('#btnReject').hide();
            $('#btnComplete').hide();

            // 根據狀態顯示對應按鈕
            // 待審核狀態：顯示三個按鈕（批准退款、批准補寄、駁回）
            if (statusName === '待審核' || statusName === '審核中' || statusName === 'pending' || statusName === 'review') {
                $('#btnApproveRefund').show();
                $('#btnApproveReship').show();
                $('#btnReject').show();
                console.log('顯示審核按鈕');
            }
            // 已審核狀態：只顯示結單按鈕
            else if (statusName === '退款中' || statusName === '補寄中' || statusName === 'refunding' || statusName === 'reshipping') {
                $('#btnComplete').show();
                console.log('顯示結單按鈕');
            }
            // 完成或駁回狀態：不顯示任何操作按鈕
            else if (statusName === '處理完成' || statusName === '駁回' || statusName === 'done' || statusName === 'rejected') {
                console.log('無操作按鈕');
            }
        }

        // Modal 中的按鈕事件
        $('#btnApproveRefund').click(function() {
            approveRefundModal(currentRmaId);
        });

        $('#btnApproveReship').click(function() {
            approveReshipModal(currentRmaId);
        });

        $('#btnReject').click(function() {
            rejectRmaModal(currentRmaId);
        });

        $('#btnComplete').click(function() {
            completeRmaModal(currentRmaId);
        });

        // Modal 版本的操作函式
        function approveRefundModal(id) {
            Swal.fire({
                title: '確認批准退款？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Approve', { id: id, nextStatus: 'refunding' }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                $('#rmaDetailModal').modal('hide');
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        function approveReshipModal(id) {
            Swal.fire({
                title: '確認批准補寄？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Approve', { id: id, nextStatus: 'reshipping' }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                $('#rmaDetailModal').modal('hide');
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        function rejectRmaModal(id) {
            Swal.fire({
                title: '駁回原因',
                input: 'textarea',
                inputPlaceholder: '請輸入駁回原因...',
                showCancelButton: true,
                confirmButtonText: '確定駁回',
                cancelButtonText: '取消',
                inputValidator: (value) => {
                    if (!value) {
                        return '請輸入駁回原因';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Reject', { id: id, reason: result.value }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                $('#rmaDetailModal').modal('hide');
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        function completeRmaModal(id) {
            Swal.fire({
                title: '確認結單？',
                text: '結單後將無法再修改',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '確定結單',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Complete', { id: id }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                $('#rmaDetailModal').modal('hide');
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        // 列表頁面的操作函式（保持原有功能）
        function approveRefund(id) {
            Swal.fire({
                title: '確認批准退款？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Approve', { id: id, nextStatus: 'refunding' }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        function approveReship(id) {
            Swal.fire({
                title: '確認批准補寄？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Approve', { id: id, nextStatus: 'reshipping' }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        function rejectRma(id) {
            Swal.fire({
                title: '駁回原因',
                input: 'textarea',
                inputPlaceholder: '請輸入駁回原因...',
                showCancelButton: true,
                confirmButtonText: '確定駁回',
                cancelButtonText: '取消',
                inputValidator: (value) => {
                    if (!value) {
                        return '請輸入駁回原因';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Reject', { id: id, reason: result.value }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }

        function completeRma(id) {
            Swal.fire({
                title: '確認結單？',
                text: '結單後將無法再修改',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '確定結單',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/ORD/Rma/Complete', { id: id }, function(response) {
                        if (response.ok) {
                            Swal.fire('成功', response.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('錯誤', response.message, 'error');
                        }
                    });
                }
            });
        }
    </script>
}