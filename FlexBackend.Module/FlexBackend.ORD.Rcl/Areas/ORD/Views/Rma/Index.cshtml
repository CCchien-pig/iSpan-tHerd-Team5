@using FlexBackend.ORD.Rcl.Areas.ORD.ViewModels
@model ReturnListPageVM
@{
    ViewData["Title"] = "售後申請審核";
}

<link rel="stylesheet" href="~/_content/FlexBackend.ORD.Rcl/css/rma.css" asp-append-version="true" />

@section Styles {
    <link rel="stylesheet" href="~/_content/FlexBackend.ORD.Rcl/css/rma.css" asp-append-version="true" />
}

@functions {
    // 狀態徽章樣式
    string BadgeClass(string? s) => (s ?? "").ToLowerInvariant() switch
    {
        "pending" => "badge-rma badge-rma-pending",
        "review" => "badge-rma badge-rma-review",
        "refunding" => "badge-rma badge-rma-refunding",
        "reshipping" => "badge-rma badge-rma-reshipping",
        "done" => "badge-rma badge-rma-done",
        "rejected" => "badge-rma badge-rma-rejected",
        _ => "badge bg-secondary"
    };
}

<div class="card my-3">
    <div class="card-header">售後申請審核</div>
    <div class="card-body">

        <!-- 搜尋 / 每頁 -->
        <form method="get" class="row g-2 mb-3">
            <input type="hidden" name="group" value="@Model.Group" />
            <input type="hidden" name="page" value="1" />

            <div class="col-auto">
                <input type="text" name="keyword" value="@Model.Keyword" class="form-control" placeholder="輸入 RMA / 訂單號">
            </div>

            <div class="col-auto">
                <select name="pageSize" class="form-select" onchange="this.form.submit()">
                    @* <option> 不放 C#，改用 if/else 產生 *@
                    @if (Model.PageSize == 10)
                    {
                        <option value="10" selected>10/頁</option>
                    }
                    else
                    {
                        <option value="10">10/頁</option>
                    }
                    @if (Model.PageSize == 25)
                    {
                        <option value="25" selected>25/頁</option>
                    }
                    else
                    {
                        <option value="25">25/頁</option>
                    }
                    @if (Model.PageSize == 50)
                    {
                        <option value="50" selected>50/頁</option>
                    }
                    else
                    {
                        <option value="50">50/頁</option>
                    }
                    @if (Model.PageSize == 100)
                    {
                        <option value="100" selected>100/頁</option>
                    }
                    else
                    {
                        <option value="100">100/頁</option>
                    }
                </select>
            </div>

            <div class="col-auto">
                <button type="submit" class="btn btn-primary">搜尋</button>
            </div>
        </form>

        <!-- 狀態群組 Tabs -->
        <div class="mb-3">
            @foreach (var tab in Model.Tabs)
            {
                <a class="btn @(Model.Group == tab.Key ? "btn-secondary" : "btn-outline-secondary") me-1"
                   href="@Url.Action("Index", new { group = tab.Key, page = 1, pageSize = Model.PageSize, keyword = Model.Keyword })">
                    @tab.Key (@tab.Value)
                </a>
            }
        </div>

        <!-- 列表 -->
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:80px">#</th>
                    <th>RMA</th>
                    <th>訂單號</th>
                    <th>類型</th>
                    <th>範圍</th>
                    <th>狀態</th>
                    <th>建立時間</th>
                    <th>原因</th>
                    <th>商品</th>
                    <th>規格</th>
                    <th>數量</th>
                    <th style="width:260px">操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.RmaList)
                {
                    <tr>
                        <td><a href="javascript:void(0)" onclick="openRmaDetail(@r.ReturnRequestId)">#@r.ReturnRequestId</a></td>
                        <td>@r.RmaNo</td>
                        <td>@r.OrderNo</td>
                        <td>@r.TypeName</td>
                        <td>@r.ScopeName</td>
                        <td><span class="@BadgeClass(r.StatusName)">@r.StatusName</span></td>
                        <td>@r.CreatedDate.ToString("yyyy/MM/dd HH:mm")</td>
                        <td>@r.Reason</td>
                        <td>@r.ProductName</td>
                        <td>@r.Spec</td>
                        <td>@r.Qty</td>
                        <td>
                            @* 黃藍按鈕樣式 *@
                            @if ((r.StatusName ?? "").ToLower() is "pending" or "review")
                            {
                                <button class="btn-rma btn-rma-blue   me-1" onclick="approveRefund(@r.ReturnRequestId)">批准退款</button>
                                <button class="btn-rma btn-rma-yellow me-1" onclick="approveReship(@r.ReturnRequestId)">批准補寄</button>
                                <button class="btn-rma btn-rma-red" onclick="rejectRma(@r.ReturnRequestId)">駁回</button>
                            }
                            else if ((r.StatusName ?? "").ToLower() is "refunding" or "reshipping")
                            {
                                <button class="btn-rma btn-rma-gray" onclick="completeRma(@r.ReturnRequestId)">結單</button>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- 分頁 -->
        <nav>
            <ul class="pagination">
                @for (int i = 1; i <= Model.Pages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { group = Model.Group, page = i, pageSize = Model.PageSize, keyword = Model.Keyword })">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>

        <div>總筆數 @Model.Total</div>
    </div>
</div>

<!-- 明細 Modal -->
<partial name="_RmaDetails" />

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/_content/FlexBackend.ORD.Rcl/js/rma.js" asp-append-version="true"></script>
}
