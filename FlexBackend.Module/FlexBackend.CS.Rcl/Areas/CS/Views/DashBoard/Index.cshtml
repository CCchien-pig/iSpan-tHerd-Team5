@{
    ViewData["Title"] = "儀表板";
}

<div class="container-fluid">

    <!-- 標題列 + 區間選擇 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">儀表板</h1>
        <div class="d-flex align-items-center">
            <select id="rangeSelect" class="custom-select custom-select-sm mr-2" style="width: 120px">
                <option value="7">最近 7 天</option>
                <option value="30" selected>最近 30 天</option>
                <option value="90">最近 90 天</option>
            </select>
            <a href="javascript:void(0)" id="btnRefresh"
               class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
                <i class="fas fa-sync-alt fa-sm text-white-50"></i> 重新整理
            </a>
        </div>
    </div>

    <!-- 銷售 KPI（只留與銷售有關的四張卡片） -->
    <div class="row">
        <!-- 近區間營收 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">近區間營收</div>
                        <div id="kpi-range-revenue" class="h5 mb-0 font-weight-bold text-gray-800">--</div>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>

        <!-- 訂單數 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">訂單數</div>
                        <div id="kpi-orders" class="h5 mb-0 font-weight-bold text-gray-800">--</div>
                    </div>
                    <i class="fas fa-file-invoice-dollar fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>

        <!-- 售出數量 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">售出數量</div>
                        <div id="kpi-units" class="h5 mb-0 font-weight-bold text-gray-800">--</div>
                    </div>
                    <i class="fas fa-cubes fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>

        <!-- 平均客單價 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">平均客單價</div>
                        <div id="kpi-aov" class="h5 mb-0 font-weight-bold text-gray-800">--</div>
                    </div>
                    <i class="fas fa-hand-holding-usd fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 圖表列：營收折線圖（保留） -->
    <div class="row">
        <div class="col-xl-12 col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">營收概況</h6>
                </div>
                <div class="card-body">
                    <!-- 折線圖（營收 + 訂單數） -->
                    <div class="chart-area"><canvas id="myAreaChart" height="120"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 熱銷 Top + 品類排行 -->
    <div class="row">
        <!-- 熱銷商品表格 -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">熱銷商品 Top 10</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th style="width:70px">排名</th>
                                    <th>商品</th>
                                    <th class="text-right">銷量</th>
                                    <th class="text-right">營收</th>
                                    <th class="text-right">佔比</th>
                                </tr>
                            </thead>
                            <tbody id="tblTopProducts">
                                <!-- 由 JS 動態注入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 品類排行（營收） -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">品類銷售排行（營收）</h6>
                </div>
                <div class="card-body">
                    <canvas id="catBarChart" height="260"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js（v4） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
    // ====== 本地化格式工具 ======
    const fmtMoney = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });
    const fmtInt = new Intl.NumberFormat('zh-TW');
    const fmtDate = d => new Date(d).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });

    // ====== 圖表實例 ======
    let areaChart = null, catBarChart = null;

    // ====== 銷售 KPI（全部來自 /api/cs/dashboard/tops） ======
    function updateSalesKpis(k) {
        document.getElementById('kpi-range-revenue').textContent = fmtMoney.format(k.totalRevenue ?? 0);
        document.getElementById('kpi-orders').textContent        = fmtInt.format(k.totalOrders ?? 0);
        document.getElementById('kpi-units').textContent         = fmtInt.format(k.unitsSold ?? 0);
        document.getElementById('kpi-aov').textContent           = fmtMoney.format(k.aov ?? 0);
    }

    // ====== 折線圖（來自 Overview：labels/net/orders） ======
    function buildAreaChart(labelsISO, net, orders) {
        const ctx = document.getElementById('myAreaChart'); if (!ctx) return;
        if (areaChart) areaChart.destroy();

        const labels = labelsISO.map(fmtDate);
        areaChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: '營收', data: net, fill: true, borderWidth: 2, tension: 0.35 },
                    { label: '訂單數', data: orders, yAxisID: 'y1', borderWidth: 2, borderDash: [6,4], tension: 0.3 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) =>
                                ctx.dataset.label === '營收'
                                    ? `營收：${fmtMoney.format(ctx.parsed.y)}`
                                    : `訂單數：${ctx.parsed.y}`
                        }
                    },
                    legend: { labels: { boxWidth: 12 } }
                },
                scales: {
                    y:  { beginAtZero: true, title: { display: true, text: '金額' },
                          ticks: { callback: v => fmtMoney.format(v) } },
                    y1: { beginAtZero: true, position:'right', grid:{ drawOnChartArea:false },
                          title:{ display:true, text:'筆數' } }
                }
            }
        });
    }

    // ====== 橫向長條（品類營收） ======
    function buildCatBarChart(labels, revenue) {
        const ctx = document.getElementById('catBarChart'); if (!ctx) return;
        if (catBarChart) catBarChart.destroy();

        catBarChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: '營收', data: revenue }] },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                scales: { x: { ticks: { callback: v => fmtMoney.format(v) } } },
                plugins: {
                    tooltip: { callbacks: { label: c => `營收：${fmtMoney.format(c.parsed.x)}` } },
                    legend: { display: false }
                }
            }
        });
    }

    // ====== 熱銷 Top 表格 ======
    function renderTopTable(list) {
        const tbody = document.getElementById('tblTopProducts');
        tbody.innerHTML = '';
        list.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-muted">#${p.rank}</td>
                <td>
                    <div class="d-flex flex-column">
                        <span class="font-weight-bold">${p.name}</span>
                        <small class="text-muted">SKU：${p.sku}　|　分類：${p.category}</small>
                    </div>
                </td>
                <td class="text-right">${fmtInt.format(p.qty)}</td>
                <td class="text-right">${fmtMoney.format(p.revenue)}</td>
                <td class="text-right">${p.share}%</td>`;
            tbody.appendChild(tr);
        });
    }

    // ====== 取數 API ======
    async function fetchOverview(days) {
        // 只拿折線圖資料（不再使用收入來源/任務/待處理）
        const url = '@Url.Content("~/api/cs/dashboard/overview")' + `?days=${encodeURIComponent(days)}`;
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!resp.ok) throw new Error(`Overview HTTP ${resp.status}`);
        return await resp.json();
    }

    async function fetchTops(days, top=10) {
        // 這支提供銷售 KPI、Top 商品與品類排行
        const url = '@Url.Content("~/api/cs/dashboard/tops")' + `?days=${encodeURIComponent(days)}&top=${encodeURIComponent(top)}`;
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!resp.ok) throw new Error(`Tops HTTP ${resp.status}`);
        return await resp.json();
    }

    // ====== 整體刷新 ======
    async function refresh(days = 30) {
        try {
            // 1) 折線圖
            const ov = await fetchOverview(days);
            buildAreaChart(ov.labels, ov.net, ov.orders);

            // 2) 銷售 KPI + 熱銷 + 品類
            const tp = await fetchTops(days, 10);
            updateSalesKpis(tp.kpi);
            renderTopTable(tp.topProducts.map(x => ({
                rank: x.rank, sku: x.sku, name: x.name, category: x.category,
                qty: x.qty, revenue: x.revenue, share: x.share
            })));
            buildCatBarChart(tp.categories.labels, tp.categories.revenue);

        } catch (err) {
            console.error('Dashboard refresh error:', err);
        }
    }

    // ====== 初始化事件 ======
    (function init() {
        refresh(30);
        document.getElementById('rangeSelect').addEventListener('change', e => refresh(parseInt(e.target.value, 10)));
        document.getElementById('btnRefresh').addEventListener('click', () => {
            const days = parseInt(document.getElementById('rangeSelect').value, 10) || 30;
            refresh(days);
        });
    })();
</script>
