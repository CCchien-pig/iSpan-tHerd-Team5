@{
    ViewData["Title"] = "FAQ 管理台";
}

@section Styles {
    <!-- 保持你原本的風格：DataTables × Bootstrap5 + FontAwesome -->
    <link href="//cdn.datatables.net/2.3.3/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="//cdn.datatables.net/fixedheader/4.0.3/css/fixedHeader.bootstrap5.min.css" rel="stylesheet" />
    <link href="~/font-awesome/css/all.min.css" rel="stylesheet" />
    <style>
        .btn-seg .btn {
            min-width: 8rem;
        }

        .tab-pane {
            padding-top: .75rem;
        }

        .table-sm > :not(caption) > * > * {
            padding: .5rem .6rem;
        }

        .table-clean > :not(caption) > * > * {
            border-bottom-color: #eee;
        }

        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: .5rem;
        }

        .switch-wrap {
            gap: .4rem;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
}

<h1 class="h4 mb-3">@ViewData["Title"]</h1>

<!-- 切換鈕 -->
<div class="btn-group btn-seg mb-3" role="group" aria-label="切換">
    <button class="btn btn-primary" data-bs-toggle="tab" data-bs-target="#pane-faq">FAQ 主表</button>
    <button class="btn btn-outline-primary" data-bs-toggle="tab" data-bs-target="#pane-cat">FAQ 分類</button>
    <button class="btn btn-outline-primary" data-bs-toggle="tab" data-bs-target="#pane-kw">FAQ 關鍵字</button>
</div>

<!-- Anti-forgery：供所有 AJAX 使用 -->
<form id="antiForgeryForm" method="post">@Html.AntiForgeryToken()</form>

<!-- 內容分頁：第一次切換時才 AJAX 載入 -->
<div class="tab-content">
    <div class="tab-pane fade show active" id="pane-faq"
         data-url="@Url.Action("IndexPartial", "Faqs", new { area = "CS" })"></div>

    <div class="tab-pane fade" id="pane-cat"
         data-url="@Url.Action("IndexPartial", "FaqCategories", new { area = "CS" })"></div>

    <div class="tab-pane fade" id="pane-kw"
         data-url="@Url.Action("IndexPartial", "FaqKeywords", new { area = "CS" })"></div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="//cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
    <script src="//cdn.datatables.net/2.3.3/js/dataTables.bootstrap5.min.js"></script>
    <script src="//cdn.datatables.net/fixedheader/4.0.3/js/dataTables.fixedHeader.min.js"></script>

    <script>
        (function(){
          const antiToken = $('#antiForgeryForm input[name="__RequestVerificationToken"]').val();

          // 載入指定 pane 的 Partial（只載一次）
          const loadPane = (selector) => {
              const $pane = $(selector);
              if ($pane.data('loaded')) return;
              const url = $pane.data('url');
              $pane.load(url, function(){
                  $pane.data('loaded', true);
                  // 每個 partial 會在根節點放 data-init 屬性告訴要呼叫哪個初始化函數
                  const $init = $pane.find('[data-init]');
                  const fnName = $init.data('init');
                  if (typeof window[fnName] === 'function') window[fnName](antiToken);
              });
          };

          // 進頁先載 FAQ 主表
          loadPane('#pane-faq');

          // 切換分頁時載入
          document.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn=>{
              btn.addEventListener('shown.bs.tab', (e)=>{
                  const pane = e.target.getAttribute('data-bs-target');
                  loadPane(pane);
                  // 同步切換鈕樣式
                  document.querySelectorAll('.btn-seg .btn').forEach(b=>b.classList.replace('btn-primary','btn-outline-primary'));
                  e.target.classList.replace('btn-outline-primary','btn-primary');
              });
          });

          // 提供給 partial 重建 tooltip
          window.__initTooltips = () => {
              document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>{
                  const t = bootstrap.Tooltip.getInstance(el); if (t) t.dispose();
                  new bootstrap.Tooltip(el);
              });
          };
        })();
    </script>
}
