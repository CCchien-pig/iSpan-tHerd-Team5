@model FlexBackend.Infra.Models.CsFaq
@{
    ViewData["Title"] = "編輯 FAQ";
}

@section Styles {
    <!-- Summernote Lite (Bootstrap 5 友善) -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet" />

    <style>
        .page-actions.sticky-top {
            z-index: 1020;
        }

        .card {
            border-radius: 1rem;
        }

        .card-header {
            background: #fff;
            font-weight: 600;
        }

        .form-text {
            color: #6c757d;
        }

        .btn-icon {
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
    </style>
}

<div class="page-actions sticky-top bg-white pt-3 pb-2 mb-3 border-bottom">
    <div class="d-flex align-items-center justify-content-between">
        <h1 class="h4 mb-0">@ViewData["Title"]</h1>
        <div class="btn-group">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left"></i> 返回列表
            </a>
            <button type="submit" form="editForm" class="btn btn-primary">
                <i class="fa-solid fa-floppy-disk"></i> 儲存
            </button>
            <button type="button" id="btnPublish" class="btn btn-success">
                <i class="fa-solid fa-rocket"></i> 儲存並發布
            </button>
        </div>
    </div>
</div>

<form asp-action="Edit"
      asp-route-id="@Model.FaqId"
      method="post"
      id="editForm"
      novalidate>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="FaqId" />
    <input type="hidden" id="publishNow" name="publishNow" value="false" />

    <div class="row g-4">
        <!-- 左：主要內容 -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label asp-for="Title" class="form-label"></label>
                        <input asp-for="Title" class="form-control" maxlength="300" />
                        <div class="form-text">
                            <span id="titleCount">0</span>/300
                        </div>
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">答案內容</label>
                        <!-- Summernote 綁這個 textarea -->
                        <textarea asp-for="AnswerHtml" id="answerEditor" class="form-control"></textarea>
                        <span asp-validation-for="AnswerHtml" class="text-danger"></span>
                    </div>
                    <div class="small text-muted">可使用粗體、連結、清單等格式；儲存時會以 HTML 存入。</div>
                </div>
            </div>
        </div>

        <!-- 右：設定/中繼資訊 -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header">顯示與分類</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label asp-for="CategoryId" class="form-label"></label>
                        <select asp-for="CategoryId"
                                asp-items="@(ViewBag.CategoryId as SelectList)"
                                class="form-select"></select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="OrderSeq" class="form-label"></label>
                        <input asp-for="OrderSeq" type="number" min="0" class="form-control" />
                        <span asp-validation-for="OrderSeq" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" asp-for="IsActive" />
                            <label class="form-check-label" asp-for="IsActive"></label>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label asp-for="LastPublishedTime" class="form-label"></label>
                        <div class="input-group">
                            <input asp-for="LastPublishedTime"
                                   type="datetime-local"
                                   asp-format="{0:yyyy-MM-ddTHH:mm}"
                                   class="form-control" />
                            <button class="btn btn-outline-secondary" type="button" id="btnNow">現在</button>
                        </div>
                        <div class="form-text">留空代表未發布；或按「現在」。</div>
                        <span asp-validation-for="LastPublishedTime" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">系統資訊</div>
                <div class="card-body small text-muted">
                    <div class="mb-1"><i class="fa-regular fa-calendar-plus me-1"></i> 建立：@Model.CreatedDate.ToString("yyyy/MM/dd HH:mm")</div>
                    <div><i class="fa-regular fa-clock me-1"></i> 最近異動：@(Model.RevisedDate?.ToString("yyyy/MM/dd HH:mm") ?? "-")</div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <!-- jQuery / Bootstrap / SweetAlert2 / Summernote -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

    <script>
        $(function () {
            // 標題計數
            const $title = $('[name="Title"]');
            const updateCount = () => $('#titleCount').text(($title.val() || '').length);
            $title.on('input', updateCount); updateCount();

            // Summernote
            $('#answerEditor').summernote({
                placeholder: '輸入 FAQ 的解答內容…',
                height: 280,
                toolbar: [
                    ['style', ['bold','italic','underline','clear']],
                    ['para', ['ul','ol','paragraph']],
                    ['insert', ['link']],
                    ['view', ['codeview']]
                ]
            });

            // 「現在」按鈕 → 填入當前時間（local）
            $('#btnNow').on('click', function () {
                const now = new Date();
                const pad = n => String(n).padStart(2,'0');
                const v = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
                $('[name="LastPublishedTime"]').val(v);
            });

            // 儲存並發布：設旗標並提交
            $('#btnPublish').on('click', function () {
                $('#publishNow').val('true');
                $('#editForm').trigger('submit');
            });

            // Submit 前把 Summernote 內容寫回 textarea（保險）
            $('#editForm').on('submit', function () {
                const html = $('#answerEditor').summernote('code');
                $('#answerEditor').val(html);
            });
        });
    </script>
}
