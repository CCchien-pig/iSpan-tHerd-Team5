@model FlexBackend.CS.Rcl.Areas.CS.ViewModels.FaqEditVM
@{
    ViewData["Title"] = "編輯 FAQ";

    var back = ViewBag.ReturnUrl as string;
    var fallback = Url.Action("Index", "Faqs", new { area = "CS" });
    var goBackUrl = (!string.IsNullOrWhiteSpace(back) && Url.IsLocalUrl(back)) ? back : fallback;
}


@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet" />
    <style>
        .page-actions.sticky-top {
            z-index: 1020;
        }

        .card {
            border-radius: 1rem;
        }

        .card-header {
            background: #fff;
            font-weight: 600;
        }

        .form-text {
            color: #6c757d;
        }

        .btn-icon {
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        :root {
            --cat-bg: #f3e8ff;
            --cat-bd: #e9d5ff;
            --cat-fg: #6d28d9;
        }

        .badge-category {
            display: inline-block;
            padding: .28rem .5rem;
            font-size: .85rem;
            font-weight: 600;
            color: var(--cat-fg);
            background: var(--cat-bg);
            border: 1px solid var(--cat-bd);
            border-radius: .3rem;
            line-height: 1.1;
        }
    </style>
}

<div class="page-actions sticky-top bg-white pt-3 pb-2 mb-3 border-bottom">
    <div class="d-flex align-items-center justify-content-between">
        <h1 class="h4 mb-0">@ViewData["Title"]</h1>
        <div class="btn-group">
            <!-- 這裡原本是 asp-action="Index"，改成用 goBackUrl -->
            <a class="btn btn-outline-secondary" href="@goBackUrl">
                <i class="fa-solid fa-arrow-left"></i> 返回列表
            </a>
            <button type="submit" form="faqForm" class="btn btn-primary">
                <i class="fa-solid fa-floppy-disk"></i> 儲存
            </button>
        </div>
    </div>
</div>

<form id="faqForm" asp-action="EditAjax" asp-route-id="@Model.FaqId" method="post">
    @Html.AntiForgeryToken()

    <!-- 關鍵：把 goBackUrl 帶回 Controller 的 returnUrl -->
    <input type="hidden" name="returnUrl" value="@goBackUrl" />

    <!-- 帶回 Controller 的 returnUrl（方式 1：hidden 欄位） -->
    <input type="hidden" asp-for="FaqId" />

  
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label class="form-label">標題</label>
                        <input asp-for="Title" class="form-control" maxlength="300" />
                        <div class="form-text"><span id="titleCount">0</span>/300</div>
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">答案內容</label>
                        <textarea asp-for="AnswerHtml" id="answerEditor" class="form-control"></textarea>
                        <span asp-validation-for="AnswerHtml" class="text-danger"></span>
                    </div>
                    <div class="small text-muted">可使用粗體、連結、清單等格式；儲存時以 HTML 存入。</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header">顯示與分類</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">分類</label>
                        <select asp-for="CategoryId" asp-items="@(ViewBag.CategoryId as SelectList)" class="form-select"></select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                        
                    </div>
                    <div class="card shadow-sm mb-3">
                        <div class="card-header">關鍵字</div>
                        <div class="card-body">
                            <label class="form-label">關鍵字（用逗號或空白分隔）</label>
                            <input id="kwInput" class="form-control"
                                   value="@(string.Join(", ", Model.Keywords ?? new List<string>()))" />
                            <input type="hidden" name="Keywords" id="kwHidden" />
                            <div class="form-text">例如：免運 運費 折扣碼；會自動去重，最多 50 個。</div>
                        </div>
                    </div>


                    <div class="mb-3">
                        <label class="form-label">排序</label>
                        <input asp-for="OrderSeq" type="number" min="0" class="form-control" />
                        <span asp-validation-for="OrderSeq" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" asp-for="IsActive" />
                            <label class="form-check-label" for="IsActive">啟用</label>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">最近發布時間</label>
                        <div class="input-group">
                            <input asp-for="LastPublishedTime" type="datetime-local" asp-format="{0:yyyy-MM-ddTHH:mm}" class="form-control" />
                            <button class="btn btn-outline-secondary" type="button" id="btnNow">現在</button>
                        </div>
                        <div class="form-text">留空代表未發布；或按「現在」。</div>
                        <span asp-validation-for="LastPublishedTime" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">系統資訊</div>
                <div class="card-body small text-muted">
                    <div class="mb-1"><i class="fa-regular fa-calendar-plus me-1"></i> 建立：@Model.CreatedDate.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</div>
                    <div><i class="fa-regular fa-clock me-1"></i> 最近異動：@(Model.RevisedDate?.ToLocalTime().ToString("yyyy/MM/dd HH:mm") ?? "-")</div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script>
        // ===== 標題字數 =====
        const $title = document.querySelector('[name="Title"]');
        const $titleCount = document.getElementById('titleCount');
        function syncCount(){ $titleCount.textContent = ($title.value || '').length; }
        $title.addEventListener('input', syncCount); syncCount();

        // ===== Summernote =====
        $('#answerEditor').summernote({
            placeholder: '輸入 FAQ 的解答內容…',
            height: 280,
            toolbar: [
                ['style', ['bold','italic','underline','clear']],
                ['para',  ['ul','ol','paragraph']],
                ['insert',['link']],
                ['view',  ['codeview']]
            ]
        });

        // 「現在」按鈕
        document.getElementById('btnNow')?.addEventListener('click', function(){
            const now = new Date();
            const pad = n => String(n).padStart(2,'0');
            const v = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.querySelector('[name="LastPublishedTime"]').value = v;
        });

        // ===== 解析關鍵字成陣列（逗號/空白分隔、去重、最多50）=====
        function parseKeywords() {
            const raw = (document.getElementById('kwInput')?.value || '')
                .split(/[,\s]+/)                // 逗號或空白
                .map(s => s.trim())
                .filter(Boolean);
            const seen = new Set();
            const out = [];
            for (const k of raw) {
                const key = k.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    out.push(k);
                    if (out.length >= 50) break;
                }
            }
            return out;
        }

        // ===== 送出（Ajax）=====
        const form = document.getElementById('faqForm');
        form.addEventListener('submit', async function (e) {
            e.preventDefault(); // 攔截

            // 1) 取回 Summernote HTML → 回填到 textarea
            const html = $('#answerEditor').summernote('code');
            document.getElementById('answerEditor').value = html;

            // 2) 準備 FormData
            const fd = new FormData(form);

            // 3) 同步關鍵字：用多個同名欄位 Keywords
            fd.delete('Keywords');                 // 先清掉可能的 hidden
            for (const kw of parseKeywords()) {
                fd.append('Keywords', kw);         // 關鍵：多筆同名 → 可綁到 List<string>
            }

            try {
                const resp = await fetch(form.action, {
                    method: 'POST',
                    body: fd,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } // 給後端識別 Ajax
                });

                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data.ok) {
                    if (data.redirectUrl) location.href = data.redirectUrl;
                    else alert('已儲存');
                } else {
                    alert(data.message || `發生錯誤（${resp.status}）`);
                }
            } catch (err) {
                console.error(err);
                alert('網路或伺服器發生錯誤。');
            }
        });
    </script>
}


