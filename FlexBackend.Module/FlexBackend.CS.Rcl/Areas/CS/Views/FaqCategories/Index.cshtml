@model IEnumerable<FlexBackend.CS.Rcl.Areas.CS.ViewModels.FaqCategoryListVM>

@{
    ViewData["Title"] = "FAQ分類設定";
}

@section Styles {
    <!-- DataTables × Bootstrap 5 -->
    <link href="https://cdn.datatables.net/2.3.3/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/fixedheader/4.0.3/css/fixedHeader.bootstrap5.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="~/font-awesome/css/all.min.css" rel="stylesheet" />

    <style>
        /* 標題列更清爽 */
        .table thead th {
            background: #f8f9fa;
            font-weight: 600;
            vertical-align: middle;
        }

        .table-sm > :not(caption) > * > * {
            padding: .55rem .6rem;
        }

        .table-clean > :not(caption) > * > * {
            border-bottom-color: #eee;
        }

        /* 紫色小標章（for FAQ 數量/父類別） */
        :root {
            --vio-bg: #f3e8ff;
            --vio-bd: #e9d5ff;
            --vio-fg: #6d28d9;
        }

        .badge-violet {
            display: inline-block;
            padding: .25rem .45rem;
            font-size: .82rem;
            font-weight: 600;
            color: var(--vio-fg);
            background: var(--vio-bg);
            border: 1px solid var(--vio-bd);
            border-radius: .35rem;
            line-height: 1.05;
        }

        .text-muted-70 {
            color: rgba(0,0,0,.55);
        }

        .w-70 {
            width: 70px;
        }

        .w-90 {
            width: 90px;
        }

        .w-110 {
            width: 110px;
        }

        .w-140 {
            width: 140px;
        }

        .order-input {
            width: 5rem;
            text-align: center;
        }

        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: .5rem;
        }
    </style>
}

<h1 class="mb-3">@ViewData["Title"]</h1>

<p class="d-flex gap-2">
    <a asp-area="CS" asp-controller="FaqCategories" asp-action="Create" class="btn btn-success">
        <i class="fa-solid fa-plus"></i> 新增分類
    </a>
    <button type="button" id="btnDeleteSelected" class="btn btn-outline-danger" disabled>
        <i class="fa-regular fa-trash-can"></i> 刪除所選
    </button>
</p>

<!-- 供 AJAX 取防偽權杖 -->
<form id="antiForgeryForm" method="post">
    @Html.AntiForgeryToken()
</form>

<table id="catTable" class="table table-sm table-hover table-clean align-middle">
    <thead>
        <tr>
            <th class="text-center" style="width:36px;"><input type="checkbox" id="chkAll" /></th>
            <th>分類名稱</th>
            <th>上層分類</th>
            <th class="text-center w-90">FAQ數</th>
            <th class="text-center w-70">排序</th>
            <th class="text-center w-90">啟用</th>
            <th class="text-center w-140">建立時間</th>
            <th class="text-center w-140">修改時間</th>
            <th class="text-nowrap w-110">操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var c in Model)
        {
            var toggleId = $"toggle-{c.CategoryId}";
            <tr>
                <!-- 勾選 -->
                <td class="text-center">
                    <input type="checkbox" class="js-row-check" value="@c.CategoryId" />
                </td>

                <!-- 名稱 -->
                <td>@c.CategoryName</td>

                <!-- 父分類（無 → 顯示 badge「最上層」） -->
                <td>
                    @if (string.IsNullOrWhiteSpace(c.ParentCategoryName))
                    {
                        <span class="badge-violet" title="無上層">最上層</span>
                    }
                    else
                    {
                        <span class="badge-violet" title="上層分類">@c.ParentCategoryName</span>
                    }
                </td>

                <!-- FAQ 數（啟用/總數） -->
                <td class="text-center">
                    <span class="badge-violet" title="啟用 / 全部">
                        @c.ActiveFaqCount / @c.TotalFaqCount
                    </span>
                </td>

                <!-- 排序（變更即送出） -->
                <td class="text-center">
                    <input type="number"
                           class="form-control form-control-sm order-input js-order-input"
                           value="@c.OrderSeq" min="0"
                           data-id="@c.CategoryId" />
                </td>

                <!-- 啟用 -->
                <td class="text-center">
                    <div class="form-check form-switch m-0 d-inline-flex align-items-center">
                        <input id="@toggleId"
                               class="form-check-input js-toggle-active"
                               type="checkbox"
                               data-id="@c.CategoryId"
                               @(c.IsActive ? "checked" : "")
                               aria-label="啟用狀態切換" />
                        @* 原本的 label 整段刪掉 *@
                    </div>
                </td>


                <!-- 時間 -->
                <td class="text-center">@c.CreatedDate.ToString("yyyy/MM/dd HH:mm")</td>
                <td class="text-center">@((c.RevisedDate)?.ToString("yyyy/MM/dd HH:mm"))</td>

                <!-- 操作 -->
                <td class="text-nowrap">
                    <div class="btn-group" role="group">
                        <a asp-area="CS" asp-controller="FaqCategories" asp-action="Edit" asp-route-id="@c.CategoryId"
                           class="btn btn-outline-primary btn-icon" data-bs-toggle="tooltip" title="編輯">
                            <i class="fa-solid fa-pen"></i>
                        </a>
                        <a asp-area="CS" asp-controller="FaqCategories" asp-action="Details" asp-route-id="@c.CategoryId"
                           class="btn btn-outline-secondary btn-icon" data-bs-toggle="tooltip" title="檢視">
                            <i class="fa-regular fa-eye"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-icon js-delete-btn"
                                data-id="@c.CategoryId" data-title="@c.CategoryName"
                                data-bs-toggle="tooltip" title="刪除">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

@{
    var toggleUrl = Url.Action("ToggleActive", "FaqCategories", new { area = "CS" });
    var updateOrderUrl = Url.Action("UpdateOrder", "FaqCategories", new { area = "CS" });
    var deleteUrl = Url.Action("DeleteAjax", "FaqCategories", new { area = "CS" });
    var deleteManyUrl = Url.Action("DeleteManyAjax", "FaqCategories", new { area = "CS" });
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- DataTables × Bootstrap 5 -->
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/4.0.3/js/dataTables.fixedHeader.min.js"></script>

    <script>
        $(function () {
            const antiToken = $('#antiForgeryForm input[name="__RequestVerificationToken"]').val();

            // DataTables
            const table = new DataTable('#catTable', {
                fixedHeader: true,
                processing: true,
                layout: {
                    topStart: 'pageLength',
                    topEnd: 'search',
                    bottomStart: 'info',
                    bottomEnd: 'paging'
                },
                paging: true,
                searching: true,
                ordering: true,
                responsive: true,
                language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" },
                columnDefs: [
                    { targets: 0, orderable: false, searchable: false, className: "text-center", width: 36 },
                    { targets: 3, className: "text-center" },      // FAQ 數
                    { targets: 4, orderable: false, searchable: false, className: "text-center" }, // 排序輸入框
                    { targets: 5, orderable: false, searchable: false, className: "text-center" }, // 開關
                    { targets: 6, className: "text-center" },
                    { targets: 7, className: "text-center" },
                    { targets: -1, orderable: false, searchable: false, className: "text-nowrap", width: 120 }
                ],
                order: [[4, 'asc'], [1, 'asc']]
            });

            // Tooltip
            const initTooltips = () => {
                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                    const t = bootstrap.Tooltip.getInstance(el);
                    if (t) t.dispose();
                    new bootstrap.Tooltip(el);
                });
            };
            initTooltips();
            table.on('draw', initTooltips);

            // ===== 啟用切換 =====
            $('#catTable').on('change', '.js-toggle-active', function () {
                const $chk = $(this);
                const id = $chk.data('id');
                const isActive = $chk.is(':checked');
                $chk.prop('disabled', true);

                $.ajax({
                    url: '@toggleUrl',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': antiToken },
                    data: { id, isActive },
                            success: function (res) {
            if (!res || res.ok !== true) {
                $chk.prop('checked', !isActive);
                Swal.fire({ title: '切換失敗', icon: 'error' });
            }
            // 不再更新任何文字
        },

                    },
                    error: function () {
                        $chk.prop('checked', !isActive);
                        Swal.fire({ title: '連線失敗', icon: 'error' });
                    },
                    complete: function () { $chk.prop('disabled', false); }
                });
            });

            // ===== 排序即時儲存（debounce）=====
            let orderTimer = null;
            $('#catTable').on('input', '.js-order-input', function () {
                const $input = $(this);
                clearTimeout(orderTimer);
                orderTimer = setTimeout(() => {
                    const id = $input.data('id');
                    let orderSeq = parseInt($input.val(), 10);
                    if (isNaN(orderSeq) || orderSeq < 0) orderSeq = 0;
                    $input.prop('disabled', true);

                    $.ajax({
                        url: '@updateOrderUrl',
                        type: 'POST',
                        headers: { 'RequestVerificationToken': antiToken },
                        data: { id, orderSeq },
                        success: function (res) {
                            if (!res || res.ok !== true) {
                                Swal.fire({ title: '排序儲存失敗', icon: 'error' });
                            } else {
                                // 可選：重新排序
                                table.order([[4, 'asc'], [1, 'asc']]).draw(false);
                            }
                        },
                        error: function () { Swal.fire({ title: '連線失敗', icon: 'error' }); },
                        complete: function () { $input.prop('disabled', false); }
                    });
                }, 500);
            });

            // ===== 單筆刪除（SweetAlert2）=====
            $('#catTable').on('click', '.js-delete-btn', function () {
                const $btn = $(this);
                const id = $btn.data('id');
                const title = $btn.data('title');

                Swal.fire({
                    title: '確定要刪除嗎？',
                    html: `你將刪除 <b>${$('<div>').text(title).html()}</b>。此動作無法復原！`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '是的，刪除',
                    cancelButtonText: '取消',
                    reverseButtons: true,
                    focusCancel: true,
                }).then((r) => {
                    if (!r.isConfirmed) return;

                    $btn.prop('disabled', true);
                    $.ajax({
                        url: '@deleteUrl',
                        type: 'POST',
                        headers: { 'RequestVerificationToken': antiToken },
                        data: { id },
                        success: function (res) {
                            if (res && res.ok === true) {
                                const $tr = $btn.closest('tr');
                                $tr.addClass('table-danger').fadeOut(160, function () {
                                    table.row($tr).remove().draw(false);
                                    Swal.fire({ title: '已刪除', icon: 'success', timer: 1200, showConfirmButton: false });
                                });
                            } else {
                                Swal.fire({ title: '刪除失敗', text: res?.message ?? '請稍後再試', icon: 'error' });
                            }
                        },
                        error: function () { Swal.fire({ title: '連線失敗', icon: 'error' }); },
                        complete: function () { $btn.prop('disabled', false); }
                    });
                });
            });

            // ===== 多選：全選/行選/刪除所選 =====
            const $chkAll = $('#chkAll');
            const $btnDeleteSelected = $('#btnDeleteSelected');

            const refreshBulkUI = () => {
                const total = $('#catTable .js-row-check').length;
                const checked = $('#catTable .js-row-check:checked').length;
                $chkAll.prop('checked', total > 0 && checked === total)
                       .prop('indeterminate', checked > 0 && checked < total);
                $btnDeleteSelected.prop('disabled', checked === 0);
            };

            $('#catTable thead').on('change', '#chkAll', function () {
                const checked = $(this).is(':checked');
                $('#catTable .js-row-check').prop('checked', checked);
                refreshBulkUI();
            });

            $('#catTable').on('change', '.js-row-check', refreshBulkUI);
            table.on('draw', refreshBulkUI);

            $btnDeleteSelected.on('click', function () {
                const ids = $('#catTable .js-row-check:checked').map(function(){ return $(this).val(); }).get();
                if (ids.length === 0) return;

                Swal.fire({
                    title: '批次刪除',
                    html: `將刪除 <b>${ids.length}</b> 筆分類，確定？`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '是的，刪除',
                    cancelButtonText: '取消',
                    reverseButtons: true
                }).then((r) => {
                    if (!r.isConfirmed) return;

                    $btnDeleteSelected.prop('disabled', true);
                    $.ajax({
                        url: '@deleteManyUrl',
                        type: 'POST',
                        headers: { 'RequestVerificationToken': antiToken },
                        traditional: true,    // ids=1&ids=2…
                        data: { ids: ids },
                        success: function (res) {
                            if (res && res.ok === true) {
                                $('#catTable .js-row-check:checked').each(function(){
                                    const $tr = $(this).closest('tr').addClass('table-danger');
                                    $tr.fadeOut(140, function(){ table.row($tr).remove().draw(false); });
                                });
                                Swal.fire({ title:'已刪除', icon:'success', timer:1200, showConfirmButton:false });
                            } else {
                                Swal.fire({ title:'刪除失敗', text: res?.message ?? '請稍後再試', icon:'error' });
                            }
                        },
                        error: function(){ Swal.fire({ title:'連線失敗', icon:'error' }); },
                        complete: function(){ refreshBulkUI(); }
                    });
                });
            });
        });
    </script>
}
