@model IEnumerable<FlexBackend.Infra.Models.CsFaqCategory>
<div data-init="initCatTable"></div>

<p class="d-flex gap-2 mb-2">
    <a asp-action="Create" asp-controller="FaqCategories" class="btn btn.success">
        <i class="fa-solid fa-plus"></i> 新增分類
    </a>
    <button type="button" id="btnCatDeleteSelected" class="btn btn-outline-danger" disabled>
        <i class="fa-regular fa-trash-can"></i> 刪除所選
    </button>
</p>

<table id="catTable" class="table table-sm table-hover table-clean align-middle w-100">
    <thead>
        <tr>
            <th class="text-center" style="width:36px;"><input type="checkbox" id="catChkAll" /></th>
            <th>分類名稱</th>
            <th>排序</th>
            <th>啟用</th>
            <th>建立</th>
            <th>異動</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var c in Model)
        {
            var tid = $"cat-toggle-{c.CategoryId}";
            <tr>
                <td class="text-center"><input type="checkbox" class="js-cat-check" value="@c.CategoryId" /></td>
                <td>@c.CategoryName</td>
                <td>@c.OrderSeq</td>
                <td class="text-center">
                    <div class="form-check form-switch m-0 d-inline-flex align-items-center switch-wrap">
                        <input id="@tid" class="form-check-input js-cat-active" type="checkbox"
                               data-id="@c.CategoryId" @(c.IsActive ? "checked" : "") />
                        <label class="form-check-label" for="@tid">@(c.IsActive ? "啟用" : "停用")</label>
                    </div>
                </td>
                <td>@c.CreatedDate.ToString("yyyy/MM/dd HH:mm")</td>
                <td>@(c.RevisedDate?.ToString("yyyy/MM/dd HH:mm"))</td>
                <td class="text-nowrap">
                    <div class="btn-group" role="group">
                        <a asp-action="Edit" asp-controller="FaqCategories" asp-route-id="@c.CategoryId"
                           class="btn btn-outline-primary btn-icon" title="編輯" data-bs-toggle="tooltip"><i class="fa-solid fa-pen"></i></a>
                        <button type="button" class="btn btn-outline-danger btn-icon js-cat-del"
                                data-id="@c.CategoryId" data-title="@c.CategoryName" title="刪除" data-bs-toggle="tooltip">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    window.initCatTable = function(antiToken){
        const table = new DataTable('#catTable', {
            fixedHeader:true,
            layout:{ topStart:'pageLength', topEnd:'search', bottomStart:'info', bottomEnd:'paging' },
            language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" },
            columnDefs:[
                {targets:0, orderable:false, searchable:false, className:'text-center'},
                {targets:3, orderable:false, searchable:false, className:'text-center'},
                {targets:-1, orderable:false, searchable:false, className:'text-nowrap'}
            ]
        });
        __initTooltips?.();

        // 開關
        $('#catTable').on('change','.js-cat-active', function(){
            const $chk=$(this), id=$chk.data('id'), isActive=$chk.is(':checked');
            $chk.prop('disabled', true);
            $.ajax({
                url:'@Url.Action("ToggleActive", "FaqCategories", new { area = "CS" })',
                type:'POST', headers:{'RequestVerificationToken':antiToken}, data:{id, isActive},
                success:res=>{
                    if(!res || res.ok!==true){ $chk.prop('checked',!isActive); Swal.fire({title:'切換失敗',icon:'error'}); }
                    else $chk.closest('.form-switch').find('label').text(isActive?'啟用':'停用');
                }, error:()=>{ $chk.prop('checked',!isActive); Swal.fire({title:'連線失敗',icon:'error'}); },
                complete:()=> $chk.prop('disabled', false)
            });
        });

        // 單刪
        $('#catTable').on('click','.js-cat-del', function(){
            const $btn=$(this), id=$btn.data('id'), title=$btn.data('title');
            Swal.fire({title:'確定刪除分類？', html:`<b>${$('<div>').text(title).html()}</b>`, icon:'warning',
                showCancelButton:true, confirmButtonText:'刪除', cancelButtonText:'取消'
            }).then(r=>{
                if(!r.isConfirmed) return;
                $.ajax({
                    url:'@Url.Action("DeleteAjax", "FaqCategories", new { area = "CS" })',
                    type:'POST', headers:{'RequestVerificationToken':antiToken}, data:{id},
                    success:res=>{
                        if(res && res.ok===true){
                            const $tr=$btn.closest('tr').addClass('table-danger');
                            $tr.fadeOut(120, ()=>{ table.row($tr).remove().draw(false); });
                            Swal.fire({title:'已刪除',icon:'success',timer:1200,showConfirmButton:false});
                        }else Swal.fire({title:'刪除失敗',text:res?.message||'請稍後再試',icon:'error'});
                    }, error:()=>Swal.fire({title:'連線失敗',icon:'error'})
                });
            });
        });

        // 多選刪除（與 FAQ 類似，略）
        const $all=$('#catChkAll'), $btn=$('#btnCatDeleteSelected');
        const refresh=()=>{
            const all=$('#catTable .js-cat-check').length, sel=$('#catTable .js-cat-check:checked').length;
            $all.prop('checked', sel===all && all>0).prop('indeterminate', sel>0 && sel<all);
            $btn.prop('disabled', sel===0);
        };
        $('#catTable').on('change','.js-cat-check', refresh);
        $('#catTable thead').on('change','#catChkAll', function(){
            $('#catTable .js-cat-check').prop('checked', $(this).is(':checked')); refresh();
        });
        table.on('draw', refresh);

        $btn.on('click', function(){
            const ids=$('#catTable .js-cat-check:checked').map(function(){return $(this).val();}).get();
            if(ids.length===0) return;
            Swal.fire({title:'批次刪除分類', html:`刪除 <b>${ids.length}</b> 筆？`, icon:'warning',
                showCancelButton:true, confirmButtonText:'刪除', cancelButtonText:'取消'
            }).then(r=>{
                if(!r.isConfirmed) return;
                $.ajax({
                    url:'@Url.Action("DeleteManyAjax", "FaqCategories", new { area = "CS" })',
                    type:'POST', headers:{'RequestVerificationToken':antiToken}, traditional:true, data:{ids},
                    success:res=>{
                        if(res && res.ok===true){
                            $('#catTable .js-cat-check:checked').each(function(){
                                const $tr=$(this).closest('tr').addClass('table-danger');
                                $tr.fadeOut(120, ()=>{ table.row($tr).remove().draw(false); });
                            });
                            Swal.fire({title:'已刪除',icon:'success',timer:1200,showConfirmButton:false});
                        }else Swal.fire({title:'刪除失敗',text:res?.message||'請稍後再試',icon:'error'});
                    }, error:()=>Swal.fire({title:'連線失敗',icon:'error'})
                });
            });
        });
    };
</script>
