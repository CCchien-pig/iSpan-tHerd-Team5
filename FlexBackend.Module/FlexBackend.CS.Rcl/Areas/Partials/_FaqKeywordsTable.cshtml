@model IEnumerable<FlexBackend.Infra.Models.CsFaqKeyword>

<!-- 讓 Index.cshtml 載入後知道要呼叫哪個初始化函數 -->
<div data-init="initKwTable"></div>

<p class="d-flex gap-2 mb-2">
    <a asp-action="Create" asp-controller="FaqKeywords" class="btn btn-success">
        <i class="fa-solid fa-plus"></i> 新增關鍵字
    </a>
    <button type="button" id="btnKwDeleteSelected" class="btn btn-outline-danger" disabled>
        <i class="fa-regular fa-trash-can"></i> 刪除所選
    </button>
</p>

<table id="kwTable" class="table table-sm table-hover table-clean align-middle w-100">
    <thead>
        <tr>
            <th class="text-center" style="width:36px;">
                <input type="checkbox" id="kwChkAll" />
            </th>
            <th>關鍵字</th>
@*          <th>FaqId</th> 若要顯示 FAQ 標題，這欄可改成「FAQ 標題」並在 Controller Include 後用 @k.Faq.Title
 *@         <th>FAQ 標題</th>
            <th>建立</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var k in Model)
        {
            <tr>
                <td class="text-center">
                    <input type="checkbox" class="js-kw-check" value="@k.KeywordId" />
                </td>
                <td>@k.Keyword</td>
                @* <td>@k.FaqId</td> *@
                <td>@k.Faq?.Title</td>
                <td>@k.CreatedDate.ToString("yyyy/MM/dd HH:mm")</td>
                <td class="text-nowrap">
                    <div class="btn-group" role="group">
                        <a asp-action="Edit" asp-controller="FaqKeywords" asp-route-id="@k.KeywordId"
                           class="btn btn-outline-primary btn-icon" title="編輯" data-bs-toggle="tooltip">
                            <i class="fa-solid fa-pen"></i>
                        </a>
                        <a asp-action="Details" asp-controller="FaqKeywords" asp-route-id="@k.KeywordId"
                           class="btn btn-outline-secondary btn-icon" title="檢視" data-bs-toggle="tooltip">
                            <i class="fa-regular fa-eye"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-icon js-kw-del"
                                data-id="@k.KeywordId" data-title="@k.Keyword" title="刪除" data-bs-toggle="tooltip">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    // 由 Index.cshtml 呼叫：window.initKwTable(antiToken)
    window.initKwTable = function(antiToken){
        const table = new DataTable('#kwTable', {
            fixedHeader: true,
            layout: { topStart:'pageLength', topEnd:'search', bottomStart:'info', bottomEnd:'paging' },
            language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" },
            columnDefs: [
                { targets: 0, orderable: false, searchable: false, className: "text-center" }, // 勾選
                { targets: -1, orderable: false, searchable: false, className: "text-nowrap" } // 操作
            ]
        });
        window.__initTooltips?.();

        // 單筆刪除
        $('#kwTable').on('click', '.js-kw-del', function(){
            const $btn = $(this), id = $btn.data('id'), title = $btn.data('title');
            Swal.fire({
                title: '確定要刪除嗎？',
                html: `你將刪除 <b>${$('<div>').text(title).html()}</b>。此動作無法復原！`,
                icon: 'warning', showCancelButton: true,
                confirmButtonText:'是的，刪除', cancelButtonText:'取消'
            }).then(r=>{
                if(!r.isConfirmed) return;
                $.ajax({
                    url: '@Url.Action("DeleteAjax", "FaqKeywords", new { area = "CS" })',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': antiToken },
                    data: { id },
                    success: (res)=>{
                        if(res && res.ok===true){
                            const $tr = $btn.closest('tr').addClass('table-danger');
                            $tr.fadeOut(150, ()=>{ table.row($tr).remove().draw(false); });
                            Swal.fire({ title:'已刪除', icon:'success', timer:1200, showConfirmButton:false });
                        }else{
                            Swal.fire({ title:'刪除失敗', text: res?.message ?? '請稍後再試', icon:'error' });
                        }
                    },
                    error: ()=> Swal.fire({ title:'連線失敗', icon:'error' })
                });
            });
        });

        // 多選：全選/半選 & 刪除所選
        const $all = $('#kwChkAll'), $btn = $('#btnKwDeleteSelected');
        const refresh = ()=>{
            const total = $('#kwTable .js-kw-check').length;
            const checked = $('#kwTable .js-kw-check:checked').length;
            $all.prop('checked', total>0 && checked===total)
                .prop('indeterminate', checked>0 && checked<total);
            $btn.prop('disabled', checked===0);
        };
        $('#kwTable').on('change','.js-kw-check', refresh);
        $('#kwTable thead').on('change','#kwChkAll', function(){
            $('#kwTable .js-kw-check').prop('checked', $(this).is(':checked'));
            refresh();
        });
        table.on('draw', refresh);

        $btn.on('click', function(){
            const ids = $('#kwTable .js-kw-check:checked').map(function(){ return $(this).val(); }).get();
            if(ids.length===0) return;
            Swal.fire({
                title:'批次刪除',
                html:`將刪除 <b>${ids.length}</b> 筆關鍵字，確定？`,
                icon:'warning', showCancelButton:true,
                confirmButtonText:'是的，刪除', cancelButtonText:'取消'
            }).then(r=>{
                if(!r.isConfirmed) return;
                $.ajax({
                    url: '@Url.Action("DeleteManyAjax", "FaqKeywords", new { area = "CS" })',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': antiToken },
                    traditional: true,
                    data: { ids },
                    success: (res)=>{
                        if(res && res.ok===true){
                            $('#kwTable .js-kw-check:checked').each(function(){
                                const $tr = $(this).closest('tr').addClass('table-danger');
                                $tr.fadeOut(120, ()=>{ table.row($tr).remove().draw(false); });
                            });
                            Swal.fire({ title:'已刪除', icon:'success', timer:1200, showConfirmButton:false });
                        }else{
                            Swal.fire({ title:'刪除失敗', text: res?.message ?? '請稍後再試', icon:'error' });
                        }
                    },
                    error: ()=> Swal.fire({ title:'連線失敗', icon:'error' }),
                    complete: refresh
                });
            });
        });
    };
</script>
