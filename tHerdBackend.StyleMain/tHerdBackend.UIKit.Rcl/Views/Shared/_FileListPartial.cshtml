@using tHerdBackend.Core.DTOs
@model List<SysAssetFileDto>

@{
    const string updateApiUrl = "/SYS/Images/UpdateFile";
    const string deleteApiUrl = "/SYS/Images/DeleteFile";
}

@if (Model != null && Model.Any())
{
    <div class="d-flex flex-wrap gap-2">
        @for (int i = 0; i < Model.Count; i++)
        {
            var file = Model[i];
            var fileUrl = !string.IsNullOrWhiteSpace(file.FileUrl) ? file.FileUrl : "/images/no-image.png";
            var alt = !string.IsNullOrWhiteSpace(file.AltText) ? file.AltText : System.IO.Path.GetFileName(fileUrl);

            <div class="img-item position-relative @(file.IsActive ? "" : "inactive")">
                @if (!string.IsNullOrEmpty(file.MimeType) && file.MimeType.StartsWith("video/"))
                {
                    <video src="@fileUrl"
                           class="thumb-clickable img-zoomable"
                           controls
                           muted
                           preload="metadata"
                           poster="/images/video-placeholder.jpg"
                           style="width:100%;height:200px;object-fit:cover;border-radius:6px;"
                           data-bs-toggle="modal"
                           data-bs-target="#imgMetaModal"
                           data-file-id="@file.FileId"
                           data-file-url="@fileUrl"
                           data-alt-text="@alt"
                           data-caption="@file.Caption">
                        您的瀏覽器不支援影片預覽。
                    </video>
                }
                else
                {
                    <img loading="lazy"
                         src="@fileUrl"
                         alt="@alt"
                         class="thumb-clickable img-zoomable"
                         data-bs-toggle="modal"
                         data-bs-target="#imgMetaModal"
                         data-file-id="@file.FileId"
                         data-file-url="@fileUrl"
                         data-alt-text="@alt"
                         data-caption="@file.Caption" />
                }

                <!-- 🔹 關鍵：讓 ASP.NET 在 POST 時能綁定 Images[i].ImgId -->
                <input type="hidden" name="Images[@i].ImgId" value="@file.FileId" />

                <input type="hidden" name="ImgId" value="@file.FileId" />

                <!-- 🔹 Delete -->
                <button type="button"
                        class="btn-close-custom"
                        aria-label="Close"
                        onclick="deleteFile(@file.FileId, this)">
                    <i class="bi bi-x-lg"></i>
                </button>

                <!-- 🔹 Toggle Active -->
                <button type="button"
                        class="toggle-active-btn btn btn-sm"
                        onclick="toggleActive(this)">
                    @(file.IsActive ? "停用" : "啟用")
                </button>

                <!-- 🔹 Overlay -->
                <div class="disabled-overlay">
                    <i class="bi bi-slash-circle"></i>
                </div>
            </div>
        }
    </div>
}
else
{
    <p class="text-muted">目前沒有圖片。</p>
}