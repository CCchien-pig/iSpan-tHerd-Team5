@using tHerdBackend.Core.DTOs
@using System.Linq
@model List<SysAssetFileDto>

@{
    const string updateApiUrl = "/SYS/Images/UpdateFile";
    const string deleteApiUrl = "/SYS/Images/DeleteFile";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="~/_content/tHerdBackend.UIKit.Rcl/css/update-image.css" asp-append-version="true" />
}

<h2>@ViewData["Title"]</h2>

<!-- 這顆會輸出：上傳按鈕 + Modal -->
@await Component.InvokeAsync("UploadImageModal", new {
moduleId = ViewContext.RouteData.Values["area"],
    progId = ViewContext.RouteData.Values["controller"],
    modalId = "uploadImageModal"
})
@* 
<form asp-action="Index" asp-controller="UploadTest" method="post" enctype="multipart/form-data">
    <div class="d-flex justify-content-end gap-2">
        <a asp-area="SYS" asp-controller="UploadTest" asp-action="Index"
           id="resetBtn"
           class="btn btn-outline-secondary btn-sm d-none">復原更改</a>
        <button type="submit" class="btn btn-success btn-sm">上傳</button>
    </div>

    <div class="mb-3">
        <label class="form-label fw-semibold d-flex align-items-center gap-2">
            <i class="bi bi-lightbulb text-warning"></i>
            上傳位置
        </label>
        <div class="btn-group upload-mode-group" role="group" aria-label="Upload mode">
            <input type="radio" class="btn-check" name="IsExternal" id="modeCloud" value="true" checked>
            <label class="btn btn-upload" for="modeCloud">
                <i class="bi bi-cloud-upload"></i> Cloudinary
            </label>

            <input type="radio" class="btn-check" name="IsExternal" id="modeLocal" value="false">
            <label class="btn btn-upload" for="modeLocal">
                <i class="bi bi-hdd"></i> 本地上傳
            </label>
        </div>
    </div>

    <!-- 預覽區 -->
    <fieldset id="previewArea" class="border rounded p-3 mt-4 d-none">
        <legend class="w-auto px-2">預覽區</legend>
        <div id="preview" class="img-grid"></div>
    </fieldset>

    <!-- 拖拉區塊 -->
    <div id="dropArea" class="border border-2 border-primary rounded p-5 text-center mb-3 bg-light">
        <p class="mb-2">拖拉圖片到這裡，或點擊下方選擇檔案</p>
        <input type="file" id="fileInput" name="Files" class="form-control d-none" multiple />
        <button type="button" id="selectBtn" class="btn btn-outline-primary">選擇圖片</button>
    </div>

    <!-- 隱藏 input 集合 -->
    <div id="hiddenInputs"></div>
    <input type="hidden" name="ModuleId" value="@ViewContext.RouteData.Values["area"]" />
    <input type="hidden" name="ProgId" value="@ViewContext.RouteData.Values["controller"]" />
</form> *@

@if (Model != null && Model.Any())
{
    <div class="img-grid">
        @foreach (var file in Model)
        {
            <div class="img-item position-relative @(file.IsActive ? "" : "inactive")">
                @if (file.MimeType != null && file.MimeType.StartsWith("video/"))
                {
                    <!-- 🎬 影片預覽 -->
                    <video src="@file.FileUrl"
                           class="thumb-clickable img-zoomable"
                           controls
                           muted
                           preload="metadata"
                           style="width:100%;height:200px;object-fit:cover;border-radius:6px;"
                           data-bs-toggle="modal"
                           data-bs-target="#imgMetaModal"
                           data-file-id="@file.FileId"
                           data-file-key="@file.FileKey"
                           data-file-url="@file.FileUrl"
                           data-file-ext="@file.FileExt"
                           data-mime-type="@file.MimeType"
                           data-width="@file.Width"
                           data-height="@file.Height"
                           data-file-size-bytes="@file.FileSizeBytes"
                           data-alt-text="@file.AltText"
                           data-caption="@file.Caption"
                           data-folder-id="@file.FolderId"
                           data-is-active="@file.IsActive.ToString().ToLower()"
                           data-is-external="@file.IsExternal.ToString().ToLower()"
                           data-created-date="@file.FormateCreatedDate"
                           data-update-api="@updateApiUrl"
                           data-delete-api="@deleteApiUrl">
                        您的瀏覽器不支援影片預覽。
                    </video>
                }
                else
                {
                    <!-- 🖼️ 圖片預覽 -->
                    <img src="@file.FileUrl"
                         alt="@file.AltText"
                         class="thumb-clickable img-zoomable"
                         data-bs-toggle="modal"
                         data-bs-target="#imgMetaModal"
                         data-file-id="@file.FileId"
                         data-file-key="@file.FileKey"
                         data-file-url="@file.FileUrl"
                         data-file-ext="@file.FileExt"
                         data-mime-type="@file.MimeType"
                         data-width="@file.Width"
                         data-height="@file.Height"
                         data-file-size-bytes="@file.FileSizeBytes"
                         data-alt-text="@file.AltText"
                         data-caption="@file.Caption"
                         data-folder-id="@file.FolderId"
                         data-is-active="@file.IsActive.ToString().ToLower()"
                         data-is-external="@file.IsExternal.ToString().ToLower()"
                         data-created-date="@file.FormateCreatedDate"
                         data-update-api="@updateApiUrl"
                         data-delete-api="@deleteApiUrl" />
                }

                <!-- 關閉按鈕 -->
                <button type="button" class="btn-close-custom" aria-label="Close" onclick="deleteFile(@file.FileId)">
                    <i class="bi bi-x-lg"></i>
                </button>

                <!-- 啟用／停用按鈕 -->
                <button type="button"
                        class="toggle-active-btn btn btn-sm"
                        onclick="toggleActive(this)">
                    @(file.IsActive ? "停用" : "啟用")
                </button>

                <!-- 停用遮罩 -->
                <div class="disabled-overlay">
                    <i class="bi bi-slash-circle"></i>
                </div>
            </div>
        }
    </div>
}

<!-- 編輯圖片 -->
@await Component.InvokeAsync("UpdateImage", new { 
    modalId = "imgMetaModal",
    title = "圖片資訊",
    file = new SysAssetFileDto(),
    updateApiUrl = updateApiUrl,
    deleteApiUrl = deleteApiUrl
})

@section Scripts {
    @await Html.PartialAsync("/Views/Shared/_SweetAlertPartial.cshtml")

    <script src="~/_content/tHerdBackend.UIKit.Rcl/js/upload-image-modal.js" asp-append-version="true"></script>
    <script src="~/_content/tHerdBackend.UIKit.Rcl/js/update-image.js" asp-append-version="true"></script>

    <script>
        // 初始化這顆上傳視窗的互動
        document.addEventListener("DOMContentLoaded", function () {
            UploadImageModal.init("uploadImageModal");
        });
    </script>
}
