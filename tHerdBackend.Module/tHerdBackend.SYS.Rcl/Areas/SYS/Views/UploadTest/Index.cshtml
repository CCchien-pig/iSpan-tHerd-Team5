@using tHerdBackend.Core.DTOs
@using System.Linq
@model List<SysAssetFileDto>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="~/_content/tHerdBackend.UIKit.Rcl/css/update-image.css" asp-append-version="true" />
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Index" asp-controller="UploadTest" method="post" enctype="multipart/form-data">
    <div class="d-flex justify-content-end gap-2">
        <a asp-area="SYS" asp-controller="UploadTest" asp-action="Index"
           id="resetBtn"
           class="btn btn-outline-secondary btn-sm d-none">復原更改</a>
        <button type="submit" class="btn btn-success btn-sm">上傳</button>
    </div>

    <!-- 預覽區 -->
    <fieldset id="previewArea" class="border rounded p-3 mt-4 d-none">
        <legend class="w-auto px-2">預覽區</legend>
        <div id="preview" class="img-grid"></div>
    </fieldset>

    <!-- 拖拉區塊 -->
    <div id="dropArea" class="border border-2 border-primary rounded p-5 text-center mb-3 bg-light">
        <p class="mb-2">拖拉圖片到這裡，或點擊下方選擇檔案</p>
        <input type="file" id="fileInput" name="Files" class="form-control d-none" multiple />
        <button type="button" id="selectBtn" class="btn btn-outline-primary">選擇圖片</button>
    </div>

    <!-- 隱藏 input 集合 -->
    <div id="hiddenInputs"></div>
</form>

@if (ViewBag.Message != null)
{
    <div class="alert alert-info mt-3">@ViewBag.Message</div>
}

@if (Model != null && Model.Any())
{
    <div class="img-grid">
        @foreach (var file in Model)
        {
            <div class="img-item position-relative @(file.IsActive ? "" : "inactive")">
                <img src="@file.FileUrl"
                     alt="@file.AltText"
                     class="thumb-clickable img-zoomable"
                     data-file-id="@file.FileId"
                     data-alt="@file.AltText"
                     data-caption="@file.Caption"
                     data-is-active="@file.IsActive.ToString().ToLower()" />

                <button type="button" class="btn-close-custom" aria-label="Close" onclick="deleteFile(@file.FileId)">
                    <i class="bi bi-x-lg"></i>
                </button>

                <button type="button"
                        class="toggle-active-btn btn btn-sm"
                        onclick="toggleActive(@file.FileId, this)">
                    @(file.IsActive ? "停用" : "啟用")
                </button>

                <div class="disabled-overlay">
                    <i class="bi bi-slash-circle"></i>
                </div>
            </div>
        }
    </div>
}

<!-- Bootstrap Modal -->
@await Component.InvokeAsync("UpdateImage", new { 
    modalId = "imgMetaModal", 
    title = "圖片資訊", 
    file = new SysAssetFileDto { 
        FileId = 1038, 
        FileUrl = "https://cloudinary.images-iherb.com/image/upload/f_auto,q_auto:eco/images/atn/atn00611/r/97.jpg", 
        AltText = "主圖", 
        Caption = "封面", 
        IsActive = true 
    }
})
<div class="modal fade" id="imgMetaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">圖片資訊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImg"
                     src=""
                     alt=""
                     class="img-fluid mb-3 rounded img-zoomable"
                     style="max-width:600px; max-height:400px; object-fit:contain; cursor: zoom-in;" />

                <div class="mb-3 text-start">
                    <label for="modalAlt" class="form-label">AltText</label>
                    <input type="text" id="modalAlt" class="form-control" />
                </div>
                <div class="mb-3 text-start">
                    <label for="modalCaption" class="form-label">Caption</label>
                    <textarea id="modalCaption" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-check form-switch text-start mb-3">
                    <input class="form-check-input" type="checkbox" id="modalIsActive" />
                    <label class="form-check-label" for="modalIsActive">是否啟用</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" id="confirmMetaBtn" class="btn btn-primary">確定</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("/Views/Shared/_SweetAlertPartial.cshtml")
    <script src="~/_content/tHerdBackend.UIKit.Rcl/js/update-image.js" asp-append-version="true"></script>
}
