@using tHerdBackend.Core.DTOs
@using System.Linq
@model List<SysAssetFileDto>

@{
    const string updateApiUrl = "/SYS/Images/UpdateFile";
    const string deleteApiUrl = "/SYS/Images/DeleteFile";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="~/_content/tHerdBackend.UIKit.Rcl/css/update-image.css" asp-append-version="true" />
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Index" asp-controller="UploadTest" method="post" enctype="multipart/form-data">
    <div class="d-flex justify-content-end gap-2">
        <a asp-area="SYS" asp-controller="UploadTest" asp-action="Index"
           id="resetBtn"
           class="btn btn-outline-secondary btn-sm d-none">復原更改</a>
        <button type="submit" class="btn btn-success btn-sm">上傳</button>
    </div>

    <div class="mb-3">
        <label class="form-label fw-semibold">選擇上傳資料夾</label>
        <div class="d-flex align-items-center gap-2">
            <input type="hidden" id="selectedFolderId" name="FolderId" value="">
            <input type="text" id="selectedFolderName" class="form-control form-control-sm"
                   placeholder="未選擇資料夾" readonly style="width:300px;">
            <button type="button" id="btnSelectFolder" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-folder2-open"></i> 選擇資料夾
            </button>
        </div>
    </div>

    <!-- 預覽區 -->
    <fieldset id="previewArea" class="border rounded p-3 mt-4 d-none">
        <legend class="w-auto px-2">預覽區</legend>
        <div id="preview" class="img-grid"></div>
    </fieldset>

    <!-- 拖拉區塊 -->
    <div id="dropArea" class="border border-2 border-primary rounded p-5 text-center mb-3 bg-light">
        <p class="mb-2">拖拉圖片到這裡，或點擊下方選擇檔案</p>
        <input type="file" id="fileInput" name="Files" class="form-control d-none" multiple />
        <button type="button" id="selectBtn" class="btn btn-outline-primary">選擇圖片</button>
    </div>

    <!-- 隱藏 input 集合 -->
    <div id="hiddenInputs"></div>
</form>

@if (ViewBag.Message != null)
{
    <div class="alert alert-info mt-3">@ViewBag.Message</div>
}

@if (Model != null && Model.Any())
{
    <div class="img-grid">
        @foreach (var file in Model)
        {
            <div class="img-item position-relative @(file.IsActive ? "" : "inactive")">
                <img src="@file.FileUrl"
                     alt="@file.AltText"
                     class="thumb-clickable img-zoomable"
                     data-bs-toggle="modal"
                     data-bs-target="#imgMetaModal"
                     data-file-id="@file.FileId"
                     data-file-key="@file.FileKey"
                     data-file-url="@file.FileUrl"
                     data-file-ext="@file.FileExt"
                     data-mime-type="@file.MimeType"
                     data-width="@file.Width"
                     data-height="@file.Height"
                     data-file-size-bytes="@file.FileSizeBytes"
                     data-alt-text="@file.AltText"
                     data-caption="@file.Caption"
                     data-folder-id="@file.FolderId"
                     data-is-active="@file.IsActive.ToString().ToLower()"
                     data-is-external="@file.IsExternal.ToString().ToLower()"
                     data-created-date="@file.FormateCreatedDate"
                     data-update-api="@updateApiUrl"
                     data-delete-api="@deleteApiUrl" />

                <button type="button" class="btn-close-custom" aria-label="Close" onclick="deleteFile(@file.FileId)">
                    <i class="bi bi-x-lg"></i>
                </button>

                <button type="button"
                        class="toggle-active-btn btn btn-sm"
                        onclick="toggleActive(@file.FileId, this)">
                    @(file.IsActive ? "停用" : "啟用")
                </button>

                <div class="disabled-overlay">
                    <i class="bi bi-slash-circle"></i>
                </div>
            </div>
        }
    </div>
}

<!-- 編輯圖片 -->
@await Component.InvokeAsync("UpdateImage", new { 
    modalId = "imgMetaModal",
    title = "圖片資訊",
    file = new SysAssetFileDto(),
    updateApiUrl = updateApiUrl,
    deleteApiUrl = deleteApiUrl
})

@section Scripts {
    @await Html.PartialAsync("/Views/Shared/_SweetAlertPartial.cshtml")
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

    <script src="~/_content/tHerdBackend.UIKit.Rcl/js/update-image.js" asp-append-version="true"></script>

    <script type="module">
        import { openFolderTreeSelector } from '/_content/tHerdBackend.UIKit.Rcl/js/folder-tree.js';

        document.addEventListener('DOMContentLoaded', () => {
          const btnSelect = document.getElementById('btnSelectFolder');
          const folderIdInput = document.getElementById('selectedFolderId');
          const folderNameInput = document.getElementById('selectedFolderName');

          btnSelect.addEventListener('click', async () => {
            const result = await openFolderTreeSelector({
              title: "選擇上傳資料夾",
              apiUrl: "/SYS/Images/GetTreeData",
              defaultId: folderIdInput.value || null
            });

            // 使用 SweetAlert2 結果格式
            if (!result.isConfirmed) return;

            const selectedId = result.value;
            const selectedNode = $("#swal-tree-container").jstree(true).get_node(selectedId);
            const selectedName = selectedNode?.text || "(未命名)";

            folderIdInput.value = selectedId;
            folderNameInput.value = selectedName;
          });
        });
    </script>
}
