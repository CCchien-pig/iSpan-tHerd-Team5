@* Views/ORD/Rma/_RmaDetail.cshtml *@
<div class="modal fade" id="rmaDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">退貨申請明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h6 class="fw-bold">商品明細</h6>
        <table class="table table-bordered align-middle mb-2">
          <thead class="table-light">
            <tr>
              <th>商品</th>
              <th>規格</th>
              <th class="text-end">單價</th>
              <th class="text-center">數量</th>
              <th class="text-end">小計</th>
            </tr>
          </thead>
          <tbody id="orderItemsBody">
            <tr><td colspan="5" class="text-center text-muted py-3">載入中…</td></tr>
          </tbody>
        </table>

        <div class="text-end mb-3 small">
          優惠券：<span id="coupon">-</span><br />
          優惠折扣：<span id="discount">0</span><br />
          運費：<span id="shippingFee">0</span><br />
          <strong>總金額：<span id="orderTotal">0</span></strong>
        </div>

        <h6 class="fw-bold">退貨申請</h6>
        <div class="mb-2">
          <span class="badge" id="statusName">-</span>
          <span class="ms-2">建立：<span id="createdDate">-</span></span><br />
          <span>原因：<span id="reasonText">-</span></span>
        </div>

        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>商品</th>
              <th>規格</th>
              <th class="text-center">原始數量</th>
              <th class="text-center">申請</th>
              <th class="text-end">退貨單價</th>
            </tr>
          </thead>
          <tbody id="rmaItemsBody">
            <tr><td colspan="5" class="text-center text-muted py-3">載入中…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success"  id="btnApproveRefund">批准退款</button>
        <button type="button" class="btn btn-primary"  id="btnApproveReship">批准補寄</button>
        <button type="button" class="btn btn-danger"   id="btnReject">駁回</button>
        <button type="button" class="btn btn-secondary" id="btnComplete">結單</button>
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
  // ===== Helpers =====
  function nt(num) {
    if (num == null || isNaN(num)) return 'NT$ 0';
    return 'NT$ ' + Number(num).toLocaleString('zh-TW', { maximumFractionDigits: 0 });
  }
  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function badgeClass(status){
    switch((status||'').toLowerCase()){
      case 'pending':   return 'bg-warning text-dark';
      case 'review':    return 'bg-info text-dark';
      case 'refunding':
      case 'reshipping':return 'bg-success';
      case 'done':      return 'bg-secondary';
      case 'rejected':  return 'bg-dark';
      default:          return 'bg-secondary';
    }
  }

  // ===== Public API: 呼叫這個打開 + 載資料 =====
  // 用法：openRmaDetail(1234)
  window.openRmaDetail = function(returnRequestId){
    const $modal = $('#rmaDetailModal');
    // reset UI
    $('#orderItemsBody').html('<tr><td colspan="5" class="text-center text-muted py-3">載入中…</td></tr>');
    $('#rmaItemsBody').html('<tr><td colspan="5" class="text-center text-muted py-3">載入中…</td></tr>');
    $('#coupon').text('-'); $('#discount').text('0'); $('#shippingFee').text('0'); $('#orderTotal').text('0');
    $('#statusName').removeClass().addClass('badge').text('-');
    $('#createdDate').text('-'); $('#reasonText').text('-');

    $modal.modal('show');

    $.getJSON('/ORD/Rma/DetailJson', { id: returnRequestId })
      .done(function(res){
        // ==== 商品明細 ====
        const oi = (res && res.order && Array.isArray(res.order.items)) ? res.order.items : [];
        if(oi.length === 0){
          $('#orderItemsBody').html('<tr><td colspan="5" class="text-center text-muted py-3">沒有項目</td
