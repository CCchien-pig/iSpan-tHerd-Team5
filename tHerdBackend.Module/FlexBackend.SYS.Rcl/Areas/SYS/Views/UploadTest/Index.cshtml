@using FlexBackend.Core.DTOs
@using System.Linq
@model List<SysAssetFileDto>

@{
    ViewData["Title"] = "上傳圖片測試";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        /* === 固定主圖大小 600x400，縮放填滿 === */
        .img-wrapper {
            width: 600px;
            height: 400px;
            overflow: hidden;
            margin: 0 auto; /* 置中 */
        }

        .img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;       /* 填滿後裁切 */
            object-position: center; /* 取中間部分 */
        }

        /* 自訂上下按鈕 */
        .btn-carousel-vertical {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            transition: background 0.3s;
        }
        .btn-carousel-vertical:hover {
            background: rgba(255,255,255,1);
        }
        .btn-carousel-vertical.prev {
            top: -20px; /* 圖片上方 */
        }
        .btn-carousel-vertical.next {
            bottom: -20px; /* 圖片下方 */
        }

        /* 使用 Bootstrap Icons (需引入) */
        .btn-carousel-vertical i {
            font-size: 1.2rem;
            color: #000;
        }

        /* 上下按鈕位置 */
        .carousel-control-prev-vertical,
        .carousel-control-next-vertical {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            height: auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            padding: 8px;
            z-index: 5;
        }
        .carousel-control-prev-vertical {
            top: -40px;  /* 在圖片上方 */
        }
        .carousel-control-next-vertical {
            bottom: -40px; /* 在圖片下方 */
        }

        /* 美化箭頭 */
        .carousel-control-prev-vertical .carousel-control-prev-icon,
        .carousel-control-next-vertical .carousel-control-next-icon {
            background-size: 1.5rem 1.5rem;
            filter: invert(1); /* 白色箭頭 */
        }

        /* === 垂直輪播核心 === */
        .carousel-vertical .carousel-inner {
            height: 420px; /* 比圖片高一點，留空隙 */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .carousel-vertical .carousel-item {
            transition: transform 0.6s ease-in-out;
            height: 400px; /* 固定每一張圖高度 */
            flex: 0 0 auto;
        }

        /* 切換時上下移動 */
        .carousel-vertical .carousel-item-next.carousel-item-start,
        .carousel-vertical .carousel-item-prev.carousel-item-end {
            transform: translateY(0);
        }

        .carousel-vertical .active.carousel-item-start,
        .carousel-vertical .carousel-item-prev {
            transform: translateY(-100%);
        }

        .carousel-vertical .active.carousel-item-end,
        .carousel-vertical .carousel-item-next {
            transform: translateY(100%);
        }

        /* 讓左右箭頭旋轉90度變上下箭頭 */
        .rotate-90 {
            display: inline-block;
            transform: rotate(90deg);
        }

        .thumb-img.active {
            border: 3px solid #007bff;
        }
    </style>
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Index" asp-controller="UploadTest" method="post" enctype="multipart/form-data">
    <!-- 拖拉區塊 -->
    <div id="dropArea" class="border border-2 border-primary rounded p-5 text-center mb-3 bg-light">
        <p class="mb-2">拖拉圖片到這裡，或點擊下方選擇檔案</p>
        <input type="file" id="fileInput" class="form-control d-none" multiple />
        <button type="button" id="selectBtn" class="btn btn-outline-primary">選擇圖片</button>
    </div>

    <!-- 預覽區 -->
    <div id="preview" class="row row-cols-1 row-cols-md-3 g-3 mb-3"></div>

    <!-- 隱藏 input 集合 -->
    <div id="hiddenInputs"></div>

    <button type="submit" class="btn btn-primary">上傳</button>
</form>

@if (ViewBag.Message != null)
{
    <div class="alert alert-info mt-3">@ViewBag.Message</div>
}

@if (Model != null && Model.Any())
{
    <div class="row">
        <!-- 左側編輯區（只保留卡片，不要縮圖） -->
        <div class="col-md-3">
            <div class="card shadow-sm p-3">
                <img id="editPreviewImg"
                     src="@Model.FirstOrDefault()?.FileUrl"
                     alt="@Model.FirstOrDefault()?.AltText"
                     class="card-img-top mb-3 img-fluid rounded" />

                <h5 class="card-title">編輯圖片資訊</h5>

                <div class="mb-3">
                    <label class="form-label">AltText</label>
                    <input type="text" id="editAlt" class="form-control"
                           value="@(Model.FirstOrDefault()?.AltText ?? "")" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Caption</label>
                    <input type="text" id="editCaption" class="form-control"
                           value="@(Model.FirstOrDefault()?.Caption ?? "")" />
                </div>
                <button type="button" id="saveMeta" class="btn btn-primary w-100">更新</button>
            </div>
        </div>

        <!-- 中間大圖 -->
        <div class="col-md-6 position-relative">
            <div id="carouselFiles" class="carousel slide carousel-vertical" data-bs-ride="carousel">
                <div class="carousel-inner">
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var file = Model[i];
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <div class="img-wrapper">
                                <img src="@file.FileUrl"
                                     alt="@file.AltText"
                                     class="d-block mx-auto main-img" />
                            </div>
                            <div class="carousel-caption d-none d-md-block">
                                <p>@file.Caption</p>
                            </div>
                        </div>
                    }
                </div>

                <!-- 上一張按鈕 -->
                <button class="btn-carousel-vertical prev" type="button" data-bs-target="#carouselFiles" data-bs-slide="prev">
                    <i class="bi bi-chevron-up"></i>
                </button>

                <!-- 下一張按鈕 -->
                <button class="btn-carousel-vertical next" type="button" data-bs-target="#carouselFiles" data-bs-slide="next">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
        </div>

        <!-- 右側縮圖 -->
        <div class="col-md-3">
            <div class="overflow-auto" style="max-height:600px;">
                <div class="d-flex flex-column align-items-center">
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var file = Model[i];
                        <img src="@file.FileUrl"
                             class="img-thumbnail mb-2 thumb-img"
                             style="cursor:pointer; width:90px; height:60px; object-fit:cover;"
                             data-bs-target="#carouselFiles"
                             data-bs-slide-to="@i"
                             alt="@file.AltText" />
                    }
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const carousel = document.getElementById("carouselFiles");
            const altInput = document.getElementById("editAlt");
            const captionInput = document.getElementById("editCaption");
            const saveBtn = document.getElementById("saveMeta");
            const previewImg = document.getElementById("editPreviewImg");

            // 載入目前 active 圖片資訊到編輯卡片
            function loadMeta() {
                const activeItem = carousel.querySelector(".carousel-item.active");
                if (!activeItem) return;

                const img = activeItem.querySelector("img.main-img");
                const caption = activeItem.querySelector(".carousel-caption p");

                altInput.value = img.alt;
                captionInput.value = caption.textContent;
                previewImg.src = img.src;
                previewImg.alt = img.alt;
            }

            // 初始化
            loadMeta();

            // 切換輪播後更新左側卡片
            carousel.addEventListener("slid.bs.carousel", loadMeta);

            // 更新按鈕 → 即時反映到 carousel & 左側預覽
            saveBtn.addEventListener("click", function () {
                const activeItem = carousel.querySelector(".carousel-item.active");
                if (!activeItem) return;

                const img = activeItem.querySelector("img.main-img");
                const caption = activeItem.querySelector(".carousel-caption p");

                img.alt = altInput.value;
                caption.textContent = captionInput.value;

                previewImg.alt = altInput.value;
                previewImg.src = img.src; // 保持同步
            });
        });

        const dropArea = document.getElementById("dropArea");
        const fileInput = document.getElementById("fileInput");
        const selectBtn = document.getElementById("selectBtn");
        const preview = document.getElementById("preview");
        const hiddenInputs = document.getElementById("hiddenInputs");

        selectBtn.addEventListener("click", () => fileInput.click());

        function showPreview(files) {
            preview.innerHTML = "";
            hiddenInputs.innerHTML = "";

            [...files].forEach((file, index) => {
                if (!file.type.startsWith("image/")) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const col = document.createElement("div");
                    col.className = "col";
                    col.dataset.index = index; // 標記索引

                    col.innerHTML = `
                        <div class="card h-100 shadow-sm position-relative">
                            <!-- 移除按鈕 -->
                            <button type="button" class="btn-close position-absolute top-0 end-0 m-2 remove-btn" aria-label="Close"></button>

                            <img src="${e.target.result}" class="card-img-top img-thumbnail" />
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="form-label">AltText</label>
                                    <input type="text" name="Files[${index}].AltText" class="form-control" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Caption</label>
                                    <input type="text" name="Files[${index}].Caption" class="form-control" />
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" name="Files[${index}].IsActive" value="true" class="form-check-input" checked />
                                    <label class="form-check-label">啟用</label>
                                </div>
                            </div>
                        </div>
                    `;
                    preview.appendChild(col);

                    // 隱藏 File input
                    const hiddenFileInput = document.createElement("input");
                    hiddenFileInput.type = "file";
                    hiddenFileInput.name = `Files[${index}].File`;
                    hiddenFileInput.classList.add("d-none");
                    hiddenFileInput.dataset.index = index; // 標記索引

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    hiddenFileInput.files = dataTransfer.files;

                    hiddenInputs.appendChild(hiddenFileInput);

                    // 綁定刪除事件
                    col.querySelector(".remove-btn").addEventListener("click", () => {
                        // 移除預覽卡片
                        col.remove();
                        // 移除對應 hidden input
                        hiddenInputs.querySelector(`input[data-index="${index}"]`)?.remove();
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        fileInput.addEventListener("change", () => showPreview(fileInput.files));

        ["dragenter", "dragover"].forEach(evt => {
            dropArea.addEventListener(evt, e => {
                e.preventDefault();
                dropArea.classList.add("bg-white");
            });
        });
        ["dragleave", "drop"].forEach(evt => {
            dropArea.addEventListener(evt, e => {
                e.preventDefault();
                dropArea.classList.remove("bg-white");
            });
        });
        dropArea.addEventListener("drop", e => {
            e.preventDefault();
            fileInput.files = e.dataTransfer.files;
            showPreview(fileInput.files);
        });
    </script>
}