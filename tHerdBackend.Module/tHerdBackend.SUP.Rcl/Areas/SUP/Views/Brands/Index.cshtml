@* Brands Index *@

@section Styles {
    <!-- Area 專用 CSS -->
    <link rel="stylesheet" href="~/_content/tHerdBackend.SUP.Rcl/css/supstylesheet.css" />
    <style>
    </style>
}

@* 按鈕 *@
<button id="create" class="btn btn-outline-success mb-2">新增品牌</button>
<button id="createBrandDiscount" class="btn btn-outline-warning mb-2">新增全館品牌折扣</button>
<button id="refreshDiscountStatusBtn" class="btn btn-outline-primary btn-sm" title="批次刷新全部品牌折扣狀態">
    <i class="fa-solid fa-arrows-rotate"></i>
</button>


@* 渲染 DataTable：#brandTable *@
<div class="card brand-card">
    <h5>品牌資料</h5>
    <table id="brandTable" class="display table" style="width:100%">
        <thead>
            <tr>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 新增/修改/詳情品牌 Modal -->
<div id="brandModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white container">
            <!-- Header -->
            <div class="modal-header">
                <h5 id="brandModalTitle" class="modal-title">品牌</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <!-- Body -->
            <div id="brandModalContent" class="modal-body p-4">
                <!-- 透過 AJAX 載入 *Partial.cshtml -->
            </div>
        </div>
    </div>
</div>

<!-- 新增全館折扣 Modal -->
<div id="brandDiscountModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="brandDiscountModalTitle" class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div id="brandDiscountModalContent" class="modal-body p-4">
                <!-- AJAX 載入 Partial View -->
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @* <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> *@

    <script>
        $(document).ready(function() {
            // ======= URL 變數 ======= //
            var indexJsonUrl = '@Url.Action("IndexJson", "Brands", new { area = "SUP" })';
            var createUrl    = '@Url.Action("Create", "Brands", new { area = "SUP" })';
            var editUrl      = '@Url.Action("Edit", "Brands", new { area = "SUP" })';
            var detailsUrl   = '@Url.Action("Details", "Brands", new { area = "SUP" })';
            var deleteUrl    = '@Url.Action("DeleteAjax", "Brands", new { area = "SUP" })';
            var toggleStatusUrl = '@Url.Action("ToggleStatus", "Brands", new { area = "SUP" })';
            var createDiscountUrl = '@Url.Action("CreateDiscount", "Brands", new { area = "SUP" })';

            // ======= 從 sessionStorage 拿到初始品牌名稱 =======
            var initialBrandName = sessionStorage.getItem('selectedBrandName') || '';

            // 初始化完就清掉，避免刷新又填入
            sessionStorage.removeItem('selectedBrandName');


            // 初始化 DataTable
            var table = $('#brandTable').DataTable({
                serverSide: true,
                processing: true,
                ajax: {
                    url: indexJsonUrl,
                    type: 'POST',
                    // dataSrc: 'data',
                    dataSrc: function (json) {
                        //console.log(json);      // 印出整個 JSON
                        console.log(json.data); // 印出每筆 row
                        return json.data;
                    },
                    error: function (xhr, error, thrown) {
                        console.log(xhr.responseText); // 印出後端錯誤訊息
                        alert("資料載入失敗，請檢查後端或 console");
                    }
                },
                columns: [
                    {
                        data: 'sortDate',          // 後端給每筆資料一個排序用時間
                        title: '#',
                        className: 'text-center',
                        orderable: true,
                        render: function (data, type, row, meta) {
                            return meta.row + 1 + meta.settings._iDisplayStart; // 顯示序號
                        }
                    },
                    {
                        data: 'brandName',
                        title: '品牌名稱',
                        className: 'text-center',
                        render: function (data, type, row) {
                            return `${data} <button class="btn btn-link btn-sm details-btn" data-id="${row.brandId}" title="詳細資料" data-bs-toggle="tooltip"><i class="fa-solid fa-circle-info" style="color: #15b49f;"></i></button>`;
                        }
                    },
                    {
                        data: 'supplierName',
                        title: '供應商名稱',
                        className: 'text-center',
                        render: function (data, type, row) {
                            if (!data) {
                                return '<span class="no-supplier">尚未指定供應商</span>';
                            }
                            return `${data} <button class="btn btn-link btn-sm supplier-btn" data-name="${row.supplierName}" title="跳轉供應商頁" data-bs-toggle="tooltip">
                                        <i class="fa-regular fa-copyright" style="color: #176afa;"></i>
                                    </button>`;
                        }
                    },
                    {
                        data: 'discountStatus',
                        title: '折扣狀態',
                        className: 'text-center',
                        render: function (data, type, row) {
                            if (data.startsWith('進行中')) {
                                return `<span class="text-success">${data}</span>`;
                            } else if (data.includes('尚未')) {
                                return `<span class="text-warning">${data}</span>`;
                            } else if (data.includes('結束')) {
                                return `<span class="text-danger">${data}</span>`;
                            } else {
                                return `<span>${data}</span>`;
                            }
                        },
                        orderable: false
                    },
                    {
                        data: 'isFeatured',
                        title: '精選品牌',
                        className: 'text-center',
                        render: function (data, type, row) {
                            return `
                                <div class="form-check form-switch">
                                    <input class="form-check-input toggle-status" type="checkbox"
                                           data-id="${row.brandId}" data-type="featured" ${row.isFeatured ? 'checked' : ''}>
                                </div>
                            `;
                        }
                    },
                    {
                        data: 'isActive',
                        title: '品牌啟用狀態',
                        className: 'text-center',
                        render: function (data, type, row) {
                            return `
                                <div class="form-check form-switch">
                                    <input class="form-check-input toggle-status" type="checkbox"
                                           data-id="${row.brandId}" data-type="active" ${row.isActive ? 'checked' : ''}>
                                </div>
                            `;
                        }
                    },
                    {
                        data: 'brandId',
                        title: '操作',
                        className: 'text-center',
                        orderable: false,
                        render: function (data) {
                            return `
                                <button class="btn btn-sm edit-btn" data-id="${data}" title="品牌編輯" data-bs-toggle="tooltip">
                                    <i class="fa-regular fa-pen-to-square" style="color: #9073e8;"></i>
                                </button>
                                <button class="btn btn-sm discount-btn" data-id="${data}" title="折扣編輯" data-bs-toggle="tooltip">
                                    <i class="fa-solid fa-tags" style="color: #e87439;"></i>
                                </button>
                                <button class="btn btn-sm delete-btn" data-id="${data}" title="刪除品牌" data-bs-toggle="tooltip">
                                    <i class="fa-solid fa-trash" style="color: #6688b7;"></i>
                                </button>
                            `;
                        }
                    }
                ],
                scrollY: "500px",
                scrollCollapse: true,
                colReorder: true,
                columnDefs: [
                    { targets: '_all', type: 'string' }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.3.3/i18n/zh-HANT.json',
                    processing: '<i class="fa-solid fa-dog fa-bounce fa-3x"></i>'
                },
                initComplete: function (settings, json) {
                    // 從 sessionStorage 取初始品牌
                    // ===== 自動填入搜尋品牌名稱 =====
                    var api = this.api(); // DataTable 內建方法取得當前表格實例
                    if (initialBrandName) {
                        var searchInput = $('#dt-search-0');
                        searchInput.val(initialBrandName).trigger('input');
                        api.search(initialBrandName).draw();

                        Swal.fire({
                            icon: 'info',
                            title: '已篩選',
                            text: `目前顯示供應商 "${initialBrandName}" 的品牌`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }

                    // 初始化 tooltip
                    $('[data-bs-toggle="tooltip"]').each(function () {
                        new bootstrap.Tooltip(this);
                    });
                }
            });
            // tooltip 初始化與 redraw
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
            table.on('draw', function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
            });

            // 新增品牌
            $("#create").click(function() {
                //console.log("click create")
                $.get(createUrl,  function(html) {
                    //console.log("ajax success"); // <- 看是否有進來   
                    $("#brandModalTitle").text("新增品牌");
                    $('#brandModalContent').html(html);
                    $.validator.unobtrusive.parse('#brandModalContent');
                    $('#brandModal').modal('show');
                });
            });

            // 編輯品牌
            $('#brandTable').on('click', '.edit-btn', function () {
                var id = $(this).data('id');
                $.get(`${editUrl}/${id}`, function (html) {
                    $("#brandModalTitle").text("修改品牌");
                    $('#brandModalContent').html(html);
                    $.validator.unobtrusive.parse('#brandModalContent');
                    $('#brandModal').modal('show');
                });
            });

            // 折扣設定
            $('#brandTable').on('click', '.discount-btn', function () {
                var id = $(this).data('id');
                $.get(`/SUP/Brands/Discount/${id}`, function (html) {
                    $("#brandModalTitle").text("品牌折扣設定");
                    $('#brandModalContent').html(html);
                    $('#brandModal').modal('show');
                });
            });            

            // 詳細資料
            $('#brandTable').on('click', '.details-btn', function() {
                var id = $(this).data('id');
                $.get(`${detailsUrl}/${id}`, function(html) {
                    $("#brandModalTitle").text("品牌詳細資料");
                    $('#brandModalContent').html(html);

                    // Bootstrap 5 modal show
                    var myModal = new bootstrap.Modal(document.getElementById('brandModal'));
                    myModal.show();
                });
            });

            // 刪除品牌
            $('#brandTable').on('click', '.delete-btn', function() {
                var id = $(this).data('id');
                var rowData = table.row($(this).closest('tr')).data();
                var brandName = rowData.brandName;

                Swal.fire({
                    title: `確定要刪除品牌："${brandName}" 嗎？`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '刪除',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${deleteUrl}/${id}`,
                            type: 'POST',
                            success: function(res) {
                                if (res.success) {
                                    Swal.fire('刪除成功', '', 'success');
                                    table.ajax.reload(null, false);
                                } else {
                                    Swal.fire('刪除失敗', res.message || '', 'error');
                                }
                            },
                            error: function(xhr) {
                                var msg = xhr.responseJSON?.message || '刪除失敗';
                                Swal.fire('刪除失敗', msg, 'error');
                            }
                        });
                    }
                });
            });

            // ======= 點新增全館折扣 =======
            $("#createBrandDiscount").click(function() {
              $.get(createDiscountUrl, function(html) {
                $("#brandDiscountModalTitle").text("新增全館品牌折扣");
                $('#brandDiscountModalContent').html(html);
                $.validator.unobtrusive.parse('#brandDiscountModalContent');
                $('#brandDiscountModal').modal('show');
                setupDateLogic();
              });
            });

            // ======= 提交品牌表單 (新增/修改) =======
            $('#brandModalContent').on('submit', '#BrandForm', function (e) {
                // console.log('submit event triggered');
                e.preventDefault();

                var form = $(this);
                // console.log('form found:', form.length);

                var isActive = $('#IsActive').prop('checked');
                $('input[name="IsActive"][type="hidden"]', form).val(isActive);
                var isFeatured = $('#IsFeatured').prop('checked');
                $('input[name="IsFeatured"][type="hidden"]', form).val(isFeatured);

                // console.log('form serialized:', form.serialize());
                // console.log('form action:', form.attr('action'));

                $.post(form.attr('action'), form.serialize())
                    .done(function (res) {
                        // console.log('AJAX .done triggered');
                        var isJson = false;
                        try {
                            if (typeof res === "string" && res.trim().startsWith("{")) {
                                res = JSON.parse(res);
                                isJson = true;
                            } else if (typeof res === "object") {
                                isJson = true;
                            }
                        } catch (e) { }
                        // console.log('AJAX response type isJson:', isJson, res);

                        if (isJson && res.success) {
                            $('#brandModal').modal('hide');
                            Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: res.isCreate ? '新增成功' : '修改成功',
                                showConfirmButton: false,
                                timer: 1200
                            });

                            if (res.brand) {
                                // console.log('Add row: ', res.brand);
                                table.row.add({
                                    brandId: res.brand.brandId,
                                    brandName: res.brand.brandName,
                                    supplierName: res.brand.supplierName,
                                    isActive: res.brand.isActive
                                }).draw(false);
                            }
                        }
                        else if (typeof res === "string") {
                            console.log('res is string, putting into #brandModalContent');
                            $('#brandModalContent').html(res);
                            $.validator.unobtrusive.parse('#brandModalContent');
                        }
                        else {
                            console.log('Unhandled error branch');
                            Swal.fire('操作失敗', '', 'error');
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.log('AJAX failed:', textStatus, errorThrown);
                        console.log('Response text:', jqXHR.responseText);
                        Swal.fire('操作失敗', '', 'error');
                    });
            });

            // toggle 事件
            $('#brandTable').on('change', '.toggle-status', function() {
                var checkbox = $(this);
                var id = checkbox.data('id');
                var type = checkbox.data('type'); // "featured" 或 "active"
                var rowData = table.row(checkbox.closest('tr')).data();
                var brandName = rowData.brandName;
                var newStatus = checkbox.prop('checked');

                // 先回復 checkbox，等確認後再改
                checkbox.prop('checked', !newStatus);

                Swal.fire({
                    title: newStatus
                        ? `確定啟用${type === 'featured' ? '精選品牌' : '品牌'}：<br>"${brandName}"？`
                        : `確定停用${type === 'featured' ? '精選品牌' : '品牌'}：<br>"${brandName}"？`,
                    icon: newStatus ? 'question' : 'warning',
                    showCancelButton: true,
                    confirmButtonText: newStatus ? '啟用' : '停用',
                    cancelButtonText: '取消',
                    confirmButtonColor: newStatus ? '#3085d6' : '#d33'
                }).then((result) => {
                    if(result.isConfirmed){
                        $.post(`${toggleStatusUrl}`, { brandId: id, type: type, status: newStatus })
                        .done(function(res){
                            if(res.success){
                                // 非精選品牌時，不直接打勾
                                if (!(type === 'featured' && !newStatus)) {
                                    checkbox.prop('checked', newStatus);
                                }

                                let message = '';
                                let iconType = 'success';

                                if (type === 'featured') {
                                    if (newStatus) {
                                        message = `已啟用成為精選品牌`;
                                    } else {
                                        message = `已設為非精選品牌`;
                                        iconType = 'info'; // 用 info 或 question icon 表示非精選
                                    }
                                } else {
                                    message = `已${newStatus ? '啟用' : '停用'}`;
                                    iconType = newStatus ? 'success' : 'warning';
                                }

                                Swal.fire({
                                    position: 'center',
                                    icon: iconType,
                                    title: `品牌：${brandName}<br>${message}`,
                                    showConfirmButton: false,
                                    timer: 1800
                                });

                                table.ajax.reload(null, false);
                            } else {
                                Swal.fire('操作失敗', res.message || '', 'error');
                            }
                        })
                        .fail(function(){
                            Swal.fire('操作失敗', '', 'error');
                        });
                    }
                });
            });

            // jQuery Validation 解析
            $(function () {
                $.validator.unobtrusive.parse('#brandForm');
            });

            // 自動填入
            $(function () {
                // 重新解析 jQuery Validation
                $.validator.unobtrusive.parse('#brandForm');

                // 事件委派 - 綁定在表單容器上（確保 partial 載入後仍有效）
                $('#brandModalContent').on('click', '#fillNameContact', function () {
                    const brands = [
                        //{ name: 'Aura Cacia', shortCode: 'AC', seoId: 'aura-cacia' },
                        //{ name: 'Davinci Laboratories', shortCode: 'DL', seoId: 'davinci-laboratories' },
                        //{ name: 'Happy Family Organics', shortCode: 'HFO', seoId: 'happy-family-organics' },
                        //{ name: "Oregon's Wild Harvest", shortCode: 'OWH', seoId: 'oregons-wild-harvest' },
                        //{ name: 'Physicians Formula', shortCode: 'PF', seoId: 'physicians-formula' }
                        { name: 'Aura Cacia', shortCode: 'AC' },
                        { name: 'Davinci Laboratories', shortCode: 'DL' },
                        { name: 'Happy Family Organics', shortCode: 'HFO' },
                        { name: "Oregon's Wild Harvest", shortCode: 'OWH' },
                        { name: 'Physicians Formula', shortCode: 'PF' }
                    ];

                    // 隨機選取一組品牌資料
                    const randomBrand = brands[Math.floor(Math.random() * brands.length)];

                    // 將選取結果填入欄位
                    $('#BrandName').val(randomBrand.name);
                    $('#BrandCode').val(randomBrand.shortCode);
                    $('#SeoId').val(randomBrand.seoId);
                });
            });

            // ======= 點品牌欄位的供應商按鈕跳轉 =======
            $('#brandTable').on('click', '.supplier-btn', function () {
                var supplierName = $(this).data('name');
                console.log('點擊供應商按鈕，取得 supplierName:', supplierName);

                if (!supplierName) {
                    console.error('❌ supplierName 為空，無法跳轉');
                    return;
                }

                Swal.fire({
                    title: `確認要前往供應商頁面：<br>"${supplierName}"？`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '前往',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // 存入 sessionStorage
                        sessionStorage.setItem('selectedSupplierName', supplierName);
                        console.log('✅ 存入 sessionStorage: selectedSupplierName =', sessionStorage.getItem('selectedSupplierName'));

                        // 跳轉到供應商頁面
                        window.location.href = '/SUP/Suppliers/Index';
                    }
                });
            });

            // 批次刷新所有品牌的折扣狀態
            $('#refreshDiscountStatusBtn').on('click', function() {
                $.post('/SUP/Brands/RefreshAllBrandDiscountStatus', function(result) {
                    if (result.success) {
                        $('#brandTable').DataTable().ajax.reload(); // 刷新表格
                    } else {
                        alert('品牌折扣狀態刷新失敗');
                    }
                });
            });

            // ======= 新增全館折扣 submit 事件 =======            
            $('#brandDiscountModalContent').on('submit', '#brandDiscountForm', function (e) {
                e.preventDefault();

                var form = $(this);
                console.log("送出折扣欄位", form.serializeArray());

                $.post('/SUP/Brands/CreateDiscount', form.serialize())
                    .done(function(res) {
                        // 判斷是否 HTML
                        var isHtml = typeof res === "string" && res.trim().startsWith("<form");
                        var isJson = typeof res === "object" || (typeof res === "string" && res.trim().startsWith("{"));

                        console.log("CreateDiscount response:", res);

                        if (isHtml) {
                            // 這是 partial view，覆蓋 modal 內容
                            $('#brandDiscountModalContent').html(res);
                            $.validator.unobtrusive.parse('#brandDiscountModalContent');
                            setupDateLogic();
                        }
                        else if (isJson) {
                            // JSON情境（解析為object後處理）
                            if (typeof res === "string") {
                                res = JSON.parse(res);
                            }
                            if (res.success) {
                                $('#brandDiscountModal').modal('hide');
                                Swal.fire({
                                    position: 'center',
                                    icon: 'success',
                                    title: '新增折扣成功',
                                    showConfirmButton: false,
                                    timer: 1200
                                });
                                table.ajax.reload();
                            } else if (res.errors) {
                                console.log("Model errors:", res.errors);
                                // 也可彈窗顯示錯誤
                                Swal.fire('表單錯誤', res.errors.join('<br>'), 'error');
                            } else {
                                Swal.fire('新增折扣失敗', '', 'error');
                            }
                        }
                        else {
                            console.log('AJAX回傳非預期型態');
                            Swal.fire('操作失敗', '', 'error');
                        }
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        console.log('新增折扣 AJAX fail:', textStatus, errorThrown);
                        console.log('Response text:', jqXHR.responseText);
                        Swal.fire('新增折扣失敗', '', 'error');
                    });


            });

        });

        // ======= 新增全館折扣 品牌下拉 =======
        function loadBrandsBySupplier(supplierId, selectedBrandId) {
            $.get('/SUP/Brand/GetBrandNameBySupplier?supplierId=' + supplierId, function(brands) {
                var brandSelect = $('#brandSelect');
                brandSelect.empty().append('<option value="">請選擇品牌</option>');
                brands.forEach(function(b) {
                    if(b.isActive) {
                        brandSelect.append(
                            `<option value="${b.brandId}" ${b.brandId == selectedBrandId ? 'selected' : ''}>
                                ${b.brandName}
                            </option>`
                        );
                    } else {
                        brandSelect.append(
                            `<option value="${b.brandId}" ${b.brandId == selectedBrandId ? 'selected' : ''}>
                                ${b.supplierActive ? b.brandName : b.brandName + ' (其供應商目前未啟用)'}
                            </option>`
                        );
                    }
                });
                if(selectedBrandId) brandSelect.trigger('change');
            });
        }

        // ======= 新增全館折扣 日期設定 =======
        function setupDateLogic() {
            const today = new Date().toISOString().split('T')[0];

            const $startDate = $('#StartDate');
            const $endDate = $('#EndDate');

            // 預設起始日為今天，如果沒填
            if (!$startDate.val()) $startDate.val(today);
            $startDate.attr('min', today);

            // 結束日 min/預設，同步起始日
            let startVal = $startDate.val() || today;
            $endDate.attr('min', startVal);
            // 只有當 EndDate 早於 startDate 才要自動設為 startDate
            if (!$endDate.val() || $endDate.val() < startVal) {
                $endDate.val(startVal);
            }

            // 只調整 min，不自動覆蓋當前 endDate（使用者可自由設定日）
            $startDate.off('change').on('change', function() {
                const val = $(this).val();
                $endDate.attr('min', val);
                // 若 endDate 早於新起始日才改掉，否則不動
                if ($endDate.val() < val) $endDate.val(val);
            });
        }



    </script>
}