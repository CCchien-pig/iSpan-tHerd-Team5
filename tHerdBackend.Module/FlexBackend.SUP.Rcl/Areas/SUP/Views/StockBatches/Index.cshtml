@* StockBatches Index *@
@{
    ViewData["Title"] = "庫存管理";
}

@section Styles {
    <link rel="stylesheet" href="~/_content/FlexBackend.SUP.Rcl/css/supstylesheet.css" />
}

<div class="stockbatch-card">
    <button id="createStockBatchBtn" class="btn btn-outline-success">新增庫存</button>
    <div class="legend">
        <span><span class="dot danger"></span> 危險（低於安全庫存）</span>
        <span><span class="dot low"></span> 須補貨（低於再訂購點）</span>
        <span><span class="dot normal"></span> 正常</span>
    </div>
    <table id="stockBatchTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th>SKU</th>
                <th>批號</th>
                <th>品牌</th>
                <th>商品</th>
                <th>到期日</th>
                <th>庫存量</th>
                <th>再訂購點</th>
                <th>安全庫存</th>
                <th>規格</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal -->
<div id="stockBatchModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-white container">
            <!-- Header -->
            <div class="modal-header">
                <h5 id="stockBatchModalTitle" class="modal-title">庫存</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div id="stockBatchModalContent" class="modal-body p-4">
                <!-- AJAX 載入 _StockBatchFormPartial -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // ======= 從 ViewBag 拿到 SupplierId =======
            var selectedSupplierId = @Html.Raw(Json.Serialize(ViewBag.SupplierId ?? ""));   // 加上 JSON.stringify 保險

            // ======= 先判斷是否有 SupplierId =======
            var initDataTable = function(brandName) {

                // 初始化庫存 DataTable
                var stockBatchTable = $('#stockBatchTable').DataTable({
                    serverSide: true,
                    processing: true,
                    ajax: {
                        url: '/SUP/StockBatches/IndexJson',
                        type: 'POST',
                        data: function(d) {
                            d.supplierId = selectedSupplierId; // 傳給 IndexJson
                        },
                        dataSrc: function(json) {
                            console.log(json);      // 印出整個 JSON
                            console.log(json.data); // 印出每筆 row
                            return json.data;
                        }
                    },
                    columns: [
                        { data: 'skuCode', title: 'SKU', className: 'text-center'},
                        { data: 'batchNumber', title: '批號', className: 'text-center'},
                        { data: 'brandName', title: '品牌', className: 'text-center'},
                        { data: 'productName', title: '商品名稱', className: 'text-center'},
                        {
                            data: 'expireDate',
                            title: '到期日',
                            render: function(data) {
                                if (!data) return '無';
                                let date = new Date(data);
                                let today = new Date();
                                let formatted = date.toLocaleDateString('zh-TW');

                                if (date < today.setHours(0,0,0,0)) {
                                    return `<span class="text-danger">${formatted} (已過期)</span>`;
                                }
                                return formatted;
                            }
                        },
                        {
                            data: 'qty', title: '庫存量',
                            render: function (data, type, row) {
                                let stock = parseInt(data);
                                let reorder = parseInt(row.reorderPoint);
                                let safety = parseInt(row.safetyStockQty);

                                if (stock <= safety) {
                                    return `<span class="stock-danger" data-bs-toggle="tooltip" title="低於安全庫存"><i class="fa-solid fa-triangle-exclamation" style="color: #e66774;"></i>${stock}</span>`;
                                } else if (stock <= reorder) {
                                    return `<span class="stock-low" data-bs-toggle="tooltip" title="庫存低於再訂購點"><i class="fa-solid fa-circle-exclamation" style="color: #f9d66f;"></i>${stock}</span>`;
                                }
                                return `<span class="stock-normal" data-bs-toggle="tooltip" title="庫存正常">${stock}</span>`;
                            }
                        },
                        { data: 'reorderPoint', title: '再訂購點' },
                        { data: 'safetyStockQty', title: '安全庫存' },
                        {
                            data: 'specifications',
                            className: 'text-center',
                            title: '規格',
                                render: function(data) {
                                console.log(data);  // 印出確認
                                if(!data) return '';
                                return data.map(s => s.groupName + ':' + s.optionName).join(' / ');
                            }
                        },
                        {
                            data: 'stockBatchId',
                            title: '操作',
                            orderable: false,
                            render: function(data, type, row) {
                                return `
                                    <button class="btn btn-sm edit-stock-btn" data-id="${data}" data-bs-toggle="tooltip" title="庫存異動">
                                        <i class="fa-solid fa-pen-to-square" style="color: #9073e8;"></i>
                                    </button>
                                    <button class="btn btn-sm stock-history-btn" data-brandid="${row.BrandCode}" data-bs-toggle="tooltip" title="異動紀錄">
                                        <i class="fa-solid fa-clock-rotate-left" style="color: #1c7ed6;"></i>
                                    </button>
                                `;
                            }
                        }
                    ],
                    scrollY: "500px",
                    scrollCollapse: true,
                    colReorder: true,
                    columnDefs: [
                        { targets: '_all', type: 'string' } // 所有欄位都設成文字
                    ],
                    language: {
                        url: '//cdn.datatables.net/plug-ins/2.3.3/i18n/zh-HANT.json',
                        processing: '<i class="fa-solid fa-dog fa-bounce fa-3x"></i>'
                    },
                    initComplete: function(settings, json) {
                        // ===== 自動填入搜尋品牌名稱（不觸發搜尋）=====
                        if (brandName) {
                            $('#dt-search-0').val(brandName);

                            Swal.fire({
                                icon: 'info',
                                title: '已篩選',
                                text: `目前顯示供應商 "${brandName}" 的品牌庫存`,
                                timer: 2000,
                                showConfirmButton: false
                            });

                            // 填入搜尋欄但不觸發 DataTable 搜尋
                            $('#dt-search-0').val(brandName);
                        }

                        // ===== 在搜尋欄旁加重置按鈕 =====
                        var searchBox = $('.dt-search');
                        if (searchBox.length && !$('#resetSearchBtn').length) {
                            searchBox.append(`
                                <button id="resetSearchBtn" class="btn btn-sm btn-outline-secondary ms-2" title="重置搜尋" data-bs-toggle="tooltip">
                                    <i class="fa-solid fa-arrows-rotate" style="color: #f4a4d7;"></i>
                                </button>
                            `);

                            $('#resetSearchBtn').on('click', function() {
                                $('#dt-search-0').val('');        // 清空搜尋文字
                                stockBatchTable.search('').draw(); // 重新 draw
                            });
                        }

                        // 初始化 tooltip
                        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });

                    }
                });

                // 每次 redraw 都重新初始化 tooltip
                stockBatchTable.on('draw', function() {
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
                });            
            }

            // 如果有 SupplierId，先取得品牌名稱
            if (selectedSupplierId) {
                $.ajax({
                    url: '/SUP/StockBatches/GetBrandNameBySupplier',
                    type: 'GET',
                    data: { supplierId: selectedSupplierId },
                    success: function(brandName) {
                        initDataTable(brandName);
                    },
                    error: function() {
                        initDataTable('');
                    }
                });
            } 
            else {
                initDataTable('');
            }

            // ======= 初始化 Modal Form 函數 =======
            window.initStockBatchForm = function(selectedBrandId = null, selectedProductId = null, selectedSkuId = null) {
                var $brandSelect = $('#BrandSelect');
                var $productSelect = $('#ProductSelect');
                var $skuSelect = $('#SkuSelect');
                var $movementTypeSelect = $('#MovementTypeSelect');
                var $changeQtyInput = $('#ChangeQtyInput');
                var $adjustTypeSelect = $('#AdjustTypeSelect');
                var $predictedQty = $('#PredictedQty');

                // 載入品牌
                $brandSelect.html('<option value="">請選品牌</option>');
                $.get('/SUP/StockBatches/GetBrands', function (brands) {
                    brands.forEach(b => $brandSelect.append(`<option value="${b.brandId}">${b.brandName}</option>`));
                    if (selectedBrandId) $brandSelect.val(selectedBrandId).trigger('change');
                });

                // 載入異動類型
                $movementTypeSelect.html('<option value="">請選異動類型</option>');
                $.get('/SUP/StockBatches/GetMovementTypes', function (types) {
                    types.forEach(m => $movementTypeSelect.append(`<option value="${m.value}">${m.text}</option>`));
                });

                // 品牌選擇後載入商品
                $brandSelect.off('change').on('change', function () {
                    var brandId = $(this).val();
                    $productSelect.html('<option value="">請選商品</option>').prop('disabled', !brandId);
                    $skuSelect.html('<option value="">請選 SKU</option>').prop('disabled', true);

                    if (brandId) {
                        $.get('/SUP/StockBatches/GetProductsByBrand', { brandId: brandId }, function (products) {
                            products.forEach(p => $productSelect.append(`<option value="${p.productId}">${p.productName}</option>`));
                            if (selectedProductId) $productSelect.val(selectedProductId).trigger('change');
                        });
                    }
                });

                // 商品選擇後載入 SKU
                $productSelect.off('change').on('change', function() {
                    var productId = $(this).val();
                    var isPublished = $(this).find(':selected').data('ispublished') || 0;
                    $('#IsPublishedText').text(isPublished ? '上架中' : '未上架');

                    $skuSelect.html('<option value="">請選 SKU</option>').prop('disabled', !productId);

                    if (productId) {
                        $.get('/SUP/StockBatches/GetSkusByProduct', { productId: productId }, function(skus) {
                            skus.forEach(sku => $skuSelect.append(`
                                <option value="${sku.skuId}"
                                    data-qty="${sku.stockQty}"
                                    data-reorder="${sku.reorderPoint}"
                                    data-safety="${sku.safetyStockQty}"
                                    data-max="${sku.maxStockQty}"
                                    data-allowbackorder="${sku.isAllowBackorder}">
                                    ${sku.skuCode}
                                </option>
                            `));
                            if (selectedSkuId) $skuSelect.val(selectedSkuId).trigger('change');
                        });
                    }
                });

                // 選 SKU 更新庫存資訊 & 預計庫存
                $skuSelect.off('change').on('change', function() {
                    var selected = $(this).find(':selected');
                    var currentQty = selected.data('qty') || 0;
                    var reorderPoint = selected.data('reorder') || 0;
                    var safetyStock = selected.data('safety') || 0;
                    var maxStock = selected.data('max') || 0;
                    var allowBackorder = selected.data('allowbackorder') || 0;

                    $('#CurrentQty').text(currentQty);
                    $('#ReorderPoint').text(reorderPoint);
                    $('#SafetyStockQty').text(safetyStock);
                    $('#MaxStockQty').text(maxStock);
                    $('#IsAllowBackorderText').text(allowBackorder ? '可預購' : '不可預購');

                    var $changeQty = $('#ChangeQtyInput');
                    var $predictedQty = $('#PredictedQty');

                    var adjustType = $('#AdjustTypeSelect').val() === 'true';
                    var maxAdd = Math.max(0, maxStock - currentQty);
                    var maxRemove = Math.max(0, currentQty - safetyStock);

                    $changeQty.attr('max', maxAdd).val(0);
                    $predictedQty.text(currentQty);

                    $changeQty.off('input').on('input', function() {
                        var val = parseInt($(this).val()) || 0;
                        var movementType = $('#MovementTypeSelect').val();
                        var newQty = currentQty;

                        switch(movementType){
                            case 'Purchase':   // 採購入庫
                            case 'Return':     // 退貨入庫
                                newQty += val;
                                break;
                            case 'Sale':       // 銷售出庫
                            case 'Expire':     // 到期報廢
                                newQty -= val;
                                break;
                            case 'Adjust':     // 手動調整
                                var isAdd = $('#AdjustTypeSelect').val() === 'true';
                                newQty += isAdd ? val : -val;
                                break;
                        }

                        // 判斷是否允許負庫存
                        if(!allowBackorder && newQty < 0) newQty = 0;

                        $predictedQty.text(newQty);
                    });

                });

                // 異動類型切換顯示手動加減
                $movementTypeSelect.off('change').on('change', function () {
                    $('#AdjustTypeDiv').toggle($(this).val() === 'Adjust');
                    $skuSelect.trigger('change');
                });

                // 初始化品牌/商品/SKU 選項
                if(selectedBrandId) $brandSelect.val(selectedBrandId).trigger('change');
                if(selectedProductId) $productSelect.val(selectedProductId).trigger('change');
                if(selectedSkuId) $skuSelect.val(selectedSkuId).trigger('change');

            };

            // ======= 新增庫存按鈕 =======
            $('#createStockBatchBtn').on('click', function () {
                $.get('/SUP/StockBatches/Create', function(html){
                    $('#stockBatchModalContent').html(html);
                    $('#stockBatchModalTitle').text("新增庫存");
                    $('#stockBatchModal').modal('show');

                    window.initStockBatchForm();
                });
            });

            // ======= 新增 & 更新庫存表單提交 =======
            $('#stockBatchModalContent').off('submit', '#stockBatchForm').on('submit', '#stockBatchForm', function (e) {
                e.preventDefault();
                var form = $(this);
                var formData = new FormData(form[0]);

                // Adjust 類型需額外傳 IsAdd
                if ($('#MovementTypeSelect').val() === 'Adjust') {
                    formData.set('IsAdd', $('#AdjustTypeSelect').val() === 'true');
                }

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]', form).val()
                    },
                    success: function(res){
                        if(res.success){
                            $('#stockBatchModal').modal('hide');
                            Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: res.message || '操作成功',
                                showConfirmButton: false,
                                timer: 1200
                            });
                            stockBatchTable.ajax.reload(null, false);
                        } else {
                            Swal.fire('操作失敗', res.message || '資料格式錯誤', 'error');
                        }
                    },
                    error: function(){
                        Swal.fire('操作失敗', '', 'error');
                    }
                });
            });


            // ======= 編輯庫存 =======
            $('#stockBatchTable').on('click', '.edit-stock-btn', function() {
                var id = $(this).data('id');
                $.get(`/SUP/StockBatches/Edit/${id}`, function(html){
                    $('#stockBatchModalContent').html(html);
                    $('#stockBatchModalTitle').text("庫存量異動");
                    $('#stockBatchModal').modal('show');

                    var selectedBrandId = $('#SelectedBrandId').val() || null;
                    var selectedProductId = $('#SelectedProductId').val() || null;
                    var selectedSkuId = $('#SelectedSkuId').val() || null;
                    window.initStockBatchForm(selectedBrandId, selectedProductId, selectedSkuId);
                });
            });

            // ======= 異動紀錄按鈕 =======
            $('#stockBatchTable').on('click', '.stock-history-btn', function() {
                var brandCode = $(this).data('brandid');
                window.location.href = stockHistoryUrl + `?brandCode=${brandCode}`;
            });

        });
    </script>
}
