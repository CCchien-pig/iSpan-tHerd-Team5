@using tHerdBackend.Core.DTOs.PROD
@using tHerdBackend.Core.Models
@model IEnumerable<ProdProductDto>

@section Styles {
    <style>
        #dataTable tbody tr:nth-child(even) { background-color: #fff; }
        #dataTable tbody tr:hover { background-color: #FFF2CC !important; }
        table thead th {
            background-color: #652D77 !important;
            color: #fff !important;
            position: relative;
            padding-right: 20px !important;
            white-space: nowrap;
        }
        table.dataTable thead th:nth-child(1),
        table.dataTable thead tr:first-child th.no-sort-group {
            cursor: default !important;
            pointer-events: none !important;
        }
        table.dataTable thead th:nth-child(1) .dt-column-order,
        table.dataTable thead tr:first-child th.no-sort-group .dt-column-order {
            display: none !important;
        }
        .publish-toggle:checked { background-color: #28a745 !important; border-color: #28a745 !important; }
        #dataTable { border-radius: 0.5rem; overflow: hidden; font-size: 0.95rem; background-color: #ffffff; }
    </style>
}

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 text-purple2">清單查詢</h6>
        <a asp-area="PROD" asp-controller="Products" asp-action="Upsert" class="btn btn-sm btn-success shadow-sm">
            <i class="fas fa-plus fa-sm text-white-50"></i> 新增產品
        </a>
    </div>

    <div class="card-body">
        @* 篩選區 *@
        <div class="row mb-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">品牌</label>
                <select id="brandFilter" class="form-select">
                    <option value="">全部</option>
                    @foreach (var b in (List<LoadBrandOptionDto>)ViewBag.BrandDtos)
                    {
                        <option value="@b.BrandId">@b.BrandName</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">分類</label>
                <select id="typeFilter" class="form-select">
                    <option value="">全部</option>
                    @foreach (var t in (List<ProdProductTypeConfigDto>)ViewBag.TypeDtos)
                    {
                        <option value="@t.ProductTypeId">@t.ProductTypeName</option>   <!-- ✅ 改成 Id -->
                    }
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">是否上架</label>
                <select id="publishFilter" class="form-select">
                    <option value="">全部</option>
                    <option value="true">上架</option>
                    <option value="false">下架</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">商品編號</label>
                <input type="text" id="productId" class="form-control" placeholder="輸入商品編號">
            </div>

            <div class="col-md-2">
                <button id="btnSearch" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> 查詢
                </button>
            </div>
        </div>

        <!-- 🔹 表格 -->
        <div class="table-responsive">
            <table class="display nowrap stripe hover" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th rowspan="2" class="text-center">選項</th>
                        <th rowspan="2" class="text-center">品牌</th>
                        <th colspan="4" class="text-center">商品</th>
                        <th rowspan="2" class="text-center">供應商</th>
                        <th rowspan="2" class="text-center">是否上架</th>
                        <th rowspan="2" class="text-center">建檔人員</th>
                        <th rowspan="2" class="text-center">建檔日期</th>
                    </tr>
                    <tr>
                        <th class="text-center">編號</th>
                        <th class="text-center">分類</th>
                        <th class="text-center">簡碼</th>
                        <th class="text-center">名稱</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

@section Scripts {
@await Html.PartialAsync("_SweetAlertPartial")

<script>
$(function () {
    const apiUrl = '@Url.Action("GetProducts", "Products", new { area = "PROD" })';
    const upsertBase = '@Url.Action("Upsert", "Products", new { area = "PROD" })';

    $.fn.dataTable.ext.errMode = 'throw';

    var table = $('#dataTable').DataTable({
        ajax: {
            url: apiUrl,
            type: "GET",
            data: function (d) {
                const isPublishedVal = $('#publishFilter').val();
                const parsedIsPublished = 
                    isPublishedVal === "" ? null :
                    isPublishedVal === "true" ? true :
                    isPublishedVal === "false" ? false : null;

                d.brandId = $('#brandFilter').val();
                d.productTypeId = $('#typeFilter').val();
                d.isPublished = parsedIsPublished;
                d.productId = $('#productId').val();
                d.pageIndex = (d.start / d.length) + 1;
                d.pageSize = d.length;
            },
            dataSrc: function (json) {
                console.log("✅ DataTable Response:", json);
                return json.data || [];
            }
        },
        serverSide: true,
        processing: true,
        columns: [
            {
                data: null,
                render: function (data, type, row) {
                    return `<a href="${upsertBase}?id=${row.productId}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil-square"></i> 編輯
                            </a>`;
                }
            },
            { data: "brandName", defaultContent: "-" },
            { data: "productId" },
            {
                data: "productTypeDesc",
                render: function (data) {
                    return data && data.length ? data.join(", ") : "-";
                }
            },
            { data: "productCode" },
            { data: "productName" },
            { data: "supplierName" },
            {
                data: "isPublished",
                render: function (data) {
                    const checked = data ? "checked" : "";
                    return `<div class="form-check form-switch d-flex justify-content-center">
                                <input type="checkbox" class="form-check-input" ${checked} disabled>
                            </div>`;
                }
            },
            { data: "creatorNm" },
            { data: "formateCreatedDate" }
        ],
        columnDefs: [
            { targets: [0, 1], orderable: false },
            { targets: "_all", className: "text-center align-middle" }
        ],
        paging: true,
        searching: false,
        ordering: true,
        language: {
            processing: "處理中...",
            loadingRecords: "載入中...",
            lengthMenu: "每頁顯示 _MENU_ 筆",
            zeroRecords: "沒有符合的資料",
            info: "第 _START_ ~ _END_ 筆，共 _TOTAL_ 筆",
            infoEmpty: "第 0 ~ 0 筆，共 0 筆",
            infoFiltered: "(從 _MAX_ 筆資料中篩選)",
            paginate: {
                first: "第一頁",
                last: "最後一頁",
                next: "下一頁",
                previous: "上一頁"
            }
        }
    });

    // ✅ 查詢按鈕重新載入表格
    $('#btnSearch').on('click', function () {
        console.log('🔍 Reloading table...');
        table.ajax.reload(null, false);
    });
});
</script>
}
