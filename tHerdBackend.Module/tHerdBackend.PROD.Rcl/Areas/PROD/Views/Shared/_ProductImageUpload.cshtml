@using tHerdBackend.Core.DTOs
@using tHerdBackend.Core.DTOs.PROD
@model IEnumerable<ProductImageDto>

<div class="mb-3">
    <label class="form-label fw-bold">產品圖片</label>

    <!-- 🔹 選擇圖片（從共用 Images 模組中挑圖綁定） -->
    <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="btnBindProductImage">
        <i class="bi bi-images"></i> 選擇圖片
    </button>

    <!-- 🔹 已綁定圖片清單 -->
    <div class="mt-3">
        <h6 class="fw-bold">已綁定圖片</h6>
        <div id="boundImages">
            @if (Model != null && Model.Any())
            {
                // 將 ProductImageDto 轉成 SysAssetFileDto，方便套用 FileListPartial
                var fileList = Model.Select(x => new SysAssetFileDto
                {
                    FileId = x.ImgId,
                    FileKey = x.FileKey,

                    IsExternal = x.IsExternal,
                    FileUrl = x.FileUrl,
                    FileExt = x.FileExt,
                    MimeType = x.MimeType,
                    Width = x.Width,
                    Height = x.Height,
                    FileSizeBytes = x.FileSizeBytes,
                    AltText = x.AltText,
                    Caption = x.Caption,
                    CreatedDate = x.CreatedDate,
                    IsActive = true
                }).ToList();

                @await Html.PartialAsync("_FileListPartial", fileList, new ViewDataDictionary(ViewData) {
                    { "ItemClass", "prod-img-item" } // ✅ 指定產品專用 class
                })
            }
            else
            {
                <span class="text-muted">尚未綁定圖片</span>
            }
        </div>
    </div>
</div>

<!-- 🔹 圖片選擇器 Modal（含上傳功能） -->
@await Html.PartialAsync("_FileSelectPartial", new List<SysAssetFileDto>())

<script>
    document.addEventListener("DOMContentLoaded", () => {
        console.log("🟣 ProductImageUpload ready");

        const btnSelect = document.getElementById("btnBindProductImage");

        // === 綁定圖片選擇器 ===
        if (btnSelect) {
            btnSelect.addEventListener("click", e => {
                e.preventDefault();
                if (typeof openImageSelector === "function") {
                    openImageSelector(selectedFiles => {
                        console.log("🖼️ 已選取:", selectedFiles);
                        appendSelectedImages(selectedFiles);
                    }, "PROD", "Products");
                } else {
                    Swal.fire("錯誤", "找不到圖片選擇器模組 openImageSelector", "error");
                }
            });
        }

        if (window.UploadImageModal && typeof UploadImageModal.init === "function") {
            UploadImageModal.init();
            console.log("✅ UploadImageModal initialized");
        }
    });

    // === 新增圖片後重新載入部分檢視 ===
    function appendSelectedImages(selectedFiles) {
        const list = document.getElementById("boundImages");
        if (!selectedFiles?.length) return;

        if (list.querySelector("span.text-muted")) list.innerHTML = "";

        fetch('/SYS/Images/RenderFileListPartial', {   // 👈 建議做一個 API 回傳 Partial HTML
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(selectedFiles)
        })
        .then(res => res.text())
        .then(html => {
            list.innerHTML = html;

            // ✅ 將共用的 img-item 改成 prod-img-item，避免衝突
            list.querySelectorAll(".img-item").forEach(el => {
                el.classList.add("prod-img-item");
                el.classList.remove("img-item");
            });
        })
        .catch(err => {
            console.error("載入 FileListPartial 失敗：", err);
        });
    }

    // === 編輯圖片資訊 ===
    function editBoundImage(btn) {
        const container = btn.closest(".prod-img-item");
        const img = container?.querySelector("img, video");
        if (!img) return Swal.fire("錯誤", "找不到圖片元素", "error");

        const fileData = {
            fileId: img.dataset.fileId || 0,
            fileUrl: img.dataset.fileUrl || img.src,
            altText: img.dataset.altText || "",
            caption: img.dataset.caption || "",
            mimeType: img.dataset.mimeType || "image/jpeg",
            isActive: img.dataset.isActive === "true"
        };

        if (typeof openImageModal === "function") {
            openImageModal(fileData, "#imgMetaModal");
        } else {
            Swal.fire("錯誤", "找不到圖片編輯模組", "error");
        }
    }

    // === 移除圖片 ===
    function removeBoundImage(btn) {
        const container = btn.closest(".prod-img-item");
        container.remove();

        const list = document.getElementById("boundImages");
        if (!list.querySelector(".prod-img-item")) {
            list.innerHTML = '<span class="text-muted">尚未綁定圖片</span>';
        }
    }
</script>
