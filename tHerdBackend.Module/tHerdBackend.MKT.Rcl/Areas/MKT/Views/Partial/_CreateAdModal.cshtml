<!-- ✅ 引入 SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="modal fade" id="adModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="adForm" enctype="multipart/form-data" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title">新增廣告</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- 🟢 廣告種類 -->
                    <div class="mb-3">
                        <label class="form-label">廣告種類</label>
                        <select name="AdType" class="form-select" id="adTypeSelect">
                            <option value="Carousel">輪播圖</option>
                            <option value="Popup">彈出式廣告</option>
                            <option value="Marquee">跑馬燈</option>
                        </select>
                    </div>

                    <!-- 📝 標題 -->
                    <div class="mb-3">
                        <label class="form-label">標題</label>
                        <input type="text" name="Title" class="form-control" />
                    </div>

                    <!-- 📝 內容 -->
                    <div class="mb-3" id="contentField">
                        <label class="form-label">內容</label>
                        <textarea name="Content" class="form-control"></textarea>
                    </div>

                    <!-- 🖼 圖片上傳 -->
                    <div class="mb-3" id="imageField">
                        <label class="form-label">廣告圖片</label>
                        <input type="file" id="imageInput" class="form-control" accept="image/*" />
                        <input type="hidden" name="ImgId" id="ImgId" />
                        <div class="mt-2 text-center">
                            <img id="imagePreview" class="img-fluid border rounded d-none" style="max-height: 200px;" />
                        </div>
                    </div>

                    <!-- ⏰ 日期 -->
                    <div class="mb-3">
                        <label class="form-label">開始日期</label>
                        <input type="date" name="StartDate" id="StartDate" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">結束日期</label>
                        <input type="date" name="EndDate" id="EndDate" class="form-control" />
                    </div>

                    <input type="hidden" name="Status" value="aActive" />

                    <!-- ✅ 是否啟用 -->
                    <div class="form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" name="IsActive" value="true" checked />
                        <label class="form-check-label">啟用</label>
                    </div>

                    <!-- 👩 建檔人員 -->
                    <div class="mb-3">
                        <label class="form-label">建檔人員</label>
                        <input type="text" name="Creator" class="form-control" />
                    </div>

                    <!-- 🆕 按鈕 -->
                    <div class="mb-3" id="buttonTextField">
                        <label class="form-label">按鈕文字</label>
                        <input type="text" name="ButtonText" class="form-control" placeholder="例如：了解更多" />
                    </div>

                    <div class="mb-3" id="buttonLinkField">
                        <label class="form-label">按鈕連結</label>
                        <input type="text" name="ButtonLink" class="form-control" placeholder="例如：/shop" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">儲存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

      // 🧭 廣告種類控制
      function updateAdFields() {
        const type = $('#adTypeSelect').val();
        $('#contentField, #imageField, #buttonTextField, #buttonLinkField').show();
        $('#contentField textarea, #imageField input, #buttonTextField input, #buttonLinkField input')
          .prop('disabled', false)
          .css({ 'pointer-events': 'auto', 'opacity': '1' });

        if (type === 'Popup') {
          $('#contentField, #buttonTextField, #buttonLinkField').hide();
          $('#contentField textarea, #buttonTextField input, #buttonLinkField input')
            .prop('disabled', true).val('')
            .css({ 'pointer-events': 'none', 'opacity': '0.6' });
        }

        if (type === 'Marquee') {
          $('#imageField, #buttonTextField, #buttonLinkField').hide();
          $('#imageField input, #buttonTextField input, #buttonLinkField input')
            .prop('disabled', true).val('')
            .css({ 'pointer-events': 'none', 'opacity': '0.6' });
        }
      }

      $('#adTypeSelect').on('change', updateAdFields);
      updateAdFields();

      // 🖼 圖片上傳到雲端
      $('#imageInput').on('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        Swal.fire({ title: '上傳中...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/MKT/Ads/UploadToCloud', {
            method: 'POST',
            body: formData
          });
          const result = await res.json();
          Swal.close();

          if (result.success) {
            $('#ImgId').val(result.fileId);
            $('#imagePreview').attr('src', result.fileUrl).removeClass('d-none');
            Swal.fire({ icon: 'success', title: '圖片已上傳成功', showConfirmButton: false, timer: 1200 });
          } else {
            Swal.fire({ icon: 'error', title: '上傳失敗', text: result.message });
          }
        } catch {
          Swal.close();
          Swal.fire({ icon: 'error', title: '雲端連線錯誤', text: '請稍後再試' });
        }
      });

      // 🗓 日期限制
      const today = new Date().toISOString().split('T')[0];
      $('#StartDate').attr('min', today);
      $('#EndDate').attr('min', today);

      $('#StartDate, #EndDate').on('change', function () {
        const start = $('#StartDate').val();
        const end = $('#EndDate').val();
        if (start && end && end < start) {
          Swal.fire({
            icon: 'warning',
            title: '日期錯誤',
            text: '結束日期不能早於開始日期！',
            confirmButtonColor: '#007083'
          });
          $('#EndDate').val('');
        }
      });

      // ✅ 表單送出
      $('#adForm').on('submit', async function (e) {
        e.preventDefault();

        const title = $('[name="Title"]').val();
        const start = $('#StartDate').val();
        const end = $('#EndDate').val();
        const imgId = $('#ImgId').val();

        if (!title || !start || !end) {
          Swal.fire({
            icon: 'warning',
            title: '缺少必填欄位',
            text: '請確認標題與日期已填寫！',
            confirmButtonColor: '#007083'
          });
          return;
        }

        if (!imgId && $('#adTypeSelect').val() === 'Carousel') {
          Swal.fire({
            icon: 'warning',
            title: '未上傳圖片',
            text: '輪播圖廣告需要圖片！',
            confirmButtonColor: '#007083'
          });
          return;
        }

        const formData = $(this).serialize();

        const res = await fetch('/MKT/Ads/Create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        });
        const result = await res.json();

        if (result.success) {
          Swal.fire({ icon: 'success', title: '新增成功', showConfirmButton: false, timer: 1200 });
          setTimeout(() => $('#adModal').modal('hide'), 1200);
        } else {
          Swal.fire({ icon: 'error', title: '新增失敗', text: result.message });
        }
      });
    });
</script>

<style>
    input:disabled, textarea:disabled {
        background-color: #f5f5f5 !important;
        color: #999 !important;
        cursor: not-allowed;
    }
</style>
