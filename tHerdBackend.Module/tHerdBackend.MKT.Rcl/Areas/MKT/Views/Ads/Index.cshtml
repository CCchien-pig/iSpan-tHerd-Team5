<!-- ✅ CSS 套件 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* 日曆外框 */
    #calendar {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 15px;
        margin-top: 15px;
    }

    /* 標題 */
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4a148c;
    }

    /* 統一紫色按鈕 */
    .btn, .fc-button {
        background-color: #6a1b9a !important;
        border: none !important;
        color: #fff !important;
        border-radius: 8px !important;
        transition: all 0.2s ease-in-out;
    }

        .btn:hover, .fc-button:hover {
            background-color: #8e24aa !important;
        }

    /* 左右箭頭圓形化 */
    .fc-prev-button, .fc-next-button {
        border-radius: 50% !important;
        width: 36px !important;
        height: 36px !important;
        padding: 0 !important;
    }

    /* 今日日期高亮 */
    .fc-day-today {
        background-color: rgba(156, 39, 176, 0.15) !important;
        border: 2px solid #8e24aa !important;
    }

    /* 事件卡片 */
    .fc-event {
        border-radius: 8px;
        padding: 2px 6px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: transform 0.15s ease-in-out;
    }

        .fc-event:hover {
            transform: scale(1.05);
        }

    /* 總數 */
    #adCount {
        font-size: 1.2rem;
        font-weight: bold;
        color: #6a1b9a;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(106,27,154,0.1);
    }

    /* 浮動回到今天 */
    #goTodayBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #6a1b9a;
        border: none;
        border-radius: 50%;
        color: #fff;
        z-index: 9999;
        transition: all 0.2s ease-in-out;
    }

        #goTodayBtn:hover {
            background-color: #8e24aa;
            transform: scale(1.1);
        }

    /* 週六週日底色 */
    .fc-day-sat {
        background-color: rgba(106, 27, 154, 0.05);
    }

    .fc-day-sun {
        background-color: rgba(106, 27, 154, 0.1);
    }
</style>

<!-- ✅ HTML 主體 -->
<div class="container my-4">
    <h2>@ViewData["Title"]</h2>

    <button id="btnCreateAd" class="btn mb-3">
       新增廣告
    </button>

    <span class="ms-2">廣告總數 :</span>
    <span id="adCount" class="text-dark fw-bold">0</span>

    <div id="calendar"></div>
</div>

<!-- 浮動回到今天按鈕 -->
<button id="goTodayBtn" class="btn shadow">
    <i class="bi bi-calendar-event"></i>
</button>

<div id="adModalContainer"></div>
@Html.AntiForgeryToken()

<!-- ✅ JS 套件 -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-tw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function () {
        // ✅ 更新廣告總數
        function updateAdCount() {
            $.get('/MKT/Ads/GetTotalCount?t=' + new Date().getTime(), function (res) {
                const $count = $("#adCount");
                const oldCount = parseInt($count.text()) || 0;
                const newCount = res.count || 0;

                if (newCount !== oldCount) {
                    $count.fadeOut(150, function () {
                        $(this).text(newCount).fadeIn(150);
                    });
                }
            }).fail(() => $("#adCount").text(0));
        }

        updateAdCount();

        // ✅ FullCalendar 初始化
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'zh-tw',
            themeSystem: 'bootstrap5',
            height: 700,
            displayEventTime: false,
            events: '/MKT/Ads/GetEvents',
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                month: '月',
                week: '週',
                day: '日'
            },
            eventMouseEnter: function (info) {
                $(info.el).tooltip({
                    title: info.event.title,
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                }).tooltip('show');
            },
            eventMouseLeave: function (info) {
                $(info.el).tooltip('dispose');
            },
            eventClick: function (info) {
            const adId = info.event.id;
            console.log("🟣 點擊日曆廣告 ID:", adId);

            // 取得後端傳回的 Edit Partial View（會自動帶入該筆廣告資料）
            $.get('/MKT/Ads/Edit/' + adId, function (html) {
                // 將回傳的 Edit Modal 插入頁面
                $('#adModalContainer').html(html);

                // 顯示 Modal
                $('#adModal').modal('show');

                // 綁定表單送出 / 刪除邏輯
                bindAdFormSubmit();
            }).fail(function (xhr) {
                console.error("❌ 無法載入編輯頁面:", xhr.responseText);
                Swal.fire('錯誤', '無法載入廣告資料，請稍後再試。', 'error');
            });
    },

        });

        calendar.render();

        // ✅ 新增廣告按鈕
        $('#btnCreateAd').click(function () {
            $.get('/MKT/Ads/Create', function (html) {
                $('#adModalContainer').html(html);
                $('#adModal').modal('show');
                bindAdFormSubmit();
            });
        });

        // ✅ 回到今天按鈕
        $('#goTodayBtn').click(function () {
            calendar.today();
        });

        // ✅ Modal 表單送出
        function bindAdFormSubmit() {
            $('#adForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                const form = $(this);
                const hasAdId = form.find('input[name="AdId"]').val();
                const actionUrl = hasAdId ? '/MKT/Ads/Edit' : '/MKT/Ads/Create';

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: hasAdId ? '編輯成功' : '新增成功',
                                text: '廣告資料已更新！',
                                showConfirmButton: false,
                                timer: 1500
                            });

                            setTimeout(() => {
                                $('#adModal').modal('hide');
                                calendar.refetchEvents();
                                updateAdCount();
                            }, 1500);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '操作失敗',
                                text: res.message || '請稍後再試。'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire('錯誤', '伺服器發生錯誤', 'error');
                    }
                });
            });

            // ✅ 刪除事件
            $('#btnDeleteAd').off('click').on('click', function () {
                const adId = $('input[name="AdId"]').val();
                const token = $('input[name="__RequestVerificationToken"]').val();

                Swal.fire({
                    title: '確定刪除此廣告？',
                    text: '刪除後將無法復原！',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確定刪除',
                    cancelButtonText: '取消',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d'
                }).then(result => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/MKT/Ads/Delete',
                            type: 'POST',
                            data: { id: adId, __RequestVerificationToken: token },
                            success: function (res) {
                                if (res.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: '刪除成功',
                                        text: '該廣告已被刪除！',
                                        showConfirmButton: false,
                                        timer: 1500
                                    });
                                    setTimeout(() => {
                                        $('#adModal').modal('hide');
                                        calendar.refetchEvents();
                                        updateAdCount();
                                    }, 1500);
                                } else {
                                    Swal.fire('錯誤', res.message || '刪除失敗', 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('錯誤', '伺服器錯誤，請稍後再試', 'error');
                            }
                        });
                    }
                });
            });
        }
    });
</script>
