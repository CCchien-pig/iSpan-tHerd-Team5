<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

<div class="container my-4">
    <h2>@ViewData["Title"]</h2>
    <button id="btnCreateAd" class="btn btn-secondary mb-3">新增廣告</button>
    <span class="ms-2">廣告總數 :</span>
    <span id="adCount" class="text-dark">0</span>
    <div id="calendar"></div>
</div>

<div id="adModalContainer"></div>
@Html.AntiForgeryToken()

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<script>
    function updateAdCount() {
        $.get('/MKT/Ads/GetTotalCount', function(res){
            $("#adCount").fadeOut(150, function(){
                $(this).text(res.count || 0).fadeIn(150);
            });
        }).fail(function(){ $("#adCount").text(0); });
    }

    $(document).ready(function(){
        updateAdCount();

        var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            displayEventTime: false,
            height: 700,
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            events: '/MKT/Ads/GetEvents',
            eventClick: function(info) {
                var id = info.event.id;
                $.get('/MKT/Ads/Edit/' + id, function(html){
                    $('#adModalContainer').html(html);
                    $('#adModal').modal('show');
                    bindAdFormSubmit(calendar);
                });
            }
        });
        calendar.render();

        $('#btnCreateAd').click(function(){
            $.get('/MKT/Ads/Create', function(html){
                $('#adModalContainer').html(html);
                $('#adModal').modal('show');
                bindAdFormSubmit(calendar);
            });
        });

        function bindAdFormSubmit(calendar) {
            $('#adForm').off('submit').on('submit', function(e){
                e.preventDefault();
                var form = $(this);
                var actionUrl = form.find('input[name="AdId"]').length ? '/MKT/Ads/Edit' : '/MKT/Ads/Create';

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    data: form.serialize(),
                    success: function(res){
                        if(res.success){
                            $('#adModal').modal('hide');
                            calendar.refetchEvents();
                            updateAdCount();
                        } else { alert('操作失敗: ' + (res.message || '')); }
                    },
                    error: function() { alert('系統錯誤'); }
                });
            });

            $('#btnDeleteAd').off('click').on('click', function(){
                if(!confirm('確定刪除這筆廣告嗎？')) return;
                var adId = $('input[name="AdId"]').val();
                var token = $('input[name="__RequestVerificationToken"]').val();
                $.ajax({
                    url: '/MKT/Ads/Delete',
                    type: 'POST',
                    data: { id: adId, __RequestVerificationToken: token },
                    success: function(res){
                        if(res.success){
                            $('#adModal').modal('hide');
                            calendar.refetchEvents();
                            updateAdCount();
                        } else { alert('刪除失敗: ' + (res.message || '')); }
                    },
                    error: function(){ alert('系統錯誤'); }
                });
            });
        }
    });
</script>
