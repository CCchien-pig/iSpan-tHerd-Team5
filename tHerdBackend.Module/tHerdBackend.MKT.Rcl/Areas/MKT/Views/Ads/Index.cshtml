<!-- ✅ CSS 套件 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    #calendar {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 15px;
        margin-top: 15px;
    }

    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4a148c;
    }

    .btn, .fc-button {
        background-color: #6a1b9a !important;
        border: none !important;
        color: #fff !important;
        border-radius: 8px !important;
        transition: all 0.2s ease-in-out;
    }

        .btn:hover, .fc-button:hover {
            background-color: #8e24aa !important;
        }

    .fc-prev-button, .fc-next-button {
        border-radius: 50% !important;
        width: 36px !important;
        height: 36px !important;
        padding: 0 !important;
    }

    .fc-day-today {
        background-color: rgba(156,39,176,0.15) !important;
        border: 2px solid #8e24aa !important;
    }

    .fc-event {
        border-radius: 8px;
        padding: 2px 6px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: transform 0.15s ease-in-out;
    }

        .fc-event:hover {
            transform: scale(1.05);
        }

    #adCount {
        font-size: 1.2rem;
        font-weight: bold;
        color: #6a1b9a;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(106,27,154,0.1);
    }

    #goTodayBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #6a1b9a;
        border: none;
        border-radius: 50%;
        color: #fff;
        z-index: 9999;
        transition: all 0.2s ease-in-out;
    }

        #goTodayBtn:hover {
            background-color: #8e24aa;
            transform: scale(1.1);
        }

    .fc-day-sat {
        background-color: rgba(106,27,154,0.05);
    }

    .fc-day-sun {
        background-color: rgba(106,27,154,0.1);
    }
</style>

<div class="container my-4">
    <h2>@ViewData["Title"]</h2>

    <button id="btnCreateAd" class="btn mb-3">新增廣告</button>
    <span class="ms-2">廣告總數 :</span>
    <span id="adCount" class="text-dark fw-bold">0</span>

    <div id="calendar"></div>
</div>

<button id="goTodayBtn" class="btn shadow">
    <i class="bi bi-calendar-event"></i>
</button>

<div id="adModalContainer"></div>
@Html.AntiForgeryToken()

<!-- ✅ JS 套件 -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-tw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function () {

        // ✅ 更新廣告總數
        window.updateAdCount = function () {
            $.get('/MKT/Ads/GetTotalCount?t=' + new Date().getTime(), function (res) {
                const $count = $("#adCount");
                const oldCount = parseInt($count.text()) || 0;
                const newCount = res.count || 0;
                if (newCount !== oldCount) {
                    $count.fadeOut(150, function () {
                        $(this).text(newCount).fadeIn(150);
                    });
                }
            }).fail(() => $("#adCount").text(0));
        };

        // ✅ 初始化 FullCalendar 為全域變數
        const calendarEl = document.getElementById('calendar');
        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'zh-tw',
            themeSystem: 'bootstrap5',
            height: 700,
            displayEventTime: false,
            events: '/MKT/Ads/GetEvents',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: { month: '月', week: '週', day: '日', today: '今天' },

            // 🟣 點擊事件顯示編輯視窗
            eventClick: function (info) {
                const adId = info.event.id;
                $.get(`/MKT/Ads/Edit/${adId}`, function (html) {
                    $('#adModalContainer').html(html);
                    const $modal = $('#editAdModal');
                    $modal.modal('show');
                }).fail(function () {
                    Swal.fire('錯誤', '無法載入廣告資料，請稍後再試。', 'error');
                });
            },
        });

        window.calendar.render();
        updateAdCount();

        // ✅ 新增廣告按鈕
        $('#btnCreateAd').on('click', async () => {
            try {
                const res = await fetch('/MKT/Ads/Create');
                if (!res.ok) throw new Error(`伺服器回應 ${res.status}`);
                const html = await res.text();
                $('#adModalContainer').html(html);
                const $modal = $('#createAdModal');
                $modal.modal('show');
            } catch (err) {
                Swal.fire({ icon: 'error', title: '載入失敗', text: err.message });
            }
        });

        // ✅ 回到今天按鈕
        $('#goTodayBtn').click(() => window.calendar.today());
    });
</script>
