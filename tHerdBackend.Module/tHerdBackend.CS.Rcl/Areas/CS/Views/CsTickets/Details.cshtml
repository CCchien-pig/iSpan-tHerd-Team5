@model tHerdBackend.Core.DTOs.CS.TicketOut
@{
    ViewData["Title"] = "客服工單詳情";
    var backUrl = Url.Action("Index", "CsTickets", new { area = "CS" });
    var replyAjaxUrl = Url.Action("ReplyAjax", "CsTickets", new { area = "CS" });
}

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet" />

<div class="page-header bg-white pt-3 pb-2 mb-3 border-bottom sticky-top">
    <div class="d-flex align-items-center justify-content-between">
        <h1 class="h4 mb-0">@ViewData["Title"]</h1>
        <a href="@backUrl" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left"></i> 返回清單
        </a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="mb-3">工單資料</h5>
        <p><b>工單編號：</b>@Model.TicketId</p>
        <p><b>會員編號：</b>@Model.UserId</p>
        <p><b>主旨：</b>@Model.Subject</p>
        <p><b>分類：</b>@Model.CategoryName</p>
        <p><b>信箱：</b>@Model.Email</p>
        <p><b>狀態：</b>@Model.StatusText</p>
        <p><b>建立時間：</b>@Model.CreatedDate.ToString("yyyy/MM/dd HH:mm")</p>
        <h6>📩 問題內容：</h6>
        <div class="p-3 bg-light rounded border">
            @Html.Raw(Model.UserMessage ?? "<i>（使用者未輸入04內容）</i>")
        </div>
    </div>
</div>

<form id="replyForm" action="@replyAjaxUrl" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="ticketId" value="@Model.TicketId" />

    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">回覆內容（寄給客戶的信件）</label>
                <textarea id="replyEditor" name="replyText" class="form-control"></textarea>
                <div class="form-text">客服回覆後，系統會寄出 Email 給使用者。</div>
            </div>
        </div>
    </div>
    <div class="text-end mt-3 mb-5">
        <a href="@backUrl" class="btn btn-outline-secondary me-2">
            <i class="fa-solid fa-arrow-left"></i> 返回清單
        </a>
        <!-- ✅ 改成 button 並加 id -->
        <button type="button" id="openConfirmModal" class="btn btn-primary">
            <i class="fa-solid fa-paper-plane"></i> 寄出回覆信
        </button>
    </div>

</form>


<!-- ✅ 確認寄信 Modal（含回覆內容預覽） -->
<div class="modal fade" id="confirmSendModal" tabindex="-1" aria-labelledby="confirmSendModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmSendModalLabel">
                    <i class="fa-solid fa-envelope-circle-check me-2"></i> 確認寄信內容
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p class="mb-2">請確認以下寄給客戶 <b>@Model.Email</b> 的信件內容：</p>

                <!-- 預覽區 -->
                <div id="replyPreview" class="border rounded p-3 bg-light" style="min-height:120px; max-height:400px; overflow:auto;">
                    <i class="text-muted">（尚無內容）</i>
                </div>

                <div class="form-text mt-2 text-muted">
                    按下「確定寄出」後，系統將立即發信給客戶。
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回修改</button>
                <button type="button" id="confirmSendBtn" class="btn btn-primary">
                    <i class="fa-solid fa-paper-plane"></i> 確定寄出
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ JS 部分 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<script>
    const $jq = window.jQuery;

    document.addEventListener('DOMContentLoaded', function () {
        // 初始化 Summernote
        if ($jq && $jq.fn && $jq.fn.summernote) {
            $jq('#replyEditor').summernote({
                placeholder: '輸入要寄給客戶的內容…',
                height: 250,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['insert', ['link']],
                    ['view', ['codeview']]
                ]
            });
        }

        const openModalBtn = document.getElementById('openConfirmModal');
        const confirmBtn = document.getElementById('confirmSendBtn');
        const preview = document.getElementById('replyPreview');
        const form = document.getElementById('replyForm');
        const confirmModalEl = document.getElementById('confirmSendModal');
        const confirmModal = new bootstrap.Modal(confirmModalEl);

        // 📨 按下「寄出回覆信」→ 顯示預覽
        openModalBtn.addEventListener('click', function () {
            let html = $jq('#replyEditor').summernote('code');
            let plainText = $jq(html).text().trim();

            if (!plainText) {
                alert('請輸入回覆內容後再送出。');
                return;
            }

            // 更新預覽內容
            preview.innerHTML = html || '<i class="text-muted">（尚無內容）</i>';

            // 顯示 Modal
            confirmModal.show();
        });

        // ✅ 確定寄出
        confirmBtn.addEventListener('click', async function () {
            confirmModal.hide();
            let html = $jq('#replyEditor').summernote('code');
            document.getElementById('replyEditor').value = html;

            const fd = new FormData(form);
            try {
                const resp = await fetch(form.action, { method: 'POST', body: fd });
                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data.ok) {
                    alert('✅ 回覆信件已寄出！');
                    location.href = data.redirectUrl;
                } else {
                    alert(data.message || '寄信失敗，請稍後再試。');
                }
            } catch {
                alert('伺服器錯誤，請稍後再試。');
            }
        });
    });
</script>
