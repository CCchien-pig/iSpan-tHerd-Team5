@using System.Text.Json
@using FlexBackend.Core.DTOs.PROD
@using FlexBackend.UIKit.Rcl.Views.Shared.Components.DataTable
@model IEnumerable<ProdProductDto>

@section Styles {
    <style>
        #dataTable tbody tr:nth-child(even) {
            background-color: #F2F2F2;
        }

        #dataTable tbody tr:hover {
            background-color: #f3e8ff;
        }

        /* 自訂表頭為紫色 */
        thead {
            background-color: #652D77; /* 深紫色，可改成你喜歡的色碼 */
            color: #fff; /* 白色字比較清楚 */
        }
    </style>
}

<!-- DataTales -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 text-purple2">清單查詢</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered display" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th rowspan="2"></th>
                        <th rowspan="2">供應商</th>
                        <th rowspan="2">品牌</th>
                        <th colspan="4">商品</th>
                        <th rowspan="2">是否上架</th>
                        <th rowspan="2">建檔人員</th>
                        <th rowspan="2">建檔日期</th>
                    </tr>
                    <tr>
                        <th>編號</th>
                        <th>分類</th>
                        <th>簡碼</th>
                        <th>名稱</th>
                    </tr>
                </thead>
                @* <tfoot>
                    <tr>
                        <th>小計</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </tfoot> *@
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Razor 端輸出 → 正確 JSON 陣列
        var dataJson = @Html.Raw(JsonSerializer.Serialize(
            Model ?? Enumerable.Empty<ProdProductDto>(),
            new JsonSerializerOptions { PropertyNamingPolicy = null }
        ));

        $(function () {
            var $table = $('#dataTable');

            // 定義要顯示的子資料內容
            // function format(row) {
            //   return `
            //     <div style="padding:10px">
            //       <div><b>Email：</b>${row.Email}</div>
            //       <div><b>備註：</b>${row.Notes}</div>
            //     </div>
            //   `;
            // }

            function calcAvailableHeight() {
              var footerH = $('footer').outerHeight() || 0;
              var tableTop = $table.offset().top || 0;
              var winH = $(window).height();
              var gap = 20; // 邊界緩衝
              return Math.max(240, winH - footerH - tableTop - gap);
            }

            function resizeDataTable() {
                var winH = window.innerHeight;
                var headerH = $('.navbar, .topbar').outerHeight() || 0;
                var footerH = $('footer').outerHeight() || 0;
                var gap = 40;

                // 計算可用高度，但最高只取 300
                var h = winH - headerH - footerH - gap;
                var finalH = Math.min(h, 300);

                var $scrollBody = $(table.table().container()).find('.dataTables_scrollBody');
                $scrollBody.css({
                    height: finalH + 'px',
                    'max-height': '300px'
                });

                table.columns.adjust();
            }



            var initH = calcAvailableHeight() - 300;
            var topbarH = $('.navbar, .topbar').outerHeight() || 0;

          var table = $table.DataTable({
            paging: true, // 啟用分頁 (預設就是 true)
            pageLength: 10, // 每頁 5 筆
            lengthMenu: [5, 10, 25, 50], // 可選每頁顯示筆數
            searching: true, // 啟用搜尋
            ordering: true, // 啟用排序

            // 捲動／凍結
            scrollY: initH + 'px', // 表格高度 (px)
            scrollX: true, // 啟用水平捲軸
            scrollCollapse: true,
            fixedHeader: {            // 若有固定頂部導航列時，用 offset 防止蓋住表頭
              header: true,
              headerOffset: topbarH
            },
            fixedColumns: {
                leftColumns: 1, // 凍結左邊第一欄
                rightColumns: 1 // 如果要凍結右邊也可以加這個
            },
            language: {
              processing: "處理中...",
              loadingRecords: "載入中...",
              lengthMenu: "每頁顯示 _MENU_ 筆",
              zeroRecords: "沒有符合的資料",
              info: "第 _START_ ~ _END_ 筆，共 _TOTAL_ 筆",
              infoEmpty: "第 0 ~ 0 筆，共 0 筆",
              infoFiltered: "(從 _MAX_ 筆資料中篩選)",
              search: "搜尋：",
              paginate: {
                first: "第一頁",
                last: "最後一頁",
                next: "下一頁",
                previous: "上一頁"
              },
              aria: {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
              }
            },
            data: dataJson,
            columns: [
              {
                className: 'dt-control',
                orderable: false,
                data: null,
                defaultContent: ''
              },
              { data: 'SupplierName' },
              { data: 'BrandName' },
              { data: 'ProductId' },
              {
                data: 'ProductTypeDesc',
                render: function (data) {
                    if (!data || data.length === 0) return '';
                    return data.map(x =>
                        `<span class="badge text-white me-1" style="background-color:#B57FB3;font-size: 0.9rem;">${x}</span>`
                    ).join('');
                }
              },
              { data: 'ProductCode' },
              { data: 'ProductName' },
              {
                    data: 'IsPublished',
                    render: function (data) {
                        if (data === true) {
                            return '<span class="badge bg-success"><i class="fas fa-check"></i> 上架</span>';
                        }
                        return '<span class="badge bg-secondary"><i class="fas fa-times"></i> 下架</span>';
                    }
                },
              { data: 'CreatorNm' },
              { data: 'FormateCreatedDate' }
            ],
            columnDefs: [
                { targets: "_all", className: "text-center align-middle" } // 全欄置中
            ]
          });
            
            // 點擊展開/收合
            $('#dataTable tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                  row.child.hide();
                  tr.removeClass('shown');
                } else {
                  row.child(format(row.data())).show();
                  tr.addClass('shown');
                }
              });

         // 每次重繪後自動調整高度
        table.on('draw', function () {
            resizeDataTable();
        });

        // 初始化後跑一次
        resizeDataTable();

        // 視窗大小改變時自動調整
        $(window).on('resize', resizeDataTable);
        });
    </script>
}