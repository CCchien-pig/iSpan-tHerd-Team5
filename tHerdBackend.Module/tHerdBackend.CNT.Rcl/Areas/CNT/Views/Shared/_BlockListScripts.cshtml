@* /Areas/CNT/Views/Shared/_BlockListScripts.cshtml *@
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const el = document.getElementById('sortable-blocks');
    if (el) {
        Sortable.create(el, {
            animation: 150,
            handle: '.drag-handle',
            onEnd: async function () {
                const order = [];
                el.querySelectorAll('.col').forEach((col, index) => {
                    const newSeq = index + 1;
                    const orderCol = col.querySelector('.order-col');
                    if (orderCol) orderCol.innerText = newSeq;
                    order.push({ id: col.dataset.id, orderSeq: newSeq });
                });

                try {
                    const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                    const token = tokenInput ? tokenInput.value : '';

                    const resp = await fetch('/CNT/PageBlocks/Reorder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify(order)
                    });

                    if (!resp.ok) throw new Error();
                    const data = await resp.json();

                    if (data.success) {
                        new bootstrap.Toast(document.getElementById('successToast')).show();
                    } else {
                        new bootstrap.Toast(document.getElementById('errorToast')).show();
                    }
                } catch (err) {
                    new bootstrap.Toast(document.getElementById('errorToast')).show();
                }
            }
        });
    }
</script>
